#textdomain wesnoth-tutorial

#define BADGUY TYPE NAME POSITION
    [unit]
        id={NAME}
        generate_name=yes
        type={TYPE}
        x,y={POSITION}
        moves=0
        side=2
        animate=yes
    [/unit]
    [redraw][/redraw]
#enddef

#define DEFEND_ISLAND
    [if]
        {NUMEQ island_defended 0}
        {NUMEQ dumbo_dead 1}
        [then]
            {VARIABLE island_defended 1}
            {LABEL (_"Patch of forest") 10,14}
            {TALK_ABOUT_LOC 10,14 (_"Now put an unwounded unit, preferably a Fighter, in that patch of forest on the south-east of the island; a nice, defensible spot.")}
            {STUDENT (_"Can one unit survive against all those enemies?")}
            {TEACHER (_"With a little help, yes. If you move your Shaman next to the defending unit, she will heal it 4 hitpoints per turn. Just be careful not to expose the Shaman to attack since she is fairly weak herself.")}
            {PRINT (_"Move a unit (a Fighter if possible) to the patch of forest")}
            [event]
                name=moveto
                [filter]
                    x,y=10,14
                [/filter]
                {UNLABEL 10,14}
                {PRINT (_"Advance other units onto the island or to capture villages, then <b>End Turn</b>")}
                [allow_undo][/allow_undo]
            [/event]
        [/then]
    [/if]
#enddef

#define CHECK_INTELLIGENT NAME
    [if]
        [variable]
            # Ignoring single-trait units, as we don't have those during the tutorial
            name={NAME}.modifications.trait.length
            equals=2
        [/variable]
        [then]
            [if]
                [variable]
                    name={NAME}.modifications.trait[0].id
                    equals=intelligent
                [/variable]
                [or]
                    [variable]
                        name={NAME}.modifications.trait[1].id
                        equals=intelligent
                    [/variable]
                [/or]
                [then]
                    {VARIABLE is_intelligent yes}
                [/then]
                [else]
                    {VARIABLE is_intelligent no}
                [/else]
            [/if]
        [/then]
        [else]
            {VARIABLE is_intelligent no}
        [/else]
    [/if]
#enddef

#define IMPORTANT_UNIT NAME
    {CHECK_INTELLIGENT {NAME}}
    [if]
        # Archer needs 44/35(intelligent), Fighter needs 40/32
        [variable]
            name={NAME}.type
            equals=Elvish Archer
        [/variable]
        {BOOLEQ is_intelligent no}
        [variable]
            name={NAME}.experience
            greater_than=35
        [/variable]
        [or]
            [variable]
                name={NAME}.type
                equals=Elvish Archer
            [/variable]
            {BOOLEQ is_intelligent yes}
            [variable]
                name={NAME}.experience
                greater_than=26
            [/variable]
        [/or]
        [or]
            [variable]
                name={NAME}.type
                equals=Elvish Fighter
            [/variable]
            {BOOLEQ is_intelligent no}
            [variable]
                name={NAME}.experience
                greater_than=31
            [/variable]
        [/or]
        [or]
            [variable]
                name={NAME}.type
                equals=Elvish Fighter
            [/variable]
            {BOOLEQ is_intelligent yes}
            [variable]
                name={NAME}.experience
                greater_than=23
            [/variable]
        [/or]
        [then]
            {VARIABLE commented 0}
            {FOREACH galdrad_comments i}
                [if]
                    [variable]
                        name=galdrad_comments[$i].id
                        equals=${NAME}.id
                    [/variable]
                    [then]
                        {VARIABLE commented 1}
                    [/then]
                [/if]
            {NEXT i}
            {CLEAR_VARIABLE i}

            [if]
                {NUMEQ commented 0}
                [then]
                    [store_unit]
                        [filter]
                            id=${NAME}.id
                        [/filter]
                        variable=galdrad_comments
                        mode=append
                    [/store_unit]
                    {TEACHER (_"That unit is about one kill (8 experience points) away from gaining a level! Do not let it die!")}
                [/then]
            [/if]
            {CLEAR_VARIABLE commented}
        [/then]
    [/if]
    {CLEAR_VARIABLE is_intelligent}
#enddef

#define DEFENDER_INJURED NAME
    [if]
        {NUMEQ {NAME}.side 1}
        [variable]
            name={NAME}.hitpoints
            less_than=19
        [/variable]
        [variable]
            name={NAME}.hitpoints
            greater_than=0
        [/variable]
        [then]
            {VARIABLE complained 0}

            # FIXME: If same unit gets attacked twice in same turn, this
            # does not seem to find it the second time. Some internal bug?

            {FOREACH unit_complained i}
                [if]
                    [variable]
                        name=unit_complained[$i].id
                        equals=${NAME}.id
                    [/variable]
                    [then]
                        {VARIABLE complained 1}
                    [/then]
                [/if]
            {NEXT i}

            [if]
                {NUMEQ complained 0}
                [then]
                    [store_unit]
                        [filter]
                            id=${NAME}.id
                        [/filter]
                        variable=unit_complained
                        mode=append
                    [/store_unit]
                    [if]
                        {NUMEQ complain_msg 2}
                        [then]
                            [message]
                                speaker=second_unit
                                message= _"I hope I have a chance to retreat after this!"
                            [/message]
                            {VARIABLE_OP complain_msg add 1}
                        [/then]
                    [/if]

                    [if]
                        {NUMEQ complain_msg 1}
                        [then]
                            [message]
                                speaker=second_unit
                                message= _"One lucky attack by an Orcish Grunt, and I’m done for!"
                            [/message]
                            {VARIABLE_OP complain_msg add 1}
                        [/then]
                    [/if]

                    [if]
                        {NUMEQ complain_msg 0}
                        [then]
                            [message]
                                speaker=second_unit
                                message= _"Ouch! I could make use of some healing in a village."
                            [/message]
                            {VARIABLE_OP complain_msg add 1}
                        [/then]
                    [/if]
                [/then]
            [/if]
            {CLEAR_VARIABLE i}
            {CLEAR_VARIABLE complained}
            {IMPORTANT_UNIT {NAME}}
        [/then]
    [/if]
#enddef

#define CHECK_INCOME
    [if]
        {NUMEQ income_exceeded 0}
        [then]
            [store_side]
            [/store_side]
            [if]
                [variable]
                    name=side.gold
                    greater_than=13
                [/variable]
                [then]
                    {VARIABLE income_exceeded 1}
                    {STUDENT (_"I have $side.gold gold; enough to recruit!")}
                    {TALK_ABOUT_LOC 9,15 (_"Yes, keep recruiting more units: I think you might need them!")}
                [/then]
            [/if]
            {CLEAR_VARIABLE side}
        [/then]
    [/if]
#enddef

[tutorial]
    id=2_Tutorial
    name= _"Wesnoth Tutorial — Part II"
    map_data="{campaigns/tutorial/maps/02_Tutorial_part_2.map}"
    turns=26

    {DEFAULT_SCHEDULE}

    # FIXME
    {DEFAULT_MUSIC_PLAYLIST}

    [side]
        side=1
        controller=human
        gold=123
        canrecruit=yes
        recruit=Elvish Fighter,Elvish Archer,Elvish Shaman
        save_id=human_player
        persistent=yes
        team_name=player
        user_team_name= _ "team_name^Student"

        type=Fighter
        id=student
        name= _"Konrad"
    [/side]

    [side]
        side=2
        controller=ai
        gold=150
        canrecruit=yes
        recruit=Orcish Grunt,Wolf Rider,Orcish Archer
        team_name=orcs
        user_team_name= _ "team_name^Orcs"

        type=Orcish Warrior
        id=Thrag
        name= _"Thrag"

        [unit]
            id=Dumbo
            generate_name=yes
            type=Orcish Grunt
            x,y=8,13
            # Make sure the two archers can't take him out!
            [modifications]
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]

        [ai]
            [aspect]
                id=aggression
                [facet]
                    # When we unleash you, you *will* attack.
                    value=1.0
                    turns=1-6
                [/facet]
            [/aspect]
        [/ai]
    [/side]

    [side]
        side=3
        controller=null
        team_name=player
        no_leader=yes
        hidden=yes

        [unit]
            id=Galdrad
            name= _"Galdrad"
            type=Elvish Captain
            x,y=12,2
        [/unit]
    [/side]

    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                description= _"Defeat the Orc Leader"
                condition=win
            [/objective]
            [objective]
                description= _"Death of Konrad"
                condition=lose
                [show_if]
                    [have_unit]
                        id=student
                        gender=male
                    [/have_unit]
                [/show_if]
            [/objective]
            [objective]
                description= _"Death of Li’sar"
                condition=lose
                [show_if]
                    [have_unit]
                        id=student
                        gender=female
                    [/have_unit]
                [/show_if]
            [/objective]

            {TURNS_RUN_OUT}
        [/objectives]
    [/event]

    [event]
        name=start

        # TODO: determine necessity
        {VARIABLE villages_around_keep 0}
        {VARIABLE village_warn 0}
        {VARIABLE recruit_num 1}
        {VARIABLE income_exceeded 0}

        [message]
            speaker=student
            #wmllint: local spelling Galdrad
            message= _ "Ho, Galdrad! Has Delfador conjured something else to beat me with? A flock of scarecrows, perhaps?"
        [/message]

        {GENDER (
            [message]
                speaker=Galdrad
                message= _ "This is no game, Konrad! Orcs have encamped across the river. This is elven country; they are fools to enter here. We Elves are fast and hard to hit in forests. You must defeat their leader so they never threaten us again. I will advise you."
            [/message]
        ) (
            [message]
                speaker=Galdrad
                message= _ "This is no game, Li’sar! Orcs have encamped across the river. This is elven country; they are fools to enter here. We Elves are fast and hard to hit in forests. You must defeat their leader so they never threaten us again. I will advise you."
            [/message]
        )}

        [message]
            speaker=student
            message= _ "What should I do?"
        [/message]

        {TALK_ABOUT Dumbo (_"First, we will have to deal with the Orcish Grunt stationed in the middle of the river. He should be little trouble.")}
        {TALK_ABOUT Thrag (_"By then, their leader will have recruited more units to send against us and the real fight will begin.")}

        {TALK_ABOUT_LOC 19,14 (_"See this dark blue water? It’s too deep for either side to cross. The orcs could slowly wade through that narrow band of shallow lighter-blue water in the east; but we could stand on the shore and force them to fight us from the water, where they are exposed and we are protected by the forest.")}

        {TALK_ABOUT_LOC 9,14 (_"The more likely attack, then, is across the bridge. That middle island is the key: it has a village for healing injured units and forests in which we fight so well.")}

        [message]
            speaker=student
            message= _ "Let’s go! Attack!"
        [/message]

        [message]
            speaker=Galdrad
            message= _ "Hang on! You need to gather your forces. Or do you intend to fight the orcs singlehandedly?"
        [/message]

        [if]
            # Do we have a recall list at all? It’s possible that the player lost all their units in the first scenario
            [have_unit]
                side=1
                x,y=recall,recall
            [/have_unit]
            [then]
                [message]
                    speaker=Galdrad
                    message= _"I see you have veteran troops from your training! You should <i>recall</i> them as as to start off the battle with more experienced units."
                [/message]

                # It's impossible to have a lvl 3 unit by now, and rare to even have a lvl 2, but let's mention it anyway
                [message]
                    speaker=Galdrad
                    message= _"Some of your units have also managed to level up. They’re even more formidable, so you should recall them first."
                    [show_if]
                        [have_unit]
                            side=1
                            x,y=recall,recall
                            level=2
                        [/have_unit]
                    [/show_if]
                [/message]
            [/then]
            [else]
                # Unlikely in any case
                [message]
                    speaker=Galdrad
                    message= _"Unfortunately, none of your troops survived your training, so you will have to recruit new units. If you had any veteran troops, you could have <i>recalled</i> them to battle this scenario. More experienced units would have been of help against these orcs."
                [/message]
            [/else]
        [/if]

        [message]
            speaker=narrator
            caption= _"Recalling"
            image=wesnoth-icon.png
            message= _"In addition to recruiting new units each scenario, you can also <i>recall</i> your experienced veterans from previous scenarios, for the cost of 20 gold each. This allows you to build up a formidable army over the course of multiple scenarios by recalling your highest leveled troops or those with good combinations of traits and abilities. To recall a unit, right click while your leader stands on a keep and select the <i>Recall</i> option. Remember to also recruit new troops in addition to recalling old ones."
        [/message]

        [message]
            speaker=Galdrad
            message= _"You also have two new types of units to recruit this scenario: Elvish Archers and Elvish Shamans. I’ll tell you more about them when you recruit them."
        [/message]

        {PRINT ( _ "Recruit or recall your troops")}
    [/event]

    # Explaining the Shaman
    [event]
        name=recruit
        [filter]
            side=1
            type=Elvish Shaman
        [/filter]

        [message]
            speaker=Galdrad
            # TODO: image?
            message= _"The Shaman is a fairly weak unit, but she has the ability to <i>heal</i> friendly units around her. She also has a special attack which <i>slows</i> enemies, halving the damage they do for one turn."
        [/message]
    [/event]

    # Explaining the Archer
    [event]
        name=recruit
        [filter]
            side=1
            type=Elvish Archer
        [/filter]

        [message]
            speaker=Galdrad
            # TODO: image?
            message= _"Unlike the Elvish Fighter, which has strong melee attacks, the Elvish Archer has strong ranged attacks. It’s useful to attack enemy units with strong melee attacks  with atrong ranged attacks, and vice versa. This allows your units to take less damage when your enemy counterattacks."
        [/message]
    [/event]

    # Mention upkeep and income
    [event]
        name=recruit,recall
        [filter]
            side=1
        [/filter]
        [filter_condition]
            [have_unit]
                side=1
                race=elf
                count=5
            [/have_unit]
        [/filter_condition]

        {CLEAR_PRINT}

        [message]
            speaker=Galdrad
            message= _ "While none of your recruited units can move yet, you still can. You need more income; there are some villages near the keep you can capture."
        [/message]

        {PRINT ( _ "Capture a village")}
    [/event]

    [event]
        name=capture
        [filter]
            side=1
            # x=7,9,13
            # y=4,2,3
        [/filter]

        {CLEAR_PRINT}

        # NOTE: give live income stats?

        [message]
            speaker=Galdrad
            message= _ "Excellent! As Delfador mentioned earlier, each captured village will support one unit provide you with 1 extra gold per turn."
        [/message]

        [message]
            speaker=narrator
            caption= _ "Income and Upkeep"
            image=wesnoth-icon.png
            message= _ "Each turn, you will gain 2 gold pus one for each village you own. However, <i>upkeep</i> is subtracted for that. You can support as many levels worth of units as the number of villages you own; beyond that, you must pay 1 gold per turn. Be careful, as owning too many units can cause you to have negative income and lose gold per turn!"
        [/message]

        {PRINT (_"End your turn")}
    [/event]

    [event]
        name=turn 2

        {CLEAR_PRINT}

        {GENDER (
            [message]
                speaker=Galdrad
                message= _ "Now, young man, it is time to discuss strategy. Your units are ready to attack, and the orcish leader has begun gathering his own troops."
            [/message]
        ) (
            [message]
                speaker=Galdrad
                message= _ "Now, young lady, it is time to discuss strategy. Your units are ready to attack, and the orcish leader has begun gathering his own troops."
            [/message]
        )}

        [message]
            speaker=student
            message= _ "Galdrad, if I go by the ford, I could sneak up near his keep and dispatch him quickly!"
        [/message]

        [message]
            speaker=Galdrad
            message= _ "You could. However, elves (and orcs) have bad <i>defense</i> in water. You’ll be more vulnerable as you try to wade slowly across the ford; the enemy will have an 80% chance to hit you. Since elves have good defense in the forest, I would advise you keep to the trees and attack the orcs from there; you’ll only have a 30% chance of being hit in return."
        [/message]

        [message]
            speaker=student
            message= _ "Alright. The bridge it is, then!"
        [/message]

        [scroll_to_unit]
            id=Dumbo
        [/scroll_to_unit]

        [message]
            speaker=Galdrad
            scroll=no
            message= _ "An Orcish Grunt appears to be blocking our path. He has no ranged attacks, so your archers should be able to engage him with little risk."
        [/message]

        # TODO: split this section into turn three, or an attack event?
        [message]
            speaker=Galdrad
            message= _ "Your units cannot reach the him this turn, but you should not let them languish! Move them into position so they can attack next turn. There are also other villages on this side of the river. You should secure them for income and healing."
        [/message]

        [message]
            speaker=narrator
            caption= _ "Long-distance Movement"
            image=wesnoth-icon.png
            message= _ "You can order a unit to move for multiple turns by selecting the unit and clicking on the destination. A number will indicate how many turns it will take to get there."
        [/message]

        [message]
            speaker=student
            message= _ "I think I’ll stick around the keep for now, in order to recruit more units."
        [/message]

        {GENDER (
            [message]
                speaker=Galdrad
                message= _ "You’ve learned well, Konrad. It is indeed a good idea to keep your leader safe and protected and in range of your keep early in the game. The tide of battle can turn quickly, and you don’t want to find yourself cut off from recruiting reinforcements."
            [/message]
        ) (
            [message]
                speaker=Galdrad
                message= _ "You’ve learned well, Li’sar. It is indeed a good idea to keep your leader safe and protected and in range of your keep early in the game. The tide of battle can turn quickly, and you don’t want to find yourself cut off from recruiting reinforcements."
            [/message]
        )}
    [/event]

    [event]
        name=turn 3

        # Explain: Zone of Control
        {TALK_ABOUT Dumbo (_"That Grunt is blocking the bridge! We must occupy that island before the Wolf Riders reach it.")}
        {STUDENT (_"Can’t our units just move around him?")}

        # All around Dumbo (9,14)
        [item]
            image=misc/highlight-hex.png
            [filter_adjacent]
                id=Dumbo
            [/filter_adjacent]
        [/item]

        # FIXME: Figure out best unit choice.
        {TALK_ABOUT Dumbo (_"No. Once you move close to an enemy unit, you are in its <i>Zone of Control</i> and cannot move further that turn.
                        To move your troops onto that island without wading slowly through the water, you’ll have to kill the Grunt.")}
        {PRINT (_"Attack the orc with an Archer")}

        [remove_item]
            image=misc/highlight-hex.png
        [/remove_item]

        [event]
            name=attack_end
            [filter_second]
                id=Dumbo
            [/filter_second]

            {CLEAR_PRINT}
            [store_unit]
                variable=dumbo
                kill=no
                [filter]
                    id=Dumbo
                [/filter]
            [/store_unit]
            # This happens before kill event, so we must do this the hard way.
            [if]
                [variable]
                    name=dumbo.hitpoints
                    less_than=1
                [/variable]
                [then]
                    {PRINT (_"Advance other units and capture villages, then <b>End Turn</b>")}
                [/then]
                [else]
                    [if]
                        [variable]
                            name=unit.gender
                            equals=male
                        [/variable]
                        [then]
                            #po: The unit with unit type $unit.language_name is male.
                            {STUDENT (_"No other units can reach that orc. I hope my $unit.language_name survives its counter-attack! I’d better grab more villages and move everyone closer for next turn.")}
                        [/then]
                        [else]
                            #po: The unit with unit type $unit.language_name is female.
                            {STUDENT (_"female^No other units can reach that orc. I hope my $unit.language_name survives its counter-attack! I’d better grab more villages and move everyone closer for next turn.")}
                        [/else]
                    [/if]
                    {TEACHER (_"Yes. If your Shaman stands just behind that unit on the bridge, she will heal it at the beginning of the next turn.")}
                    {PRINT (_"Move your Shaman onto the bridge to stand behind your other unit")}
                    [event]
                        name=moveto
                        [filter]
                            type=Elvish Shaman
                        [/filter]
                        {PRINT (_"Advance other units and capture villages, then <b>End Turn</b>")}
                    [/event]
                [/else]
            [/if]
            {CLEAR_VARIABLE dumbo}
        [/event]
    [/event]

    [event]
        name=die
        [filter]
            id=Dumbo
        [/filter]

        # Only tell them to defend island if not turn 3.
        [if]
            [variable]
                name=turn_number
                greater_than=3
            [/variable]
            [then]
                {DEFEND_ISLAND}
            [/then]
        [/if]

        [event]
            name=moveto
            [filter]
                x=9,9,9
                y=15,16,17
                side=1
            [/filter]

            [allow_undo][/allow_undo]
            [if]
                [variable]
                    name=turn_number
                    less_than=8
                [/variable]
                [then]
                    {TALK_NO_MOVE (_"Be careful: if you stand on the bridge you are exposed to attack from multiple directions!")}
                    {UNDO_REMINDER}
                [/then]
            [/if]
        [/event]

        [event]
            name=moveto
            [filter]
                x=8,10,18,19,20,11
                y=14,15,14,15,14,15
                side=1
            [/filter]
            {TEACHER (_"It’s very dangerous to stand in water when there are enemies about! Your unit will have an 80% chance of being hit! Cancel, and wait for them to attack you!")}
            {UNDO_REMINDER}
            [allow_undo][/allow_undo]
        [/event]
    [/event]

    [event]
        name=turn 4

        {CLEAR_PRINT}
        {TALK_ABOUT_LOC 19,5 (_"Don’t forget about your Fighter in the east; you can move him south to that last village near the channel.")}
        [allow_undo][/allow_undo]
        [if]
            {NUMEQ dumbo_dead 0}
            [then]
                {TALK_ABOUT Dumbo (_"We need to occupy that village, otherwise they will take it next turn! Move a unit into the village to stop the orcs capturing it. Whichever unit you choose will benefit from the village’s healing, too.")}
            [/then]
            [else]
                {DEFEND_ISLAND}
            [/else]
        [/if]
    [/event]

    [event]
        name=turn 5

        {DEFEND_ISLAND}
        {TALK_ABOUT_LOC 11,14 (_"Careful! It is now nighttime. Orcs are <i>chaotic</i>, which means their attacks are now 25% stronger. By day, their attacks are 25% weaker, which is a noticeable difference. You are <i>lawful</i>: stronger by day and weaker at night. Your elvish warriors are <i>neutral</i>: unaffected by the time of day.")}
        {NARRATOR _"Time of Day" _"After this dialog, hold the mouse over the landscape image below the minimap on the right. This brings up a description of the time of day, showing who has the advantage."}
    [/event]

    [event]
        name=turn 6

        {CHECK_INCOME}
        {TALK_ABOUT_LOC 9,15 (_"Remember to retreat your wounded units to villages. Healers can only heal 4 hitpoints at a time, while villages can heal 8 (the maximum healing for any unit).")}
    [/event]

    [event]
        name=turn 7

        {CHECK_INCOME}
        {LABEL (_"Defend here") 19,14}
        {TALK_ABOUT_LOC 19,16 (_"Beware of those orcs crossing the river! If they get into the forest they’ll be hard to dislodge!")}
    [/event]

    [event]
        name=turn 9
        {UNLABEL 19,14}
        {NARRATOR _"Tracking Unused Units" _"You can ensure you use all your troops by pressing <b>n</b> to step from one unit to the next. If you press <b>space</b>, you can mark the currently selected unit as having finished its turn, which stops you moving it by accident later on. When <b>n</b> no longer selects a new unit, it’s safe to end your turn."}
    [/event]

    [event]
        name=turn 10
        {NARRATOR _"Victory Conditions" _"In this scenario, you only need to defeat the orc leader to win. (Victory conditions for a scenario are given under <b>Scenario Objectives</b> in the <b>Main Menu</b>)."}
    [/event]

    [event]
        name=turn 12
        {NARRATOR _"Recruit the Right Unit Types" _"Remember to recruit troops useful for the situation. Archers are particularly effective against Grunts, Wolf Riders and the orcish leader."}
    [/event]

    # Remind them to keep back
    [event]
        name=moveto
        [filter]
            id=student
            x=1-20
            y=6-20
        [/filter]

        [if]
            [variable]
                name=turn_number
                less_than=8
            [/variable]
            [then]
                {TEACHER (_"Stay near the keep! You need to be on a keep to recruit more units, and I doubt the orc leader will let you use his!")}
            [/then]
        [/if]
        [allow_undo][/allow_undo]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Thrag
            x=5,14,19
            y=19,19,23
        [/filter]

        {TALK_ABOUT Thrag (_"Their leader has moved into that village! He’s not as stupid as I thought. The village heals him each turn and provides good defense.")}
    [/event]

    [event]
        name=moveto
        [filter]
            side=2
            x=11,6,11
            y=14,10,10
        [/filter]

        {TALK_ABOUT_LOC ($x1,$y1) (_"That unit has captured our village! You’d better get him out; it heals him each turn and provides good defense.")}
    [/event]

    # Warn about using shaman to attack.
    [event]
        name=attack
        [filter]
            type=Elvish Shaman
        [/filter]

        [message]
            speaker=unit
            message= _ "Using me to attack is risky! I can slow the opponent with my ranged attack, but I hope you have a plan if I miss!"
        [/message]
    [/event]

    [event]
        name=attack_end
        first_time_only=no

        [store_unit]
            variable=attacker
            [filter]
                x,y=$x1,$y1
            [/filter]
        [/store_unit]
        [store_unit]
            variable=defender
            [filter]
                x,y=$x2,$y2
            [/filter]
        [/store_unit]

        {DEFENDER_INJURED defender}
        {IMPORTANT_UNIT attacker}

        [if]
            [variable]
                name=attacker.id
                equals=Thrag
            [/variable]
            [variable]
                name=attacker.hitpoints
                less_than=21
            [/variable]
            {NUMEQ talk_about_killing_thrag 0}
            [then]
                {VARIABLE talk_about_killing_thrag 1}
                {TALK_ABOUT Thrag (_"You are close to killing their leader! The unit who finishes him will gain 16 experience points because he is second level. Choose your attacking unit carefully!")}
            [/then]
        [/if]

        [if]
            [variable]
                name=defender.id
                equals=Thrag
            [/variable]
            [variable]
                name=defender.hitpoints
                less_than=21
            [/variable]
            {NUMEQ talk_about_killing_thrag 0}
            [then]
                {VARIABLE talk_about_killing_thrag 1}
                {TALK_ABOUT Thrag (_"You are close to killing their leader! The unit who finishes him will gain 16 experience points because he is second level. Choose your attacking unit carefully!")}
            [/then]
        [/if]
        {CLEAR_VARIABLE attacker}
        {CLEAR_VARIABLE defender}
    [/event]

    [event]
        name=die
        first_time_only=no
        [filter]
            side=1
            [not]
                id=student
            [/not]
        [/filter]

        [store_unit]
            variable=deadguy
            [filter]
                x,y=$x1,$y1
            [/filter]
        [/store_unit]

        [if]
            [variable]
                name=deadguy.type
                equals=Elvish Fighter
            [/variable]
            [or]
                [variable]
                    name=deadguy.type
                    equals=Elvish Archer
                [/variable]
            [/or]
            [then]
                [if]
                    [variable]
                        name=deadguy.experience
                        greater_than=20
                    [/variable]
                    [then]
                        [if]
                            [variable]
                                name=deadguy.gender
                                equals=male
                            [/variable]
                            [then]
                                {TEACHER (_"We will miss $deadguy.name| because he had $deadguy.experience experience points. He would have advanced to second level soon.")}
                            [/then]
                            [else]
                                {TEACHER (_"We will miss $deadguy.name| because she had $deadguy.experience experience points. She would have advanced to second level soon.")}
                            [/else]
                        [/if]
                    [/then]
                    [else]
                        [if]
                            [variable]
                                name=deadguy.experience
                                less_than=8
                            [/variable]
                            [then]
                                [if]
                                    [variable]
                                        name=deadguy.gender
                                        equals=male
                                    [/variable]
                                    [then]
                                        {TEACHER (_"We will miss $deadguy.name|, but at least he was not one of our experienced troops!")}
                                    [/then]
                                    [else]
                                        {TEACHER (_"We will miss $deadguy.name|, but at least she was not one of our experienced troops!")}
                                    [/else]
                                [/if]
                            [/then]
                        [/if]
                    [/else]
                [/if]
            [/then]
            [else]
                [if]
                    [variable]
                        name=deadguy.type
                        equals=Elvish Shaman
                    [/variable]
                    [then]
                        {TEACHER (_"Losing a healer hurts all the troops! Keep them out of the enemy’s reach!")}
                        {NARRATOR _"Tracking Enemy Movement" _"You can see where an enemy can reach by moving the mouse over them. You can see all possible enemy moves at once with the <b>Show Enemy Moves</b> command from the <b>Actions</b> menu."}
                    [/then]
                    [else]
                        # Must be level 2 unit.
                        {TEACHER (_"Second level units are powerful, but not invulnerable! Goodbye, $deadguy.name|.")}
                    [/else]
                [/if]
            [/else]
        [/if]
        {CLEAR_VARIABLE deadguy}
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x=1-13
            y=18-21
        [/filter]

        {TALK_ABOUT Thrag (_"Beware of the orc leader: he can do 36 hitpoints of damage at night! Attack with many units at once during the day.")}
    [/event]

    # TODO: Shaman?

    [event]
        name=post_advance
        [filter]
            side=1
            type=Elvish Marksman
        [/filter]

        # FIXME: Abilities
        [message]
            speaker=unit
            message= _"Advancing a level has fully healed me! I always have a 60% chance of hitting with my <i>Marksman</i> ability, and I deal 9 damage each for 4 attacks. Use me to dislodge hard-to-hit units."
        [/message]
    [/event]

    [event]
        name=post_advance
        [filter]
            side=1
            type=Elvish Ranger
        [/filter]

        [message]
            speaker=unit
            message= _"Advancing a level has fully healed me! I am good with both bow and sword, and I have a special ability: <i>Ambush</i>. I can hide in forests where enemies can only see me if they are right next to me."
        [/message]
    [/event]

    [event]
        name=post_advance
        [filter]
            side=1
            type=Elvish Captain
        [/filter]

        [message]
            speaker=unit
            message= _"Advancing a level has fully healed me! I am good with both bow and sword, and I have a special ability: <i>Leadership</i>. First level units around me do 25% more damage, so position me carefully."
        [/message]
    [/event]

    [event]
        name=post_advance
        [filter]
            side=1
            type=Elvish Hero
        [/filter]

        # FIXME: Abilities
        [message]
            speaker=unit
            message= _"Advancing a level has fully healed me! I am particularly good with the sword, dealing 8 damage in 4 attacks."
        [/message]
    [/event]

    [event]
        name=time over

        [message]
            speaker=Galdrad
            message= _ "You took too long! We’ll never be rid of these orcs!"
        [/message]

        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=die
        [filter]
            id=student
        [/filter]

        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=defeat

        {CLEAR_PRINT}
    [/event]

    [event]
        name=victory

        [message]
            speaker=Galdrad
            message= _ "You have beaten the orcs! You may want to try some novice-level campaigns next, such as: <i>The South Guard</i>, <i>An Orcish Incursion</i>, <i>A Tale of Two Brothers</i>, or <i>Heir to the Throne</i>. <i>The South Guard</i> was specifically designed as a beginner’s campaign. Konrad, Li’sar and Delfador are characters from <i>Heir to the Throne</i>."
        [/message]
    [/event]
[/tutorial]
