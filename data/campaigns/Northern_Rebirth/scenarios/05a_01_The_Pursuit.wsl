--textdomain wesnoth-nr

Scenario{
    id: "05a_01_The_Pursuit"
    name: _ "The Pursuit"
    map: "campaigns/Northern_Rebirth/maps/05a_01_The_Pursuit.map"
    turns: -1
    next_scenario: "05a_02_Dealings"
    victory_when_enemies_defeated: false

    <UNDERGROUND!

    <SCENARIO_MUSIC("underground.ogg")
    <EXTRA_SCENARIO_MUSIC("the_deep_path.ogg")
    <EXTRA_SCENARIO_MUSIC("vengeful.ogg")
    <EXTRA_SCENARIO_MUSIC("suspense.ogg")

    story: {
        part: {
            story: _ "Leaving most of the dwarves behind, Tallin and his party set off in pursuit of Malifor."
        }
    }

-- Players side
-- wmllint: validate-off
    side: {
        side: 1
        controller: "human"
        recruit: {"Peasant", "Woodsman", "Thug", "Poacher", "Footpad"}
        <GOLD(600, 400, 300)
        team_name: "rebels"
        user_team_name: _ "Alliance"

-- wmllint: recognize Tallin
        <CHARACTER_STATS_TALLIN!

        shroud: true
    }
-- wmllint: validate-on

-- Main enemy
    side: {
        side: 2
        controller: "ai"
        recruit: {"Deathblade", "Revenant", "Bone Shooter", "Necromancer"}
        gold: 0
        team_name: "undead"
        user_team_name: _ "Undead"
        <FLAG_VARIANT("undead")

        type: "Ancient Lich"
        id: "Malifor"
        name: _ "Malifor"
        profile: "portraits/Malifor.png"
        canrecruit: true

        facing: "sw"

-- These two have a role for 'sighted' events

        <NOTRAIT_UNIT({}, "Draug", 26, 13)
        unit: {
            amend: true
            role: "Study Guard"
            ai_special: "guardian"
        }

-- Draug guards
        <NOTRAIT_UNIT({}, "Draug", 20, 10), <GUARDIAN!
        <NOTRAIT_UNIT({}, "Draug", 20, 12), <GUARDIAN!
        <NOTRAIT_UNIT({}, "Draug", 24, 14), <GUARDIAN!

        <NOTRAIT_UNIT({}, "Draug", 23, 6), <GUARDIAN!
        <NOTRAIT_UNIT({}, "Draug", 24, 3), <GUARDIAN!
        <NOTRAIT_UNIT({}, "Draug", 29, 3), <GUARDIAN!
        <NOTRAIT_UNIT({}, "Draug", 30, 9), <GUARDIAN!
        <NOTRAIT_UNIT({}, "Draug", 35, 8), <GUARDIAN!

-- Revenants guards
        <NOTRAIT_UNIT({}, "Revenant", 19, 21), <GUARDIAN!
        <NOTRAIT_UNIT({}, "Revenant", 19, 26), <GUARDIAN!
        <NOTRAIT_UNIT({}, "Revenant", 21, 21), <GUARDIAN!
        <NOTRAIT_UNIT({}, "Revenant", 21, 26), <GUARDIAN!
        <NOTRAIT_UNIT({}, "Revenant", 21, 35), <GUARDIAN!
        <NOTRAIT_UNIT({}, "Revenant", 19, 35), <GUARDIAN!
        unit: {
            amend: true
-- Speaks during the starting event
            role: "starting_speaker"
        }
    }

    MALIFORS_GUARD_RECRUITS: () -> {
        <ON_DIFFICULTY!
err: ../attic/data/campaigns/Northern_Rebirth/scenarios/05a_01_The_Pursuit.cfg - ./wml_to_wsl/parse.moon:224: Error parsing (wml) line 93:     (recruit=Skeleton,Skeleton Archer,Revenant)
err: ../attic/data/campaigns/Northern_Rebirth/scenarios/05a_01_The_Pursuit.cfg - ./wml_to_wsl/parse.moon:224: Error parsing (wml) line 94:     (recruit=Skeleton,Skeleton Archer,Revenant,Bone Shooter)
err: ../attic/data/campaigns/Northern_Rebirth/scenarios/05a_01_The_Pursuit.cfg - ./wml_to_wsl/parse.moon:224: Error parsing (wml) line 95:     (recruit=Skeleton,Skeleton Archer,Revenant,Bone Shooter,Deathblade)}
err: ../attic/data/campaigns/Northern_Rebirth/scenarios/05a_01_The_Pursuit.cfg - ./wml_to_wsl/compile.moon:28: Unbalanced WML! macro: ON_DIFFICULTY closed by define at line 93

-- Enemies to the immediate left and right of the first chamber
            side: {
                side: 3
                controller: "ai"

                <MALIFORS_GUARD_RECRUITS!

                gold: 0
-- {GOLD 100 150 250}
                <INCOME(10, 16, 22)
                team_name: "undead"
                user_team_name: _ "Undead"
                <FLAG_VARIANT("undead")

                type: "Death Knight"
                id: "Hettel"
                name: _ "Hettel"
                canrecruit: true

                <NOTRAIT_UNIT({}, "Revenant", 33, 31), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 35, 29), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 36, 33), <GUARDIAN!
            }

-- Dungeon guard
            side: {
                side: 4
                controller: "ai"

                <MALIFORS_GUARD_RECRUITS!

                gold: 0
                team_name: "undead"
                user_team_name: _ "Undead"
                <FLAG_VARIANT("undead")

                type: "Death Knight"
                id: "Tervor"
                name: _ "Tervor"
                canrecruit: true

                <NOTRAIT_UNIT({}, "Revenant", 3, 32), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 4, 39), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 9, 36), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 10, 39), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 13, 37), <GUARDIAN!
            }

-- Treasury guards
            side: {
                side: 5
                controller: "ai"

                <MALIFORS_GUARD_RECRUITS!

                gold: 0
                team_name: "undead"
                user_team_name: _ "Undead"
                <FLAG_VARIANT("undead")

                type: "Death Knight"
                id: "Author"
                name: _ "Author"
                canrecruit: true

                <NOTRAIT_UNIT({}, "Draug", 15, 23), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Draug", 11, 23)
                unit: {
                    amend: true
                    role: "Treasury Guard"
                    ai_special: "guardian"
                }

                <NOTRAIT_UNIT({}, "Revenant", 5, 19), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 6, 20), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 7, 16), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 6, 22), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 9, 15), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 9, 21), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 15, 20), <GUARDIAN!
            }

-- Study Guards
            side: {
                side: 6
                controller: "ai"

                <MALIFORS_GUARD_RECRUITS!

                gold: 0
                team_name: "undead"
                user_team_name: _ "Undead"
                <FLAG_VARIANT("undead")

                type: "Death Knight"
                id: "Boblin"
                name: _ "Boblin"
                canrecruit: true

                <NOTRAIT_UNIT({}, "Revenant", 26, 21), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 28, 21), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 31, 16), <GUARDIAN!
            }

            side: {
                side: 7
                controller: "ai"

                <MALIFORS_GUARD_RECRUITS!

                gold: 0
                team_name: "undead"
                user_team_name: _ "Undead"
                <FLAG_VARIANT("undead")

                type: "Death Knight"
                id: "Antrasis"
                name: _ "Antrasis"
                canrecruit: true

                <NOTRAIT_UNIT({}, "Revenant", 7, 7), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 10, 8), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 14, 10), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 19, 16), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 22, 18), <GUARDIAN!
                <NOTRAIT_UNIT({}, "Revenant", 21, 17), <GUARDIAN!
            }

-- Whole lot of doors
            <PLACE_IMAGE("scenery/dwarven-doors-closed.png", 22, 4)
            <PLACE_IMAGE("scenery/dwarven-doors-closed.png", 33, 9)
            <PLACE_IMAGE("scenery/dwarven-doors-closed.png", 19, 3)
            <PLACE_IMAGE("scenery/dwarven-doors-closed.png", 19, 4)
            <PLACE_IMAGE("scenery/dwarven-doors-closed.png", 9, 3)
            <PLACE_IMAGE("scenery/dwarven-doors-closed.png", 9, 4)
            <PLACE_IMAGE("scenery/dwarven-doors-closed.png", 34, 28)

-- Gates to Malifor's study
            <PLACE_IMAGE("scenery/gate-rusty-sw.png", 23, 9)
            <PLACE_IMAGE("scenery/gate-rusty-sw.png", 24, 9)
            <PLACE_IMAGE("scenery/gate-rusty-sw.png", 25, 10)

-- Prisoners
            <PLACE_PRISONER_IMAGE("units/human-magi/white-mage.png", 8, 32)
            <PLACE_PRISONER_IMAGE("units/human-magi/white-mage+female.png", 5, 29)
            <PLACE_PRISONER_IMAGE("units/elves-wood/druid.png", 3, 40)
            <PLACE_PRISONER_IMAGE("units/drakes/burner.png", 9, 39)

-- Corpses in the water.
            <PLACE_IMAGE("floor-corpse.png", 40, 22)
            <PLACE_IMAGE("floor-corpse.png", 35, 15)
            <PLACE_IMAGE("floor-corpse.png", 36, 20)
            <PLACE_IMAGE("floor-corpse.png", 35, 3)

-- Signposts
            <PLACE_IMAGE("scenery/signpost.png", 15, 33)
            <PLACE_IMAGE("scenery/signpost.png", 25, 33)
            <PLACE_IMAGE("scenery/signpost.png", 25, 28)
            <PLACE_IMAGE("scenery/signpost.png", 20, 25)
            <PLACE_IMAGE("scenery/signpost.png", 15, 28)
            <PLACE_IMAGE("scenery/signpost.png", 35, 27)

-- Treasury chests
            <PLACE_IMAGE("items/chest.png~FL(horiz)", 6, 22)
            <PLACE_IMAGE("items/chest.png~FL(horiz)", 9, 21)
            <PLACE_IMAGE("items/chest.png~FL(horiz)", 5, 19)
            <PLACE_IMAGE("items/chest.png", 6, 20)
            <PLACE_IMAGE("items/chest.png", 7, 16)
            <PLACE_IMAGE("items/chest.png", 9, 15) -- Rod of Justice here

            <PLACE_IMAGE("items/bonestack.png", 30, 4)
            <PLACE_IMAGE("items/bonestack.png", 34, 6)

-- Place holy water - uses core macro to set up required pickup event as well
            <OBJ_POTION_HOLY(34, 26, "object7_holywater")
            <OBJ_POTION_HOLY(33, 27, "object7_holywater2")
            <OBJ_POTION_HOLY(33, 28, "object7_holywater3")
            <OBJ_POTION_HOLY(32, 26, "object7_holywater4")
            <OBJ_POTION_HOLY(32, 27, "object7_holywater5")

            event: {
                name: "prestart"

-- Set up some variables that need an initial value
                do: ->
                    VARIABLE("back_door_opened", false)
                    VARIABLE("main_door_opened", false)
                    VARIABLE("spider_door_opened", false)
                    VARIABLE("got_rod_of_justice", false)

                    Hide_Unit{
                        id: "Tallin"
                    }

                    Store_Unit{
                        filter: {
                            id: "Tallin"
                        }
                        variable: "tallin_store"
                    }

                    Lock_View{}
            }

            event: {
                name: "start"

-- Malifor escapes into shroud
                do: ->
                    Move_Unit_Fake{
                        type: "Ancient Lich"
                        side: 2
                        x: {20, 20}
                        y: {39, 33}
                    }

                    Delay{
                        time: 1000
                    }

                    Move_Unit_Fake{
                        type: tallin_store.type
                        side: 1
                        x: {20, tallin_store.x}
                        y: {40, tallin_store.y}
                    }

                    Unhide_Unit{
                        id: "Tallin"
                    }

                    CLEAR_VARIABLE("tallin_store")

-- Recall some units
                    RECALL_SUPPORTER!

                    Recall{
                        race: "dwarf"
                    }

                    Recall{
                        id: "Camerin"
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "There he goes! Quick, get him!"
                    }

                    Message{
                        role: "starting_speaker"
                        message: _ "I don’t think so, you living vermin."
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "We’ll have to kill these revenants to get after him. There are only two of them, so they shouldn’t last long."
                    }

                    Unlock_View{}

                    Objectives{
                        side: 1
                        objective: {
                            description: _ "Get past the Revenants."
                            condition: "win"
                        }
                        objective: {
                            description: _ "Death of Tallin"
                            condition: "lose"
                        }

                        gold_carryover: {
                            bonus: false
                            carryover_percentage: 40
                        }
                    }
            }

-- Player enters the first chamber - more initial dialog and objectives
            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: "19-21"
                    y: "29-31"
                }
                do: ->
                    Message{
                        speaker: "unit"
                        message: _ "Uh... Which way?"
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Blast it! We lost him."
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "It makes no difference in the end, because we will hunt him down and crush him to powder. HEAR THAT, YOU OLD SKELETON?"
                    }

                    Message{
                        speaker: "Malifor"
                        message: _ "(<i>Faint cackle of laughter in the distance</i>)"
                    }

                    Message{
                        speaker: "Camerin"
                        message: _ "Yeah! This is gonna be fun!"
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Let us proceed with caution. Nobody is to go off by himself. We don’t know what could be lurking in these tunnels."
                    }

                    Objectives{
                        side: 1
                        objective: {
                            description: _ "Find Malifor and destroy him"
                            condition: "win"
                        }
                        objective: {
                            description: _ "Death of Tallin"
                            condition: "lose"
                        }

                        gold_carryover: {
                            bonus: false
                            carryover_percentage: 40
                        }

                        note: {
                            description: _ "Be sure to explore"
                        }
                    }
            }

-- From this point on we can go in five directions. Three of five
-- paths lead to an entrance to the end goal - Malifor's study.
-- Going clockwise, we have:

-- ================================================================
-- 1: PRISON MODULE
--
-- Room with four support units you can free, two of which are
-- necessary for ending the scenario.
-- ================================================================

-- Signpost and alarm
            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: 15, y: 33
                }
                do: ->
                    Message{
                        speaker: "narrator"
                        image: "scenery/signpost.png"
                        message: _ "The Dungeon"
                    }

                    Message{
                        speaker: "unit"
                        message: _ "Those poor wretches!"
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "We won’t leave them in Malifor’s chains!"
                    }

                    Allow_Undo{}
            }

-- Raise alarm in the prison section, this gives enemies there more
-- gold on top of the one they had initially.
            event: {
                name: "sighted"
                filter: {
                    side: 4
                }
                filter_second: {
                    side: 1
                }
                do: ->
                    Message{
                        speaker: "unit"
                        message: _ "Intruders! Stop them before they free the prisoners!"
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Good luck, my friend."
                    }

                    Gold{
                        side: 4
                        amount: ON_DIFFICULTY(200, 350, 500)
                    }
            }

-- Father Morvin
            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: 8, y: 32
                }

-- Remove the caged white mage image from hex
                do: ->
                    Remove_Item{
                        x: x1, y: y1
                    }

-- Spawn unit
                    Unit{
                        side: 1
                        x: 9, y: 32

-- wmllint: recognize Father Morvin
                        <CHARACTER_STATS_FATHER_MORVIN!
                    }

                    Message{
                        speaker: "Father Morvin"
                        message: _ "Finally! I am free. Lord Tallin, I am forever in your debt! We will follow you to the end of the world if need be."
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "It’s just ‘Tallin’, no ‘Lord’. And no problem."
                    }

-- If he was freed after sister Thera, there is no need to repeat the exposition
                    If{
                        have_unit: {
-- wmllint: recognize Sister Thera
                            id: "Sister Thera"
                        }
                        then: ->
                            Message{
                                speaker: "Sister Thera"
                                message: _ "Morvin!"
                            }

                            Message{
                                speaker: "Father Morvin"
                                message: _ "Thera!"
                            }

                            If{
                                variable: {
                                    name: "unit.id"
                                    equals: "Sister Thera"
                                }
                                then: ->
                                    Message{
                                        speaker: "Tallin"
                                        message: _ "Please, folks, not now."
                                    }
                                
                                else: ->
                                    Message{
                                        speaker: "unit"
                                        message: _ "Please, folks, not now."
                                    }
                                
                            }

                            Message{
                                speaker: "Sister Thera"
                                message: _ "Oh, sorry."
                            }
                        
-- Else explain how they ended up down here and why are they still alive
                        else: ->
                            Message{
                                speaker: "Tallin"
                                message: _ "Who are you? How did you end up down here?"
                            }

                            Message{
                                speaker: "Father Morvin"
                                message: _ "My name is Morvin. My wife, Thera and I were advisers and healers for the dwarvish nobles. We could not shield them from the wrath of Khazg Black-Tusk, but we survived the orcs and trolls — only to be captured by these skeletons."
                            }

                            Message{
                                speaker: "Tallin"
                                message: _ "Funny, why would the bonebag keep you as his prisoners? He doesn’t really seem to be the merciful type."
                            }

                            Message{
                                speaker: "Father Morvin"
                                message: _ "He didn’t keep us alive out of mercy, he wanted to study us to see if there was a way to counteract our arcane attacks. His kind are very vulnerable to such attacks."
                            }

                            Message{
                                speaker: "Tallin"
                                message: _ "Indeed, that is good to know. But you are now free to go wherever you like. May the Lords of Light guide your path."
                            }

                            Message{
                                speaker: "Father Morvin"
                                message: _ "As I have said, Tallin, I am eternally in your debt, and I take my debts seriously. If you have no objection, I will serve you until one of us departs this life."
                            }

                            Message{
                                speaker: "Tallin"
                                message: _ "Oh, think nothing of it. Let no talk of debts come between us; rather let us join hands as allies in restoring these Northlands to sanity."
                            }

                            Message{
                                speaker: "Father Morvin"
                                message: _ "Thank you, Tallin."
                            }
                        
                    }

-- Set up a flavor death event for the pair since they can't die in combat (see utils/herodeaths.cfg)
                    Event{
                        name: "die"
                        filter: {
                            id: "Father Morvin"
                        }
                        do: ->
                            Message{
                                speaker: "Tallin"
                                message: _ "Wow! That’s incredible. Now I understand why the bag of bones kept you guys in jail; he just simply couldn’t kill you!"
                            }

                            Message{
                                speaker: "Sister Thera"
                                message: _ "(<i>Giggle</i>)"
                            }
                    }
            }

-- Sister Thera
-- Prison escape route here
            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: 5, y: 29
                }
                do: ->
                    Remove_Item{
                        x: x1, y: y1
                    }

                    Unit{
                        side: 1
                        x: 6, y: 29

-- wmllint: recognize Sister Thera
                        <CHARACTER_STATS_SISTER_THERA!
                    }

                    Message{
                        speaker: "Sister Thera"
                        message: _ "Freedom at last! Thank you, Lord Tallin."
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Just ‘Tallin’. I am no Lord, just a humble peasant trying to restore our people to freedom."
                    }

                    If{
                        have_unit: {
                            id: "Father Morvin"
                        }
                        then: ->
                            Message{
                                speaker: "Sister Thera"
                                message: _ "Morvin!"
                            }

                            Message{
                                speaker: "Father Morvin"
                                message: _ "Thera!"
                            }
                            If{
                                variable: {
                                    name: "unit.id"
                                    equals: "Father Morvin"
                                }
                                then: ->
                                    Message{
                                        speaker: "Tallin"
                                        message: _ "Please, folks, not now."
                                    }
                                
                                else: ->
                                    Message{
                                        speaker: "unit"
                                        message: _ "Please, folks, not now."
                                    }
                                
                            }
                            Message{
                                speaker: "Sister Thera"
                                message: _ "Oh, sorry."
                            }
                        
                        else: ->
                            Message{
                                speaker: "Tallin"
                                message: _ "Who are you? How did you end up down here?"
                            }

                            Message{
                                speaker: "Sister Thera"
                                message: _ "My name is Thera. My husband Morvin and I were advisers and healers for the dwarvish nobles of Knalga. We could not save them from Khazg Black-Tusk’s troops, but we survived the orcs and trolls only to be captured when these skeletons appeared."
                            }

                            Message{
                                speaker: "Tallin"
                                message: _ "Funny, why would the bonebag keep you as his prisoners? He didn’t seem to be the merciful type."
                            }

                            Message{
                                speaker: "Sister Thera"
                                message: _ "He didn’t keep us alive out of mercy, he wanted to study us to see if there was a way to counteract our arcane attacks. His kind are very vulnerable to such attacks, as I am sure you know by now."
                            }

                            Message{
                                speaker: "Tallin"
                                message: _ "Indeed, that is good to know. But you are now free to go wherever you like. May the Lords of Light guide your path."
                            }

                            Message{
                                speaker: "Sister Thera"
                                message: _ "If you have no objection, Tallin, we would like to join you. These northlands are hardly safe these days for anyone to be traveling on their own, and we could lend valuable help to your cause."
                            }

                            Message{
                                speaker: "Tallin"
                                message: _ "Very well, you are most welcome to join us."
                            }

                            Message{
                                speaker: "Sister Thera"
                                message: _ "Thank you, Tallin."
                            }
                        
                    }

                    Delay{
                        time: 1000
                    }

                    MODIFY_UNIT({id: unit.id}, "facing", "nw")

                    Message{
                        speaker: "unit"
                        message: _ "Look at this. There’s some sort of opening in the wall..."
                    }

                    Message{
                        speaker: "Sister Thera"
                        message: _ "It was there when I was thrown down here. The hole wasn’t big enough for me to go through, but perhaps one of you might enlarge it?"
                    }

                    Message{
                        speaker: "unit"
                        message: _ "Hmmm, let’s see..."
                    }

                    Animate_Unit{
                        filter: {
                            id: unit.id
                        }

                        flag: "attack"
                        hits: true
                        with_bars: false
                    }

                    Sound{
                        name: "cave-in.ogg"
                    }

                    Terrain{
                        x: 4, y: 28
                        terrain: "Uu"
                    }

                    Redraw{
                        side: 1
                    }

                    Delay{
                        time: 500
                    }

                    Message{
                        speaker: "unit"
                        message: _ "There we go. Now let’s see where this tunnel leads."
                    }
            }

-- Elenia
            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: 3, y: 40
                }
                do: ->
                    Remove_Item{
                        x: x1, y: y1
                    }

                    Unit{
                        side: 1
                        x: 4, y: 39
                        hitpoints: 1

-- wmllint: recognize Elenia
                        <CHARACTER_STATS_ELENIA!
                    }

                    Delay{
                        time: 500
                    }

                    Message{
                        speaker: "unit"
                        message: _ "She’s not in good shape..."
                    }

-- Depending whether or not Thera has been, freed dialog
-- describes Elenia healing herself or being healed.
                    If{
                        have_unit: {
                            id: "Sister Thera"
                        }
                        then: ->
                            Message{
                                speaker: "Sister Thera"
                                message: _ "Here, let me see her."
                            }

                            FLASH_WHITE({
                                    teleport: {
                                        filter: {
                                            id: "Sister Thera"
                                        }
                                        x: 5, y: 39
                                    }
                            })

                            Message{
                                speaker: "Sister Thera"
                                message: _ "This should help."
                            }

                            Heal_Unit{
                                filter: {
                                    id: "Elenia"
                                }
                                filter_second: {
                                    id: "Sister Thera"
                                }

                                amount: 16
                                animate: true
                            }

                            Sound{
                                name: "heal.wav"
                            }

                            Message{
                                speaker: "Elenia"
                                message: _ "Uh... where... am... I...?"
                            }

                            Message{
                                speaker: "Sister Thera"
                                message: _ "You are in the dungeons of Malifor. These brave people have just released you."
                            }

                            Message{
                                speaker: "Elenia"
                                message: _ "... Thanks."
                            }

                            Message{
                                speaker: "Tallin"
                                message: _ "No problem. Sister Thera, you take care of her. If she wants to join us she would make a powerful ally."
                            }

                            Message{
                                speaker: "Elenia"
                                message: _ "Yes, I would... like to join... you Lord Tallin."
                            }

                            Message{
                                speaker: "Tallin"
                                message: _ "Just Tallin; I am no lord. But gee, that sure is some powerful spell you used on her, Thera. She’s looking better already."
                            }

                            Message{
                                speaker: "Elenia"
                                message: _ "And I feel better too. Now let’s get back at that disgusting skeleton."
                            }
                        
                        else: ->
                            Message{
                                speaker: "unit"
                                message: _ "I wish we had some healers with us; I’ll try to help her as best I can."
                            }

                            Delay{
                                time: 1000
                            }

                            Message{
                                speaker: "Elenia"
                                message: _ "Uh... where... am... I...?"
                            }

                            Message{
                                speaker: "unit"
                                message: _ "You are in the dungeons of Malifor. We have just released you."
                            }

                            Message{
                                speaker: "Elenia"
                                message: _ "... Thanks."
                            }

                            Message{
                                speaker: "Tallin"
                                message: _ "No problem. Just take it easy. If you would like to join us your help could mean life or death for a lot of us."
                            }

                            Message{
                                speaker: "Elenia"
                                message: _ "Yes, I would... like to join... you Lord Tallin."
                            }

                            Message{
                                speaker: "Tallin"
                                message: _ "Just Tallin, I am no lord. And you are looking better already."
                            }

                            Heal_Unit{
                                filter: {
                                    id: "Elenia"
                                }
-- We do this so she gets animated healing herself
                                filter_second: {
                                    id: "Elenia"
                                }

                                animate: true
                                amount: 16
                            }

                            Sound{
                                name: "heal.wav"
                            }

                            Message{
                                speaker: "Elenia"
                                message: _ "Oh, just a few tricks I know, otherwise I probably would be dead by now. But let’s get back at that disgusting skeleton."
                            }
                        
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Why did the bag of bones capture you in the first place?"
                    }

                    Message{
                        speaker: "Elenia"
                        message: _ "Because he thought I was pretty."
                    }

                    Message{
                        speaker: "Tallin"
-- wmllint: local spelling Geez nutcase
                        message: _ "That old skeleton? Geez, what a nutcase."
                    }

                    Message{
                        speaker: "Elenia"
                        message: _ "You’re telling me."
                    }
            }

-- Krash
            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: 9, y: 39
                }
                do: ->
                    Remove_Item{
                        x: x1, y: y1
                    }

                    Unit{
                        side: 1
                        x: 8, y: 38

-- wmllint: recognize Krash
                        <CHARACTER_STATS_KRASH!
                    }

-- I'm not checking for existence of Camerin since the
-- dialog still looks decent without his lines.
                    Message{
                        speaker: "unit"
                        message: _ "Holy cow! What did I just let out of that cage! Look out everyone."
                    }

                    Message{
                        speaker: "Camerin"
                        message: _ "Oooooh, cool, it’s a drake!"
                    }

                    Message{
                        speaker: "Krash"
                        message: _ "(<i>Whimper</i>)"
                    }

                    Message{
                        speaker: "unit"
                        message: _ "Bright Gods, such a fierce creature whimpering! What the heck have they done to it?"
                    }

                    Message{
                        speaker: "Camerin"
                        message: _ "The bastards!"
                    }

-- On the other hand, the following two look awkward without Morvin in play.
                    If{
                        have_unit: {
                            id: "Father Morvin"
                        }
                        then: ->
                            Message{
                                speaker: "Father Morvin"
                                message: _ "Probably another one of Malifor’s experiments."
                            }

                            Message{
                                speaker: "Tallin"
                                message: _ "I don’t know, see if it talks."
                            }
                        
                    }

                    Message{
                        speaker: "unit"
                        message: _ "Hey, big guy. We aren’t gonna hurt you. We wanna be your friends."
                    }

                    Message{
                        speaker: "Krash"
                        message: _ "... Not... going... to... hurt... me?"
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Hey, it talks!"
                    }

                    Message{
                        speaker: "Camerin"
                        message: _ "It’s a ‘he’, and yes, they’re actually very intelligent creatures."
                    }

                    Message{
                        speaker: "unit"
                        message: _ "Hush! I am trying to talk to him. Nope, we’ll never hurt you. But if you want to you can hurt some skeletons."
                    }

                    Message{
                        speaker: "Krash"
                        message: _ "Skeletons! GRRRR!!" -- wmllint: no spellcheck
                    }

                    Message{
                        speaker: "unit"
                        message: _ "Look out! He is ready to go! Hey, is that smoke coming out of his ears?"
                    }

-- Set up a flavor attack event for Krash, placed as a
-- subevent since there is no need to have it in memory before
-- he's found
                    Event{
                        name: "attack"
                        filter: {
                            id: "Krash"
                        }
                        do: ->
                            Message{
                                speaker: "Krash"
                                message: _ "ROOOAARR!" -- wmllint: no spellcheck
                            }

                            Message{
                                role: "Supporter"
                                message: _ "Whoa! Maybe he isn’t so friendly after all... or at least to some things."
                            }
                    }
            }

-- Escape tunnel
            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: "2-4"
                    y: "17-21"
                }
                do: ->
                    Message{
                        speaker: "unit"
                        message: _ "(<i>Sigh</i>) There doesn’t seem to be anything down this tunnel, either friend or foe."
                    }

                    Allow_Undo{}
            }

-- ================================================================
-- 2: TREASUREY MODULE
--
-- Room stuffed full of treasure chests. All but one are full of
-- gold. The other contains the Rod of Justice.
-- ================================================================

-- Signpost event, there is nothing like pure greed ;)
            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: 15, y: 28
                }
                do: ->
                    Message{
                        speaker: "narrator"
                        image: "scenery/signpost.png"
                        message: _ "The Treasury"
                    }

                    Message{
                        speaker: "unit"
                        message: _ "The Treasury! Cool, let’s go loot some booty!"
                    }

                    Allow_Undo{}
            }

-- Alarm
-- If alarm wasn't raised yet, raise it on first sight of treasury guard.
            event: {
                name: "sighted"
                filter: {
                    role: "Treasury Guard"
                }
                filter_second: {
                    side: 1
                }
                do: ->
                    Fire_Event{
                        name: "treasury_guard_alert"
                    }
            }

            event: {
                name: "treasury_guard_alert"
                first_time_only: true

-- Just in case we came from the hidden entrance
                do: ->
                    Redraw{
                        side: 1
                    }

                    Message{
                        role: "Treasury Guard"
                        message: _ "Intruders! Get them!"
                    }

                    Message{
                        role: "Supporter"
                        message: _ "Bring it on!"
                    }

-- Add 200, 350 or 500 gold to treasury guards.
                    Gold{
                        side: 5
                        amount: ON_DIFFICULTY(200, 350, 500)
                    }
            }

            TREASURY_GOLD_EVENT: (_X, _Y, _AMOUNT, _MESSAGE) -> {
                event: {
                    name: "moveto"
                    filter: {
                        x: _X, y: _Y
                        side: 1
                    }
                    do: ->
                        Message{
                            speaker: "unit"
                            message: _MESSAGE
                        }

                        Sound{
                            name: "gold.ogg"
                        }

                        Gold{
                            side: 1
                            amount: _AMOUNT
                        }

                        Floating_Text{
                            x: _X, y: _Y
                            text: "<span color='#e1e119'>#{_AMOUNT}</span>" -- wmllint: ignore
                        }

                        Remove_Item{
                            x: x1, y: y1
                        }
                }
            }

-- Gold chests. The main feature of this room.
            <TREASURY_GOLD_EVENT(6, 22, 800, _ "There are at least several hundred gold coins in here!")

            <TREASURY_GOLD_EVENT(9, 21, 500, _ "I don’t think the undead will be be needing this anyway.")

            <TREASURY_GOLD_EVENT(6, 20, 1000, _ "Our people could rebuild their lives ten-fold with the gold in this treasury.")

            <TREASURY_GOLD_EVENT(5, 19, 300, _ "We’re rich!")

            <TREASURY_GOLD_EVENT(7, 16, 1500, _ "Why do these skeletons have so much gold just sitting around?")

            TREASURY_GOLD_EVENT = nil

-- The Rod of Justice!
-- Uberpowerful artifact that can be picked up by any unit with exception of Abhai.
            event: {
                name: "moveto"
                first_time_only: true
                filter: {
                    side: 1
-- wmllint: recognize Abhai
                    id: "Abhai"
                    x: 9, y: 15
                }
                filter_condition: {
                    variable: {
                        name: "got_rod_of_justice"
                        boolean_equals: false
                    }
                }
                do: ->
                    INCIDENTAL_MUSIC("revelation.ogg")

                    Message{
                        speaker: "Abhai"
                        message: _ "The Rod of Justice! What in the world is it doing all the way down here?"
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "What do you have there, Abhai?"
                    }

                    Message{
                        speaker: "Abhai"
                        message: _ "This is the Great Rod of Justice, my boy. It was an ancient artifact even when I was young. They say it was crafted by the Great Gods themselves, and given to the first true Ruler of Men to ensure peace, harmony and above all — justice. For hundreds of years it did just that, for during the time it was wielded by men, the ruling class never became corrupt, the people never lacked justice and neither evil nor wars troubled the land."
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Well, if you don’t mind me saying — that certainly isn’t the state of affairs now. Knalga lies in ruins, orcs ravage the surface, and these dark and evil creatures haunt the underground passages. In the meantime, Wesnoth is said to be ruled by the wicked and cruel queen Asheviere, while the rightful heir must have long since perished in his vain quest for the Sceptre of Fire."
                    }

                    Message{
                        speaker: "Abhai"
                        message: _ "Ahh, with the Rod of Justice down here it is to be expected. Come Tallin, either you or one of your trusted men must wield this staff and bring peace and justice back into this world."
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Why can’t you wield it, Abhai?"
                    }

                    Message{
                        speaker: "Abhai"
                        message: _ "I am a creature of the past, and thus my time to wield it is long gone. This is your era, Tallin, and thus it is your responsibility to see to it that your people receive peace, prosperity and justice. Quickly, come forth or send one of your men for time is waning."
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Very well."
                    }
            }

            event: {
                first_time_only: false
                name: "moveto"
                filter: {
                    side: 1
                    x: 9, y: 15
                    not: {
                        id: "Abhai"
                    }
                }
                filter_condition: {
                    variable: {
                        name: "got_rod_of_justice"
                        boolean_equals: false
                    }
                }
                do: ->
                    Message{
                        speaker: "narrator"
                        image: "items/staff.png"
                        message: _ "An elegantly carved sceptre rests at the bottom of the chest. Precious jewels glitter across its surface, and it exudes a great aura of power."
                        option: {
                            label: _ "rod of justice^Take it"
                            command: ->
                                Message{
                                    speaker: "unit"
                                    message: _ "This thing is... incredible! What is such a powerful artifact doing hidden all the way back here?"
                                }

                                If{
                                    have_unit: {
                                        id: "Camerin"
                                    }
                                    then: ->
                                        Message{
                                            speaker: "Camerin"
                                            message: _ "That’s... that’s the Rod of Justice!"
                                        }

                                        Message{
                                            speaker: "Tallin"
                                            message: _ "Do you know anything about it, Camerin?"
                                        }

                                        Message{
                                            speaker: "Camerin"
                                            message: _ "I don’t think there is a person alive who knows anything more solid than rumors and legends. There are very few people who even knows it exists!"
                                        }

                                        Message{
                                            speaker: "Tallin"
                                            message: _ "How did you come to know of it?"
                                        }

                                        Message{
                                            speaker: "Camerin"
                                            message: _ "Some of the most ancient elvish legends make some vague mention of this artifact. But beyond that..."
                                        }

                                        Message{
                                            speaker: "Tallin"
                                            message: _ "Interesting. I wonder who — or what — could have created such a powerful artifact. There must be one heck of a story behind this thing."
                                        }
                                    
                                }

-- Remove the icon
                                Remove_Item{
                                    x: x1, y: y1
                                }

-- Apply the effects
                                Object{
                                    id: "justice_rod"
                                    name: _ "Rod of Justice"
                                    image: "attacks/staff-magic.png"
                                    duration: "forever"
                                    description: _ "A magical staff of tremendous power and unknown origin. Although the full extent of its power has not been fathomed, there are a few features about it that will be obvious to any master of lore. The wielder of this staff gains a dramatic increase in strength, speed and intelligence, and is granted the ability to fire devastating lightning bolts at his opponents. Only a person who is good at heart and who is willing to sacrifice his life on the path of justice can wield this staff."
                                    filter: {
                                        id: unit.id
                                    }

-- New 16-4 fire attack with cool lightning animation
                                    effect: {
                                        apply_to: "new_attack"
                                        name: "rod of justice"
                                        description: _ "rod of justice"
                                        type: "fire"
                                        range: "ranged"
                                        damage: 16
                                        number: 4
                                        icon: "attacks/lightning.png"
                                    }

-- The cool animation mentioned above, a copypasted
-- fragment from Delfador's attack
                                    effect: {
                                        apply_to: "new_animation"
                                        attack_anim: {
                                            filter_attack: {
                                                name: "rod of justice"
                                            }
                                            <LIGHTNING_BOLT(1)
                                            <SOUND.HIT_AND_MISS("lightning.ogg", "lightning-miss.ogg", -300)
                                        }
                                    }

-- Increase the movement by 2
                                    effect: {
                                        apply_to: "movement"
                                        increase: 2
                                    }

-- If the unit has melee attacks, increase the damage of
-- all of them by two
                                    effect: {
                                        apply_to: "attack"
                                        range: "melee"
                                        increase_damage: 2
                                    }

-- Give the unit additional 10 HP and heal it
                                    effect: {
                                        apply_to: "hitpoints"
                                        increase_total: 10
                                        heal_full: true
                                    }

-- Reduce the amount of experience required for next level
-- by 20%
                                    effect: {
                                        apply_to: "max_experience"
                                        increase: "-20%"
                                    }
                                }

                                VARIABLE("got_rod_of_justice", true)
                            
                        }
                        option: {
                            label: _ "rod of justice^Leave it"
                            command: ->
                                Allow_Undo{}
                            
                        }
                    }
            }

-- ================================================================
-- 3: CHAMBER OF DEATH MODULE
--
-- Path leading toward the Chamber of Death By Spiders, and a
-- back entrance to Malifor's stufy, as well as the prison escape
-- path and treasury back entrance.
-- ================================================================

-- The Great Chamber - signpost
            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: 20, y: 25
                }
                do: ->
                    Message{
                        speaker: "narrator"
                        image: "scenery/signpost.png"
                        message: _ "The Great Chamber"
                    }

                    Message{
                        speaker: "unit"
                        message: _ "‘The Great Chamber’? Hmmm, wonder what that could be."
                    }

                    Allow_Undo{}
            }

            event: {
                name: "sighted"
                filter: {
                    side: 7
                }
                filter_second: {
                    side: 1
                }
                do: ->
                    Message{
                        speaker: "unit"
                        message: _ "Halt! You’re not allowed to be here! Authorized undead only!"
                    }

                    Gold{
                        side: 7
                        amount: ON_DIFFICULTY(200, 350, 500)
                    }
            }

-- Runaway dwarves
-- Once you kill the leader near the spider room, you meet three dwarves
-- that escaped from the dungeon some time ago.
-- They join the army and show a back entrance to the treasury
            event: {
                name: "die"
                filter: {
                    side: 7
                    canrecruit: true
                }
                do: ->
                    Unit{
                        type: "Dwarvish Steelclad"
                        id: "Dulcatas"
                        name: _ "Dulcatas"
                        side: 1
                        x: 4, y: 8
                        <IS_LOYAL!
                        modifications: {
                            <TRAIT_LOYAL!
                            <TRAIT_HEALTHY!
                        }
                    }

                    Unit{
                        type: "Dwarvish Thunderguard"
                        id: "Antolos"
                        name: _ "Antolos"
                        side: 1
                        x: 7, y: 10
                        <IS_LOYAL!
                        modifications: {
                            <TRAIT_LOYAL!
                            <TRAIT_STRONG!
                        }
                    }

                    Unit{
                        type: "Dwarvish Fighter"
                        id: "Varem"
                        name: _ "Varem"
                        side: 1
                        x: 6, y: 13
                        <IS_LOYAL!
                        modifications: {
                            <TRAIT_LOYAL!
                            <TRAIT_RESILIENT!
                        }
                    }

                    Message{
                        speaker: "Dulcatas"
                        message: _ "Halt! Who goes there? Friend or foe?"
                    }

                    Message{
                        speaker: "second_unit"
                        message: _ "Depends. Are you loyal to Malifor?"
                    }

                    Message{
                        speaker: "Dulcatas"
                        message: _ "Never! If you ha’ been sent by Malifor, then know that we will never yield! Come and meet your death!"
                    }

                    Message{
                        speaker: "second_unit"
                        message: _ "Hold! We aren’t friends of Malifor in the least. Rather, we have come to destroy him."
                    }

                    Message{
                        speaker: "Dulcatas"
                        message: _ "Finally! You don’t know how long we have been waiting for this day."
                    }

                    Message{
                        speaker: "second_unit"
                        message: _ "How did you get here and how long have you been here?"
                    }

                    Message{
                        speaker: "Dulcatas"
                        message: _ "We were originally prisoners of Malifor, but we tunneled out and escaped. Since then, we have eked out a precarious survival on what we have been able to steal or raid from Malifor."
                    }

                    Message{
                        speaker: "second_unit"
                        message: _ "By now you have tunnels all through this place."
                    }

                    Message{
                        speaker: "Dulcatas"
                        message: _ "Aye. That seemingly blank wall to the south there is actually a hidden entrance to the treasury."
                    }

                    Message{
                        speaker: "second_unit"
                        message: _ "Awesome, let’s go!"
                    }

-- wmllint: deathcheck off

-- Since the player doesn't know about the entrance until shown it this event can be set up only after meeting the dwarfs
                    Event{
                        name: "moveto"
                        filter: {
                            side: 1
                            x: 8, y: 13
                        }

-- Open the back entrance
                        do: ->
                            Message{
                                speaker: "unit"
                                message: _ "Here we go."
                            }

                            Terrain{
                                x: 8, y: 14
                                terrain: "Uh"
                            }

                            Sound{
                                name: "cave-in.ogg"
                            }

                            Redraw{
                                side: 1
                            }

-- If the treasury alarm wasn't raised yet, this will fire and do so
                            Fire_Event{
                                name: "treasury_guard_alert"
                            }
                    }

-- wmllint: deathcheck on
            }

-- The spider ambush
-- On entering the great chamber two stone blocks cut off the way
-- back and a number of giant spiders spawn to harass the player.
            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: "10-18"
                    y: "1-6"
                }

                scroll_to: {
                    x: 14, y: 4
                }
                do: ->
                    Message{
                        speaker: "unit"
                        message: _ "So this is the Great Chamber, eh? Doesn’t look like there is much to see here."
                    }

                    QUAKE("rumble.ogg")

                    Message{
                        speaker: "narrator"
                        image: "wesnoth-icon.png"
                        message: _ "The ground shakes."
                    }

                    Message{
                        speaker: "unit"
                        message: _ "Perhaps I spoke too soon..."
                    }

                    QUAKE("cave-in.ogg")
                    QUAKE("cave-in.ogg")

-- Cutting off the exit
                    Terrain{
                        x: {9, 10}
                        y: {7, 7}
                        terrain: "Xu"
                    }

                    Redraw{}

                    Message{
                        speaker: "unit"
                        message: _ "What is this? Out retreat is cut off!"
                    }

-- Spawning spiders depending on difficulty
                    NOTRAIT_UNIT(2, "Giant Spider", 6, 2)
                    NOTRAIT_UNIT(2, "Giant Spider", 6, 3)
                    NOTRAIT_UNIT(2, "Giant Spider", 5, 5)
                    NOTRAIT_UNIT(2, "Giant Spider", 5, 3)
                    NOTRAIT_UNIT(2, "Giant Spider", 5, 2)
                    NOTRAIT_UNIT(2, "Giant Spider", 20, 2)
                    NOTRAIT_UNIT(2, "Giant Spider", 20, 1)
                    unless EASY!
                        NOTRAIT_UNIT(2, "Giant Spider", 8, 2)
                        NOTRAIT_UNIT(2, "Giant Spider", 8, 3)
                        NOTRAIT_UNIT(2, "Giant Spider", 22, 2)
                        NOTRAIT_UNIT(2, "Giant Spider", 22, 3)
                        unless NORMAL!
                            NOTRAIT_UNIT(2, "Giant Spider", 4, 2)
                            NOTRAIT_UNIT(2, "Giant Spider", 5, 4)
                            NOTRAIT_UNIT(2, "Giant Spider", 20, 3)
                        
                    

                    QUAKE("cave-in.ogg")
                    QUAKE("cave-in.ogg")

-- Break some walls exposing side tunnels
                    Terrain{
                        x: {19, 19, 9, 9}
                        y: {3, 4, 3, 4}
                        terrain: "Uu"
                    }

                    Redraw{
                        side: 1
                    }

                    Message{
                        type: "Giant Spider"
                        message: _ "Hsssss" -- wmllint: no spellcheck
                    }

                    Message{
                        speaker: "unit"
                        message: _ "‘Great Chamber’, my foot! This is a death chamber!"
                    }
            }

-- ================================================================
-- 4: STUDY MODULE
--
-- This path leads directly to Malifor's Study.
-- Nothing hard in this module either, just dialog.
-- ================================================================

-- Signpost
            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: 25, y: 28
                }
                do: ->
                    Message{
                        speaker: "narrator"
                        image: "scenery/signpost.png"
                        message: _ "Malifor the Great’s Study"
                    }

                    Message{
                        speaker: "unit"
                        message: _ "There we go! This way, guys!"
                    }

                    Allow_Undo{}
            }

-- Study alarm
            event: {
                name: "sighted"
                filter: {
                    role: "Study Guard"
                }
                filter_second: {
                    side: 1
                }
                do: ->
                    Message{
                        role: "Study Guard"
                        message: _ "They are attacking the master’s study! We must stop them! Call the reserves!"
                    }

                    Gold{
                        side: 6
                        amount: ON_DIFFICULTY(200, 350, 500)
                    }
            }

-- ================================================================
-- 5: FLOODED PATH MODULE
--
-- Flooded path leading to the holy water storage, underground lake,
-- and a back entrance to Malifor's study.
-- ================================================================

-- In the beginning, there was a signpost...
-- The flooded path - Signpost
            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: 25, y: 33
                }
                do: ->
                    Message{
                        speaker: "narrator"
                        image: "scenery/signpost.png"
                        message: _ "Caution! Tunnel flooded and infested with aquatic monsters. Enter at the risk of your unlife."
                    }

                    Message{
                        speaker: "unit"
                        message: _ "Interesting. It seems like someone really doesn’t want us going down this tunnel."
                    }

                    Allow_Undo{}
            }

            event: {
                name: "sighted"
                filter: {
                    id: "Hettel"
                }
                filter_second: {
                    side: 1
                }

-- He's not very bright, is he
                do: ->
                    Message{
                        speaker: "unit"
                        message: _ "Intruders? Capture them and throw them in with the toxic waste!"
                    }

                    Gold{
                        side: 3
                        amount: ON_DIFFICULTY(200, 250, 300)
                    }
            }

            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: 34, y: 29
                }
                do: ->
                    Terrain{
                        x: 34, y: 28
                        terrain: "Uu"
                    }

                    Sound{
                        name: "cave-in.ogg"
                    }

                    Redraw{
                        side: 1
                    }

                    Message{
                        speaker: "narrator"
                        image: "wesnoth-icon.png"
                        message: _ "A section of wall slides away."
                    }

                    Delay{
                        time: 1000
                    }

                    Message{
                        speaker: "unit"
                        message: _ "Holy water! For a certainty, those skeletons won’t like us getting our hands on this stuff. But that’s probably why they kept them back here in the first place."
                    }
            }

            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: 35, y: 27
                }
                do: ->
                    Message{
                        speaker: "narrator"
                        image: "scenery/signpost.png"
                        message: _ "Warning! These bottles contain toxic waste. Causes disintegration on contact."
                    }

                    Message{
                        speaker: "unit"
                        message: _ "(<i>rolls eyes</i>) Oh, the hazardous life of a skeleton."
                    }
            }

-- Which pointed towards the lake with a creepy tentacled monster...
            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: "34-36"
                    y: "22-25"
                }
                do: ->
                    Message{
                        speaker: "unit"
                        message: _ "Hey, an underground lake."
                    }

-- We don't have tentacled monsters as such but we do have a single tentacle unit
                    NOTRAIT_UNIT(2, "Tentacle of the Deep", 35, 23)
                    NOTRAIT_UNIT(2, "Tentacle of the Deep", 33, 25)
                    NOTRAIT_UNIT(2, "Tentacle of the Deep", 33, 23)
                    NOTRAIT_UNIT(2, "Tentacle of the Deep", 34, 21)
                    unless EASY!
                        NOTRAIT_UNIT(2, "Tentacle of the Deep", 31, 23)
                        unless NORMAL!
                            NOTRAIT_UNIT(2, "Tentacle of the Deep", 32, 22)
                        
                    

                    Message{
                        speaker: "unit"
                        message: _ "Ack! What are those things!"
                    }

                    If{
                        have_unit: {
                            id: "Camerin"
                        }
                        then: ->
                            Message{
                                speaker: "Camerin"
                                message: _ "Oh yeah, those things. Watch out, they are the arms of some sort of underwater creature. They’ll try to pummel you to death, then drag you under for dinner."
                            }

                            Message{
                                speaker: "Tallin"
                                message: _ "Then how do we get past? I can see that the passage continues to both the north and south and we haven’t found Malifor yet..."
                            }

                            Message{
                                speaker: "Camerin"
                                message: _ "Creatures of that type regenerate over time; it’s doubtful we can destroy it completely. But if we destroy its arms we’ll be relatively safe until they regenerate."
                            }

                            Message{
                                speaker: "Tallin"
                                message: _ "Let’s get to it, then."
                            }
                        
                    }
            }

-- If you decide to capture the village you might see a ghost...
-- Runaway spectre
            event: {
                name: "capture"
                filter: {
                    side: 1
                    x: 31, y: 25
                }
                do: ->
                    Sound{
                        name: "wail-long.wav"
                    }

                    Unit{
                        side: 1
                        x: 32, y: 24
                        type: "Wraith"
                        id: "Abhai"
                        name: _ "Abhai"
-- profile=Abhai.png
                        <IS_LOYAL!
                        modifications: {
                            <TRAIT_LOYAL!
                            <TRAIT_INTELLIGENT!
                        }
                    }

                    Message{
                        speaker: "unit"
                        message: _ "AH! A ghost!"
                    }

                    Message{
                        speaker: "Abhai"
                        message: _ "Who are you that dares to venture down these tunnels?"
                    }

                    Message{
                        speaker: "unit"
                        message: _ "I... I am one of Tallin’s men..."
                    }

                    Message{
                        speaker: "Abhai"
                        message: _ "Who is this ‘Tallin’?"
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "That would be me."
                    }

                    Message{
                        speaker: "Abhai"
                        message: _ "What is your purpose in coming here?"
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "We seek the destruction of the lich Malifor."
                    }

                    Message{
                        speaker: "Abhai"
                        message: _ "(<i>pales if possible</i>) Malifor...! Finally someone here in force to deal with that menace!"
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Can you tell us where he is? And, if I may ask, who are — or rather, were — you?"
                    }

                    Message{
                        speaker: "Abhai"
                        message: _ "I am Lord Abhai, the ruler... once... of a great kingdom far to the west. In time, as all men do, I grew old and passed to the Land of the Dead. I know not how long I dwelt there, before I was wrenched from my peace and drawn into this realm by a terrible power."
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Let me guess. Malifor?"
                    }

                    Message{
                        speaker: "Abhai"
                        message: _ "Indeed. He was once a great sorcerer, but he coveted wealth and power. To gain his ends, he allied himself with the Lich-Lords, and from them he learned their craft. When the orcish menace first appeared on the continent and the Wesfolk fled to the east, Malifor left their service and followed. No word surfaced of his fate from then on, but it seems he became a lich himself. I am not surprised he took up residence in these mines, all these years later — he always had a love of gold, and a special hatred of me. He tried to break me into mindless slavery, but I resisted his power and fled. I have been hiding in these flooded tunnels ever since. Some monster that Malifor’s minions greatly fear lives in these waters; they do not molest me here."
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "I am afraid times have changed much. Our first king, Haldric I, fled from the Green Isle with the Wesfolk and the orcs in pursuit. He came ashore on this land that we now call the Great Continent and destroyed the Lich-Lord Jevyan before founding the Kingdom of Wesnoth. That was centuries ago."
                    }

                    Message{
                        speaker: "Abhai"
                        message: _ "So... much time has passed indeed."
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Would you join us to defeat this evil creature?"
                    }

                    Message{
                        speaker: "Abhai"
-- wmllint: local spelling er
                        message: _ "Wouldn’t miss it. Maybe after he is destroyed my kind and I can live... er... be dead peacefully."
                    }

                    Message{
                        speaker: "Abhai"
                        message: _ "Keep following these flooded tunnels. I think they might lead you directly to Malifor."
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Great. Forward, men!"
                    }
            }

-- And going forward is a sure way to find some bodies
-- A string of corpses
            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: 36, y: 20
                }
                do: ->
                    Message{
                        speaker: "unit"
                        message: _ "Ugh, a corpse. And it — (<i>gags</i>) — reeks!"
                    }
            }

            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: 35, y: 15
                }
                do: ->
                    Message{
                        speaker: "unit"
                        message: _ "Gee, what’s with these bodies floating around? Is this river some sort of body disposal?"
                    }
            }

-- A dead end
            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: 40, y: 22
                }
                do: ->
                    Message{
                        speaker: "unit"
                        message: _ "Just great, I am cold, wet, and tired and what have we here? Another dead body. This place is starting to get on my nerves!"
                    }
            }

-- Eventually you'll always find some bad guy sidekicks. Just waiting to get mauled...
-- Naga guardians
            event: {
                name: "moveto"
                filter: {
                    side: 1
                    x: "35-38"
                    y: "12-14"
                }
                do: ->
                    Message{
                        speaker: "unit"
                        message: _ "Hold it, people, there’s something just ahead!"
                    }

                    GENERIC_UNIT(2, "Naga Warrior", 38, 11)
                    GENERIC_UNIT(2, "Naga Fighter", 38, 10)
                    GENERIC_UNIT(2, "Naga Fighter", 37, 11)
                    unless EASY!
                        GENERIC_UNIT(2, "Naga Fighter", 37, 12)
                        unless NORMAL!
                            GENERIC_UNIT(2, "Naga Fighter", 36, 12)
                        
                    

                    Remove_Shroud{
                        side: 1
                        x: "36-39"
                        y: "9-13"
                    }

                    Message{
                        type: "Naga Warrior"
                        message: _ "(<i>sniff</i>) I smell humans."
                    }

                    Message{
                        type: "Naga Fighter"
                        message: _ "You are just plain deaf. I heard them coming a mile off."
                    }

                    Message{
                        type: "Naga Warrior"
                        message: _ "Ahh, shut up. Let’s go kill them."
                    }
            }

-- ================================================================
-- MALIFOR'S LAIR
--
-- Once you open a door to the Study, the final confrontation
-- begins. There are three pairs of them, and the player can choose
-- not to open any of them them immediately.
-- ================================================================

-- The doors can be opened from following coordinates:
-- Spider (22,3), Main [(22,9) (23,10) (24,10)], and Flooded (34,9)

-- Main doors
            event: {
                name: "moveto"
                first_time_only: false
                filter: {
                    side: 1
                    x: {22, 23, 24}
                    y: {9, 10, 10}
                }
                filter_condition: {
                    variable: {
                        name: "main_door_opened"
                        boolean_equals: false
                    }
                }

-- TODO: gates?
                do: ->
                    Message{
                        speaker: "unit"
                        message: _ "It looks like this is it. Here is the door to Malifor’s study. Are we all ready for this?"
                        option: {
                            label: _ "Get those doors open!"
                            command: ->
                                Sound{
                                    name: "gate-fall.ogg"
                                }

                                Remove_Item{
                                    x: {23, 24, 25}
                                    y: {9, 9, 10}
                                }

                                Terrain{
                                    x: {23, 24, 25}
                                    y: {9, 9, 10}
                                    terrain: "^" -- Intentional, to remove the overlay
                                    layer: "overlay"
                                }

                                Message{
                                    speaker: "unit"
                                    message: _ "Let’s go!"
                                }

                                VARIABLE("main_door_opened", true)

                                Fire_Event{
                                    name: "confront_malifor"
                                }
                            
                        }
                        option: {
                            label: _ "Just wait a sec."
                            command: ->
                                Message{
                                    speaker: "unit"
                                    message: _ "Very well."
                                }
                            
                        }
                    }
            }

-- Spider chamber door
            event: {
                name: "moveto"
                first_time_only: false
                filter: {
                    x: 22, y: 3
                }
                filter_condition: {
                    variable: {
                        name: "spider_door_opened"
                        boolean_equals: false
                    }
                }
                do: ->
                    Message{
                        speaker: "unit"
                        message: _ "Hmmm. The wall appears weak here. I think there might be something on the other side."
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Anything you can’t handle?"
                    }

                    Message{
                        speaker: "unit"
                        message: _ "Nope. Should I open it?"
                        option: {
                            label: _ "Go for it!"
                            command: ->
                                MODIFY_UNIT({x: x1, y: y1}, "facing", "se")

                                Animate_Unit{
                                    filter: {
                                        x: x1, y: y1
                                    }

                                    flag: "attack"
                                    hits: true
                                    with_bars: false
                                }

                                Sound{
                                    name: "cave-in.ogg"
                                }

                                Terrain{
                                    x: 22, y: 4
                                    terrain: "Uu"
                                }

                                Redraw{
                                    side: 1
                                }

                                Message{
                                    speaker: "unit"
                                    message: _ "There we go."
                                }

                                VARIABLE("spider_door_opened", true)

                                Fire_Event{
                                    name: "confront_malifor"
                                }
                            
                        }
                        option: {
                            label: _ "Just wait a sec."
                            command: ->
                                Message{
                                    speaker: "unit"
                                    message: _ "Very well."
                                }
                            
                        }
                    }
            }

-- Flooded passage door
            event: {
                name: "moveto"
                first_time_only: false
                filter: {
                    x: 34, y: 9
                }
                filter_condition: {
                    variable: {
                        name: "back_door_opened"
                        boolean_equals: false
                    }
                }
                do: ->
                    Message{
                        speaker: "unit"
                        message: _ "Hey, check this out, it looks like some sort of lever."
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Throw it and see what it does."
                    }

                    Message{
                        speaker: "unit"
                        message: _ "Should I throw it?"
                        option: {
                            label: _ "Go for it!"
                            command: ->
                                Delay{
                                    time: 2000
                                }

                                Message{
                                    speaker: "unit"
                                    message: _ "Nothing. That door is not moving."
                                }

                                Message{
                                    speaker: "Tallin"
                                    message: _ "Why don’t you try ‘knocking’?"
                                }

                                Message{
                                    speaker: "unit"
                                    message: _ "Very well."
                                }

                                MODIFY_UNIT({x: x1, y: y1}, "facing", "nw")

                                Animate_Unit{
                                    filter: {
                                        x: x1, y: y1
                                    }

                                    flag: "attack"
                                    hits: true
                                    with_bars: false
                                }

                                Sound{
                                    name: "cave-in.ogg"
                                }

                                Terrain{
                                    x: 33, y: 9
                                    terrain: "Uu"
                                }

                                Message{
                                    speaker: "unit"
                                    message: _ "Anybody home?"
                                }

                                Redraw{
                                    side: 1
                                }

                                VARIABLE("back_door_opened", true)

                                Fire_Event{
                                    name: "confront_malifor"
                                }
                            
                        }
                        option: {
                            label: _ "Just wait a sec."
                            command: ->
                                Message{
                                    speaker: "unit"
                                    message: _ "Very well."
                                }
                            
                        }
                    }
            }

            MALIFOR_GUARD: (TYPE, X, Y) -> {
                unit: {
                    side: 2
                    type: TYPE
                    x: X, y: Y

                    generate_name: true
                    random_traits: false
                    random_gender: true

                    facing: "sw"
                    animate: true
                }
            }

-- Opening the door will trigger the confrontation with Malifor
            event: {
                name: "confront_malifor"
                first_time_only: true
                do: ->
                    Remove_Shroud{
                        side: 1
                        x: "23-35"
                        y: "3-10"
                    }

                    Delay{
                        time: 500
                    }

                    Scroll_To_Unit{
                        id: "Malifor"
                    }

                    Message{
                        speaker: "Malifor"
                        message: _ "You wretched vermin, I have had it with you! Guards!"
                    }

-- Give Malifor some guards and gold.
                    MALIFOR_GUARD("Deathblade", 25, 6)
                    MALIFOR_GUARD("Deathblade", 29, 8)
                    MALIFOR_GUARD("Lich", 27, 5)
                    MALIFOR_GUARD("Lich", 32, 7)

                    unless EASY!
                        MALIFOR_GUARD("Deathblade", 31, 4)
                        unless NORMAL!
                            MALIFOR_GUARD("Deathblade", 29, 7)
                            MALIFOR_GUARD("Lich", 35, 6)
                        
                    

                    Gold{
                        side: 2
                        amount: ON_DIFFICULTY(200, 300, 400)
                    }

                    Message{
                        speaker: "Malifor"
                        message: _ "You invaded my kingdom, drove me from my mines, raided my dungeon, and plundered my treasury. Your audacity ends here!"
                    }

-- Second Malifor line doesn't make sense without at least one White Mage around.
-- We need to check for their presence, since they might not have been freed yet,
-- though that's very unlikely
                    If{
                        have_unit: {
                            id: {"Father Morvin", "Sister Thera"}
                        }
                        then: ->
                            Message{
                                speaker: "Father Morvin"
                                message: _ "You are wrong, Malifor, for you shall be the one who is destroyed. You are cruel, merciless and a terror to all that lives. The world will be a better place with you gone!"
                            }

                            Message{
                                speaker: "Sister Thera"
                                message: _ "To feed your greed and hunger you have terrorized all that is good. You have disturbed the rest of the brave defenders of Knalga. Now, your evil reign shall be brought to an end."
                            }

                            Message{
                                speaker: "Malifor"
                                message: _ "Fools! Don’t think it’s so easy to kill me. Your corpses shall all soon be serving me. Fall on them, my hordes!"
                            }
                        
                    }
            }

-- Don't allow anyone but Morvin and Thera to damage Malifor
            <FORCE_CHANCE_TO_HIT({
                    side: 1
                    not: {
                        id: {"Father Morvin", "Sister Thera"}
                    }
err: ../attic/data/campaigns/Northern_Rebirth/scenarios/05a_01_The_Pursuit.cfg - ./wml_to_wsl/parse.moon:224: Error parsing (wml) line 2510:     )(id=Malifor) 0 (
            })

            NOT_WHITE_MAGES_ATTACK_MALIFOR_WITH_WEAPON_TYPE: (_TYPE) -> {
                filter: {
                    side: 1
                    not: {
                        id: {"Father Morvin", "Sister Thera"}
                    }
                }

                filter_attack: {
                    type: _TYPE
                }

                filter_second: {
                    id: "Malifor"
                }
            }

            event: {
                name: "attack end"
                do: ->
                    NOT_WHITE_MAGES_ATTACK_MALIFOR_WITH_WEAPON_TYPE("blade")

                    Message{
                        speaker: "Malifor"
                        message: _ "HAHAHAHA, DEATH HAS NO EFFECT ON ME YOU FOOLS!"
                    }

                    Message{
                        speaker: "unit"
                        message: _ "Well, blades don’t work."
                    }
            }

            event: {
                name: "attack end"
                do: ->
                    NOT_WHITE_MAGES_ATTACK_MALIFOR_WITH_WEAPON_TYPE("pierce")

                    Message{
                        speaker: "Malifor"
                        message: _ "HAHAHAHA, YOUR IDIOCY AMUSES ME GREATLY!"
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Geez, how are we going to kill him? This weapon is ineffective!"
                    }
            }

            event: {
                name: "attack end"
                do: ->
                    NOT_WHITE_MAGES_ATTACK_MALIFOR_WITH_WEAPON_TYPE("fire")

                    Message{
                        speaker: "Malifor"
                        message: _ "YOU PUNY MORTALS SHALL SOON BE SERVING ME!"
                    }

                    Message{
                        speaker: "Camerin"
                        message: _ "That blasted skeleton! Even fire has no effect on him!"
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Let’s try using something different on him."
                    }
            }

            event: {
                name: "attack end"
                filter: {
                    id: {"Father Morvin", "Sister Thera"}
                }
                filter_second: {
                    id: "Malifor"
                }
                do: ->
                    Message{
                        speaker: "second_unit"
                        message: _ "AAAAAAHHHHHH!"
                    }

                    Message{
                        speaker: "Father Morvin"
                        message: _ "I see now. It is impossible to destroy him by ordinary means."
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Then how are we going to destroy him? Surely there must be a way."
                    }

                    Message{
                        speaker: "Father Morvin"
                        message: _ "Yes, I think there is, but only myself or Thera have the means to do it. Come on Thera, let’s destroy that old skeleton."
                    }

                    Message{
                        speaker: "Sister Thera"
                        message: _ "Yeah, I can’t wait to get my hands on that bastard!"
                    }

                    Message{
                        speaker: "Father Morvin"
                        message: _ "That was very unladylike of you."
                    }

                    Message{
                        speaker: "Sister Thera"
                        message: _ "(<i>Giggle</i>) Sorry."
                    }
            }

-- Malifor can be successfully killed only by White Mages.
-- This event handles that assumption.
            event: {
                name: "last breath"
                filter: {
                    id: "Malifor"
                }
                filter_second: {
                    id: {"Father Morvin", "Sister Thera"}
                }
                do: ->
                    Message{
                        speaker: "Malifor"
                        message: _ "AHHHH! YOU BLASTED MAGE!"
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Good. We finally got him. He is dissolving."
                    }

                    Message{
                        speaker: "Malifor"
                        message: _ "Curses on you you blasted mages, curses on you you blasted dwarves, curses on you you blasted humans, and CURSES ON YOU YOU BLASTED TALLIN! MAY YOUR MISERABLE LIVES BE FULL OF TORTURE! MAY YOUR PEOPLE NEVER BE FREE! MAY ALL YOUR NEAR AND DEAR DESERT YOU! MAY A THUNDERBOLT HIT YOUR HEAD! MAY—"
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "May you shut your ugly mouth and hurry up and die."
                    }

                    Message{
                        speaker: "Malifor"
                        message: _ "MAY THE EARTH OPEN UP AND SWALLOW YOU! MAY ALL YOUR TEETH FALL OUT! MAY YOU BECOME A WEAK SKINNY OLD MAN! MAY—"
                    }
            }

            event: {
                name: "die"
                filter: {
                    id: "Malifor"
                }
                filter_second: {
                    id: {"Father Morvin", "Sister Thera"}
                }
                do: ->
                    Message{
                        speaker: "second_unit"
                        message: _ "Finally! He has been reduced to dust."
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "At last! Victory is ours! Good work, men!"
                    }

                    Message{
                        speaker: "Father Morvin"
                        message: _ "So, where to now, Tallin?"
                    }

                    Message{
                        speaker: "Tallin"
                        message: _ "Now, let’s get back to the dwarves and see what progress they have made in forging us weapons."
                    }

                    Endlevel{
                        result: "victory"
                        bonus: true
                        <NEW_GOLD_CARRYOVER(40)
                    }
            }

            event: {
                name: "scenario_end"
                do: ->
                    CLEAR_VARIABLE("malifor_respawn_point,malifor_died_by")
                    CLEAR_VARIABLE("back_door_opened,main_door_opened,spider_door_opened,got_rod_of_justice")
            }

-- And the usual batch of hero death macros
            <HERODEATH_TALLIN!
            <HERODEATH_CAMERIN!
            <HERODEATH_KRASH!
            <HERODEATH_ELENIA!
            <HERODEATH_THERA_AND_MORVIN_WITH_DIALOG!

            <SUPPORTER_DEATH_HANDLER!
err: ../attic/data/campaigns/Northern_Rebirth/scenarios/05a_01_The_Pursuit.cfg - ./wml_to_wsl/compile.moon:28: Unbalanced WML! macro: ON_DIFFICULTY closed by scenario at line 2709

        MALIFORS_GUARD_RECRUITS = nil
        MALIFORS_LAST_BREATH = nil
        MALIFOR_RESPAWN = nil
        MALIFOR_GUARD = nil
