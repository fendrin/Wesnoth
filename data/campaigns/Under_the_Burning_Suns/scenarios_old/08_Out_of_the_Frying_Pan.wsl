--textdomain wesnoth-utbs

Scenario{
    id: "08_Out_of_the_Frying_Pan"
    name: _ "Out of the Frying Pan"
    next_scenario: "09_Blood_is_Thicker_Than_Water"
    <UTBS_MAP("08_Out_of_the_Frying_Pan.map")

    <STORY_OUT_OF_THE_FRYING_PAN!

    <SCENARIO_MUSIC("underground.ogg")
    <EXTRA_SCENARIO_MUSIC("loyalists.ogg")
    <EXTRA_SCENARIO_MUSIC("suspense.ogg")
--TODO redo the playlist

    <TURNS(72, 68, 64)

    victory_when_enemies_defeated: false

    <TWO_SUNS_DEFAULT_SCHEDULE!

--Side 1: elves
    side: {
        side: 1
        id: "Kaleh"
        type: "Desert Fighter"
        canrecruit: true
        gold: 200
        <INCOME(4, 2, 0)
        controller: "human"
        shroud: true
        fog: false
        team_name: "elf_ally"
        user_team_name: _ "team_name^Quenoth Elves"
        <FLAG_VARIANT("long")
    }

--Side 2: Human forces (blue)
    side: {
        side: 2
        no_leader: true
        gold: 0
        income: 0
        controller: "ai"
        team_name: "human_ally"
        user_team_name: _ "Humans"
        <FLAG_VARIANT("undead")
        <if EASY then {
            recruit: {"Spearman", "Pikeman", "Swordsman", "Javelineer", "Cavalryman", "Bowman", "Longbowman"}
        } else {
            recruit: {"Spearman", "Pikeman", "Swordsman", "Javelineer", "Cavalryman", "Bowman", "Longbowman", "Dragoon"}
        }
        ai: {
            recruitment_pattern: {"scout", "fighter", "archer"}

            aggression: 0.6
            caution: 0.1

            passive_leader: true

            goal: {
                name: "target"
                criteria: {
                    side: 1
                }
                value: 10
            }
        }
    }

--Side=3 undead cultists (green)
    side: {
        side: 3
        no_leader: true
        gold: 0
        income: 0
        controller: "ai"
        team_name: "cultists"
        user_team_name: _ "Cultists"
        <FLAG_VARIANT("undead")
        ai: {
            aggression: 0.8
            caution: 0.1
        }
        <FLAG_VARIANT("undead")
    }

--Side=4 confused ants (yellow)
    side: {
        side: 4
        no_leader: true
        gold: 0
        income: 0
        controller: "ai"
        hidden: true
        ai: {
            aggression: -0.99
            caution: 0.99

--keep ants from running too far down the tunnel
            avoid: {
                x: "31-36"
                y: "45-49"
            }
        }
    }

--Side=5 Vengeful Undead
    side: {
        side: 5
        no_leader: true
        gold: 0
        income: 0
        controller: "ai"
        team_name: "human_ally"
        user_team_name: _ "Human Ally"
        <FLAG_VARIANT("undead")
        recruit: {"EGhost", "EWraith", "EShadow"}
        hidden: true
        ai: {
            aggression: 0.75
            caution: 0.1

            recruitment_pattern: "scout"

-- keep undead away from playerâ€™s base
-- option 1 is to avoid x=1-19 (let them enter cave but not
-- sneak around behind base)
-- option 2 is to avoid x=1-25 (lets them get near cave
-- but not enter it)

            avoid: {
                x: "1-25", y: "1-60"
            }
        }
        <FLAG_VARIANT("undead")
    }

--Side=6 dwarf/troll pursuers
    side: {
        side: 6
        no_leader: true
        gold: 0
        income: 0
        controller: "ai"
        hidden: true

        ai: {
            aggression: 0.8
            caution: 0.1
        }
    }

--Side=7 Assassin/Cloaked Figure's side
    side: {
        side: 7
        no_leader: true
        gold: 0
        income: 0
        controller: "ai"
        team_name: "monster"
        hidden: true

        ai: {
            aggression: 0.90
            caution: 0.10

            avoid: {
                x: "10-20"
                y: "10-18"
            }
            goal: {
                name: "target"
                criteria: {
                    id: "Kaleh"
                }
                value: 20
            }
        }
    }

--Side=8 Human messengers
    side: {
        side: 8
        no_leader: true
        gold: 0
        income: 0
        controller: "ai"
        team_name: "human_ally"
        user_team_name: _ "Humans"
        <FLAG_VARIANT("undead")
    }

-- Prestart functions:
-- insert items onto map
-- kill Elyssa to keep her from being recruited
-- increase cost of recruiting units
-- place item images on map
-- recall main heroes
-- initialize starting variables
-- remove shroud surrounding starting position
-- add more dirt at easier difficulties
-- set starting scenario objectives

    event: {
        name: "prestart"

-- add items to map

-- main gate guardian runes
        do: ->
            PLACE_IMAGE("items/rune2-burning.png", 23, 48)
            PLACE_IMAGE("items/rune2-burning.png", 20, 45)

-- wizard chamber guardian rune
            PLACE_IMAGE("items/rune4-burning.png", 18, 34)

-- wizard's monster trapping runes
            PLACE_IMAGE("items/rune3-burning.png", 17, 32)
            PLACE_IMAGE("items/rune3-burning.png", 19, 32)

-- wizard's magic circle
            PLACE_IMAGE("items/magiccircle-nw.png", 17, 29)
            PLACE_IMAGE("items/magiccircle-n.png", 18, 28)
            PLACE_IMAGE("items/magiccircle-ne.png", 19, 29)
            PLACE_IMAGE("items/magiccircle-sw.png", 17, 30)
            PLACE_IMAGE("items/magiccircle-s.png", 18, 30)
            PLACE_IMAGE("items/magiccircle-se.png", 19, 30)

-- golem trapped in magic circle
            PLACE_IMAGE("units/monsters/flesh-golem.png~RC(magenta>red)", 18, 29)

-- Miscellaneous potions
            PLACE_IMAGE("items/potion-poison.png", 18, 27)
            PLACE_IMAGE("items/potion-red.png", 17, 28)
            PLACE_IMAGE("items/potion-grey.png", 19, 28)
            PLACE_IMAGE("items/potion-yellow.png", 16, 29)
            PLACE_IMAGE("items/potion-green.png", 20, 29)

-- wizard's dragon statues
            Item{
                image: "items/dragonstatue.png"
                x: 16, y: 28
            }

            Item{
                image: "items/dragonstatue.png~FL()"
                x: 20, y: 28
            }

-- center chamber healing runes
            PLACE_IMAGE("items/rune-lightblue-small.png", 17, 44)
            PLACE_IMAGE("items/rune-lightblue-small.png", 19, 43)

-- kitchen trash + rocks
            PLACE_IMAGE("scenery/trash.png", 12, 46)
            PLACE_IMAGE("scenery/trash.png", 10, 49)
            PLACE_IMAGE("scenery/trash.png", 9, 47)
            PLACE_IMAGE("scenery/rubble.png", 10, 48)

-- barracks trash + rocks
            PLACE_IMAGE("scenery/trash.png", 15, 40)
            PLACE_IMAGE("scenery/trash.png", 14, 36)
            PLACE_IMAGE("scenery/trash.png", 13, 39)
            PLACE_IMAGE("scenery/rubble.png", 15, 38)
            PLACE_IMAGE("scenery/rubble.png", 18, 39)
            PLACE_IMAGE("items/bones.png", 15, 36)
            PLACE_IMAGE("items/bones.png", 16, 39)

-- training hall skeletons (remains of students + trainer)
            PLACE_IMAGE("items/bones.png", 9, 40)
            PLACE_IMAGE("items/bones.png", 9, 43)
            PLACE_IMAGE("items/bones.png", 11, 41)
            PLACE_IMAGE("items/bones.png", 12, 42)

-- crypt coffins + rocks
            PLACE_IMAGE("items/coffin-closed.png", 10, 26)
            PLACE_IMAGE("items/coffin-closed.png", 10, 28)
            PLACE_IMAGE("items/coffin-closed.png", 12, 25)
            PLACE_IMAGE("items/coffin-closed.png", 12, 27)
            PLACE_IMAGE("scenery/rubble.png", 12, 28)

-- cloaked figure chamber
            PLACE_IMAGE("scenery/rubble.png", 8, 21)

-- temple altar
            PLACE_IMAGE("items/altar-evil.png", 6, 33)
            PLACE_IMAGE("items/bones.png", 7, 36)

-- rocks in human outpost/elves base cave
            PLACE_IMAGE("scenery/rubble.png", 16, 17)

-- chest of gold in human outpost at cave mouth
            PLACE_IMAGE("items/chest-plain-closed.png", 17, 21)

-- kill Elyssa to keep her from being recruited

            Kill{
                id: "Elyssa"
                animate: false
                fire_event: false
            }

            INCREASE_RECRUIT_COSTS(1)

-- Place units in the encampment
            Recall{
                id: "Nym"
                x: 52, y: 42
            }

            Recall{
                id: "Zhul"
                x: 52, y: 41
            }

-- recall dwarf/troll ally
            Recall{
                id: ally_name
                x: 51, y: 43
            }

-- wmllint: recognize Grog
-- wmllint: recognize Nog
-- wmllint: recognize Rogrimir
-- wmllint: recognize Jarl

-- put hero icon on troll/dwarf ally
            Unit_Overlay{
                id: ally_name
                image: "misc/hero-icon.png"
            }

-- initialize starting variables

            Set_Variable{
                name: "ally_must_live"
                value: 1
            }

            Set_Variable{
                name: "healing_rune1"
                value: 1
            }

            if EASY
                Set_Variable{
                    name: "healing_rune2"
                    value: 2
                }
            } else {
                Set_Variable{
                    name: "healing_rune2"
                    value: 1
                }
            

-- timer to store when to send off a human messenger
            Set_Variable{
                name: "messenger_timer"
                value: 0
            }

--remove shroud surrounding starting position
            Remove_Shroud{
                x: {"48-64", "48-57"}
                y: {"41-49", "38-42"}
                side: 1
            }

-- add more dirt to secret passage at easier difficulties

            unless HARD!
                Terrain{
                    x: 20, y: 51
                    terrain: "Re"
                }
            

            if EASY
                Terrain{
                    x: 17, y: 51
                    terrain: "Re"
                }
            

-- set starting scenario objectives
            Objectives{
                summary: _ "Starting Objectives:"
                objective: {
                    description: _ "Escape the Caves"
                    condition: "win"
                }
                objective: {
                    description: _ "Death of Kaleh"
                    condition: "lose"
                }
                objective: {
                    description: _ "Death of Nym"
                    condition: "lose"
                }
                objective: {
                    description: _ "Death of Zhul"
                    condition: "lose"
                }
                objective: {
                    description: _ "Death of Grog"
                    condition: "lose"
                    show_if: {
                        variable: {
                            name: "ally_name"
                            equals: "Grog"
                        }
                    }
                }
                objective: {
                    description: _ "Death of Nog"
                    condition: "lose"
                    show_if: {
                        variable: {
                            name: "ally_name"
                            equals: "Nog"
                        }
                    }
                }
                objective: {
                    description: _ "Death of Rogrimir"
                    condition: "lose"
                    show_if: {
                        variable: {
                            name: "ally_name"
                            equals: "Rogrimir"
                        }
                    }
                }
                objective: {
                    description: _ "Death of Jarl"
                    condition: "lose"
                    show_if: {
                        variable: {
                            name: "ally_name"
                            equals: "Jarl"
                        }
                    }
                }

                gold_carryover: {
                    bonus: true
                    carryover_percentage: 40
                }
            }
    }

-- Event 1: Starting dialogue & dwarves/troll appear

    event: {
        name: "start"
        do: ->
            Message{
                speaker: ally_name
                message: _ "Weâ€™ve come far and weâ€™re almost to the surface. But first we should stop and rest here for a while."
            }

            Message{
                speaker: "Kaleh"
                message: _ "Thatâ€™s a big river; the water is really moving fast."
            }

            If{
                variable: {
                    name: "ally_race"
                    equals: "dwarf"
                }

                then: ->
                    Message{
                        speaker: ally_name
                        message: _ "Yes, this time of year the snow melts from the mountains, and rivers like this often go deep underground. Sometimes the rivers break through and flood caverns, a deadly accident that has occasionally befallen my kind."
                    }
                

                else: ->
                    Message{
                        speaker: ally_name
                        message: _ "Deep and dark are the waters that flow in our caves. Sometimes raging waters flood tunnels without warning. A stream can sustain a village, a sudden flood can destroy it."
                    }
                
            }

            Message{
                speaker: "Nym"
                message: _ "Well, the faster we get out of here, the happier Iâ€™ll be."
            }

            Sound{
                name: "cave-in.ogg"
            }

            UTBS_SHAKE_SCREEN!

            Message{
                speaker: "Zhul"
                message: _ "Wait, did you feel that?"
            }

            Message{
                speaker: "Nym"
                message: _ "What?"
            }

            Message{
                speaker: "Zhul"
                message: _ "It felt like a distant rumbling. And whatâ€™s that roaring sound?"
            }

-- create trolls/dwarves

--in easier difficulties, I wound troll/dwarf units

            If{
                variable: {
                    name: "ally_race"
                    equals: "dwarf"
                }

                then: ->
                    Move_Unit_Fake{
                        type: "Troll Whelp"
                        side: 6
                        x: {52, 52, 53, 53, 53, 53, 52, 51}
                        y: {50, 49, 49, 48, 47, 46, 45, 45}
                    }

                    Unit{
                        type: "Troll Whelp"
                        name: _ "Troll Avenger"
                        side: 6
                        x: 51
                        y: 45
                        <if EASY then {
                            hitpoints: 28
                        }
                        <if NORMAL then {
                            hitpoints: 32
                        }
                    }

                    Move_Unit_Fake{
                        type: "Troll Whelp"
                        side: 6
                        x: {52, 52, 53, 53, 53, 53, 52, 52}
                        y: {50, 49, 49, 48, 47, 46, 45, 44}
                    }

                    Unit{
                        type: "Troll Whelp"
                        name: _ "Troll Avenger"
                        side: 6
                        x: 52
                        y: 44
                        <if EASY then {
                            hitpoints: 28
                        }
                        <if NORMAL then {
                            hitpoints: 32
                        }
                    }

                    Move_Unit_Fake{
                        type: "Troll Shaman"
                        side: 6
                        x: {52, 52, 53, 53, 53, 53, 52}
                        y: {50, 49, 49, 48, 47, 46, 45}
                    }

                    Unit{
                        type: "Troll Shaman"
                        name: _ "Troll Avenger"
                        role: "avenger"
                        side: 6
                        x: 52
                        y: 45
                        <if EASY then {
                            hitpoints: 34
                        }
                        <if NORMAL then {
                            hitpoints: 38
                        }
                    }

                    Message{
                        role: "avenger"
                        message: _ "Foul elves, you not escaped us yet. The Great Leader shall be avenged! We have dammed the river and soon all shall drown in its dark waters. Come join us in death!"
                    }
                

                else: ->
                    Move_Unit_Fake{
                        type: "Dwarvish Fighter"
                        side: 6
                        x: {52, 52, 53, 53, 53, 53, 52, 51}
                        y: {50, 49, 49, 48, 47, 46, 45, 45}
                    }

                    Unit{
                        type: "Dwarvish Fighter"
                        name: _ "Dwarf Avenger"
                        side: 6
                        x: 51
                        y: 45
                        <if EASY then {
                            hitpoints: 26
                        }
                        <if NORMAL then {
                            hitpoints: 30
                        }
                    }

                    Move_Unit_Fake{
                        type: "Dwarvish Thunderer"
                        side: 6
                        x: {52, 52, 53, 53, 53, 53, 52, 52}
                        y: {50, 49, 49, 48, 47, 46, 45, 44}
                    }

                    Unit{
                        type: "Dwarvish Thunderer"
                        name: _ "Dwarf Avenger"
                        side: 6
                        x: 52
                        y: 44
                        <if EASY then {
                            hitpoints: 26
                        }
                        <if NORMAL then {
                            hitpoints: 30
                        }
                    }

                    Move_Unit_Fake{
                        type: "Dwarvish Pathfinder"
                        side: 6
                        x: {52, 52, 53, 53, 53, 53, 52}
                        y: {50, 49, 49, 48, 47, 46, 45}
                    }

                    Unit{
                        type: "Dwarvish Pathfinder"
                        name: _ "Dwarf Avenger"
                        role: "avenger"
                        side: 6
                        x: 52
                        y: 45
                        <if EASY then {
                            hitpoints: 25
                        }
                        <if NORMAL then {
                            hitpoints: 32
                        }
                    }

                    Message{
                        role: "avenger"
                        message: _ "Foul elves, you have not escaped yet. Our chieftain shall be avenged! We have dammed the river and soon all shall drown in its dark waters. Come join us in death!"
                    }
                
            }

            Message{
                speaker: "Kaleh"
                message: _ "That sound must be the rushing water. We have to get our people out of here, and fast!"
            }

            Message{
                speaker: ally_name
                message: _ "Quick, the southern passage!"
            }

            Message{
                speaker: "Zhul"
                message: _ "We havenâ€™t a moment to lose!"
            }
    }

-- Event 2: confused ants

--EASY: 3 fleeing ants, 1 normal ant
--NORMAL: 3 fleeing ants, 2 normal ants
--HARD: 3 fleeing ants, 3 normal ants

    event: {
        name: "moveto"

        filter: {
            x: "36-42"
            y: "45-53"
            side: 1
            not: {
                type: "Dust Devil"
            }
        }
        do: ->
            Terrain{
                x: 44
                y: 52
                terrain: "Wwg"
            }

--create confused ants

            Unit{
                type: "Giant Ant"
                x: 42
                y: 49
                side: 4
                goto_x: 39
                goto_y: 49
            }

            Unit{
                type: "Giant Ant"
                x: 40
                y: 52
                side: 4
                goto_x: 38
                goto_y: 50
            }

            Unit{
                type: "Giant Ant"
                x: 43
                y: 51
                side: 4
                goto_x: 38
                goto_y: 49
            }

            Unit{
                type: "Giant Ant"
                x: 39
                y: 50
                side: 4
            }

            unless EASY!
                Unit{
                    type: "Giant Ant"
                    x: 38
                    y: 52
                    side: 4
                }
            

            if HARD
                Unit{
                    type: "Giant Ant"
                    x: 41
                    y: 52
                    side: 4
                }
            

            Remove_Shroud{
                side: 1
                x: {"37-44", "36-41"}
                y: {"46-53", "50-54"}
            }

            If{
-- The ally has not seen the first set of ants, so has a different reaction.
                variable: {
                    name: "unit.id"
                    equals: ally_name
                }
                then: ->
                    Message{
                        speaker: "unit"
                        message: _ "Hey look, ants!"
                    }
                
                else: ->
                    Message{
                        speaker: "unit"
                        message: _ "Hey look, more ants!"
                    }
                
            }

            If{
-- check to see if Nym is the unit that triggered this event
-- to keep her from talking to herself during the dialogue
                variable: {
                    name: "unit.id"
                    not_equals: "Nym"
                }

                then: ->
                    Message{
                        speaker: "Nym"
                        message: _ "Are you sure there arenâ€™t any spiders?"
                    }

                    Message{
                        speaker: "unit"
                        message: _ "No, but the water is rising to the southeast as well. The river must lead to more tunnels than we first thought."
                    }
                

                else: ->
                    Message{
                        speaker: "unit"
                        message: _ "I donâ€™t see any spiders, but the water is rising to the southeast as well. The river must lead to more tunnels than we first thought."
                    }
                
            }

            Message{
                speaker: "Zhul"
                message: _ "The ants must be fleeing from the flood too."
            }

            Message{
                speaker: "unit"
                message: _ "They seem confused, leaderless. I guess itâ€™s every ant for itself. Uh, oh. Some of them seem to have noticed us."
            }

            Message{
                speaker: "Kaleh"
                message: _ "Well, we have to get out of here too. Looks like we donâ€™t have any choice but to fight our way through the chaos."
            }
    }

-- Event 3: human explorers / cave delvers / spelunkers

    event: {
        name: "moveto"

        filter: {
            x: "30-34"
            y: "43-48"
            side: 1
            not: {
                type: "Dust Devil"
            }
        }
        do: ->
            Terrain{
                x: {36, 37}
                y: {43, 43}
                terrain: "Wwg"
            }

            Remove_Shroud{
                side: 1
                x: {"29-35", "28-30"}
                y: {"41-49", "44-46"}
            }

            Move_Unit_Fake{
                type: "Javelineer"
                side: 2
                x: {36, 35, 34, 33}
                y: {42, 43, 43, 44}
            }

            NAMED_UNIT(2, "Javelineer", 33, 44, "Bellerin", _ "Bellerin", {upkeep: "free"}
err: ../attic/data/campaigns/Under_the_Burning_Suns/scenarios_old/08_Out_of_the_Frying_Pan.cfg - ./wml_to_wsl/parse.moon:224: Error parsing (wml) line 866:         role=human_scout)}

                move_unit_fake: {
                    type: "Swordsman"
                    side: 2
                    x: {36, 35, 34, 34}
                    y: {42, 43, 43, 44}
                }

                <NAMED_UNIT(2, "Swordsman", 34, 44, "Durth", _ "Durth", {upkeep: "free"}
err: ../attic/data/campaigns/Under_the_Burning_Suns/scenarios_old/08_Out_of_the_Frying_Pan.cfg - ./wml_to_wsl/parse.moon:224: Error parsing (wml) line 876:         role=human_scout)}

                    move_unit_fake: {
                        type: ON_DIFFICULTY("(Bowman)", "(Longbowman)", "(Master", "Bowman)")
                        side: 2
                        x: {36, 35, 34}
                        y: {42, 43, 43}
                    }

                    <NAMED_UNIT(2, ON_DIFFICULTY("Bowman", "Longbowman", "Master Bowman"), 34, 43, "Othgar", _ "Othgar", {upkeep: "free"}
err: ../attic/data/campaigns/Under_the_Burning_Suns/scenarios_old/08_Out_of_the_Frying_Pan.cfg - ./wml_to_wsl/parse.moon:224: Error parsing (wml) line 886:         role=human_scout)}

                        message: {
                            speaker: "Durth"
-- wmllint: local spelling durn
                            message: _ "<i>Huff, huff.</i> First the boss tells us to patrol these caves, and then these durn caves start flooding. What next?"
                        }

                        message: {
                            speaker: "Bellerin"
                            message: _ "Shut up and keep running, or weâ€™ll be fish-bait for sure!"
                        }

                        switch: {
                            variable: "unit.race"
                            case: {
                                value: "troll"
                                do: ->
                                    Message{
                                        speaker: "Othgar"
                                        message: _ "Hey look! Itâ€™s a troll!"
                                    }
                                    Message{
                                        speaker: "Durth"
                                        message: _ "Huh? A troll?"
                                    }
                                    Message{
                                        speaker: "Bellerin"
                                        message: _ "Yeah, just like my old grandmam used to tell us: dark gray skin, beady red eyes, hulking brutes with brains as small as a barnacle. They lurk deep in the earth and hate everything that lives above ground. This must be an invasion! The trolls must have started the flood!"
                                    }

                                    Set_Variable{
                                        name: "sealife_response"
                                        value: _ "Fish bait? Barnacles? Who are these humans and what were they talking about?"
                                    }
                            }
                            case: {
                                value: "dwarf"
                                do: ->
                                    Message{
                                        speaker: "Othgar"
                                        message: _ "Hey look! Itâ€™s a dwarf!"
                                    }
                                    Message{
                                        speaker: "Durth"
                                        message: _ "Huh? A dwarf?"
                                    }
                                    Message{
                                        speaker: "Bellerin"
                                        message: _ "Yeah, just like my old grandmam used to tell us: short and stocky, long beards, filthy bastards who are as sneaky as a cuttlefish. They lurk underground and only come up to steal whatever valuables they can get their hands on. This must part of their plot. The dwarves must have started the flood!"
                                    }
                                    Set_Variable{
                                        name: "sealife_response"
                                        value: _ "Fish bait? Cuttlefish? Who are these humans and what were they talking about?"
                                    }
                            }
                            else: ->
                                Message{
                                    speaker: "Othgar"
                                    message: _ "Hey look! Those must be elves!"
                                }
                                Message{
                                    speaker: "Durth"
                                    message: _ "Huh? Elves?"
                                }
                                Message{
                                    speaker: "Bellerin"
                                    message: _ "Yeah, just like my old grandmam used to tell us: pointy ears, pale hair, those shifty eyes, hearts as hard as a hermit crabâ€™s shell. It must be an invasion! They must have started the flood!"
                                }

                                Set_Variable{
                                    name: "sealife_response"
                                    value: _ "Fish bait? Hermit Crabs? Who are these humans and what were they talking about?"
                                }
                            
                        }

                        message: {
                            speaker: "Othgar"
                            message: _ "Then letâ€™s kill them!"
                        }

                        message: {
                            speaker: "Durth"
                            message: _ "Yeah!"
                        }

                        message: {
                            speaker: "unit"
                            message: _ "Theyâ€™re definitely of the â€˜attack first, ask questions laterâ€™ variety."
                        }
err: ../attic/data/campaigns/Under_the_Burning_Suns/scenarios_old/08_Out_of_the_Frying_Pan.cfg - ./wml_to_wsl/compile.moon:28: Unbalanced WML! macro: NAMED_UNIT closed by event at line 972

-- when all humans are dead, play victory conversation

                    event: {
                        name: "die"

                        filter: {
                            side: 2
                            role: "human_scout"
                        }

                        filter_condition: {
                            have_unit: {
                                role: "human_scout"
                                count: 0
                            }
                        }

-- Vary dialogue depending on what kind of sea life the humans originally
-- mentioned. Also if last human died from drowning instead of being killed
-- have Kaleh as the question, instead of the victorious unit.

-- Set speaker before checking for dialog
                        do: ->
                            If{
-- Checks if the unit was killed by the player or whether it drowned
                                have_unit: {
                                    side: 1
                                    x: x2, y: y2
                                }
                                then: ->
                                    CHECK_SPEAKER!
                                
                                else: ->
                                    Set_Variable{
                                        name: "speaking_unit.id"
                                        value: "Kaleh"
                                    }
                                
                            }

                            Message{
                                speaker: speaking_unit.id
                                message: sealife_response
                            }
                            CLEAR_VARIABLE("speaking_unit,sealife_response")

                            Message{
                                speaker: "Zhul"
                                message: _ "No time for questions now, the water shows no signs of stopping. Weâ€™ve got to get out of here while we still can!"
                            }

                            Message{
                                speaker: ally_name
                                message: _ "Curses, the water is rising too fast. That tunnel those humans were fleeing down was the fastest way out of here, but itâ€™s already flooding."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "There must be another way out. There must!"
                            }

                            Message{
                                speaker: ally_name
                                message: _ "There might be, but I donâ€™tâ€”"
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "Then show us the way already! Weâ€™re running out of time."
                            }

                            Message{
                                speaker: ally_name
                                message: _ "Fine. Just keep going west, but be careful."
                            }
                    }

-- Event 4: Discovers Cultists Fort

                    event: {
                        name: "moveto"

                        filter: {
                            x: "20-27"
                            y: "45-50"
                            side: 1
                        }
                        do: ->
                            Remove_Shroud{
                                x: "20-27"
                                y: "45-50"
                                side: 1
                            }

                            If{
                                variable: {
                                    name: "unit.id"
                                    not_equals: ally_name
                                }

                                then: ->
                                    CHECK_EXPLORER!
                                    Message{
                                        speaker: explorer.id
                                        message: _ "Whoa, what is this place? It sure seems well protected."
                                    }
                                    CLEAR_VARIABLE("explorer")

                                    Message{
                                        speaker: ally_name
                                        message: _ "This is an ancient fortress. Who lived here I do not know, but it has been long since abandoned."
                                    }
                                

                                else: ->
                                    Message{
                                        speaker: ally_name
                                        message: _ "Behold, we come now to an ancient fortress. Who lived here I do not know, but it has been long since abandoned."
                                    }
                                
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "Youâ€™ve been this way before?"
                            }

                            Message{
                                speaker: ally_name
                                message: _ "Yes, but I didnâ€™t explore very far. This foul place is still protected by wards and guards. It reeks of dark magic."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "I wish there was another path, but it seems we have no choice."
                            }

                            Message{
                                speaker: ally_name
                                message: _ "Wait. The chamber in front of us is probably trapped and well guarded. There is another way. When I explored here before, I found a secret passage that bypassed the main gate. Search along the southern wall of this cave and you should find it. The only problem is that the passage is long and windy, and it will cost us precious minutes. With the water rising that may be time we donâ€™t have to spend. I leave the final decision up to you, Kaleh."
                            }
                    }

-- Event 4a: discover entrance to secret tunnel

                    event: {
                        name: "moveto"

                        filter: {
                            x: 24
                            y: 49
                            side: 1
                            not: {
                                type: "Dust Devil"
                            }
                        }
                        do: ->
                            If{
                                have_unit: {
                                    x: x1, y: y1
                                    id: ally_name
                                }

                                then: ->
                                    Message{
                                        speaker: "unit"
                                        message: _ "Hmmm, the entrance to the secret tunnel should be right around here somewhere."
                                    }

                                    Message{
                                        speaker: "unit"
                                        message: _ "Got it!"
                                    }
                                

                                else: ->
                                    Message{
                                        speaker: "unit"
                                        message: _ "I think I see a door-shaped crack in this wall."
                                    }

                                    Message{
                                        speaker: ally_name
                                        message: _ "Good, that should be the entrance to the secret tunnel. Now just push hard inwards."
                                    }

                                    Message{
                                        speaker: "unit"
                                        message: _ "Got it!"
                                    }
                                
                            }

                            Terrain{
                                x: 24, y: 50
                                terrain: "Uu"
                            }
                    }

-- Event 4b: discover exit from secret tunnel

                    event: {
                        name: "moveto"

                        filter: {
                            x: 13
                            y: 50
                            side: 1
                            not: {
                                type: "Dust Devil"
                            }
                        }
                        do: ->
                            If{
                                have_unit: {
                                    x: x1, y: y1
                                    id: ally_name
                                }

                                then: ->
                                    Message{
                                        speaker: "unit"
                                        message: _ "Well, this is the end of the tunnel. Which means the other secret door should be right here."
                                    }

                                    Message{
                                        speaker: "unit"
                                        message: _ "Hold on, I think Iâ€™ve found it."
                                    }
                                

                                else: ->
                                    Message{
                                        speaker: "unit"
                                        message: _ "The passage just halts at a dead end."
                                    }

                                    Message{
                                        speaker: ally_name
                                        message: _ "You didnâ€™t expect the other end to be left wide open did you? There should be another secret door hidden right in front of you."
                                    }

                                    Message{
                                        speaker: "unit"
                                        message: _ "Oh, right. Hold on, I think Iâ€™ve found it."
                                    }
                                
                            }

                            Terrain{
                                x: 13, y: 49
                                terrain: "Uu"
                            }

                            Terrain{
                                x: {8, 8}
                                y: {48, 49}
                                terrain: "Wwg"
                            }
                    }

-- Event 5: Enter warded cave

-- remove runes at 20,45 and 23,48
-- do 25% 30% 35% damage to unit
-- awaken guardian undead:

-- EASY: 1 ghouls, 1 soulless, 2 skeletons
-- NORMAL: 1 ghouls, 1 necrophage, 2 skeletons
-- HARD: 2 necrophages, 2 skeletons

                    event: {
                        name: "moveto"

                        filter: {
                            x: {"19-24", 21}
                            y: {"45-47", 48}
                            side: 1
                            not: {
                                type: "Dust Devil"
                            }
                        }
                        do: ->
                            Color_Adjust{
                                red: 255, green: 0, blue: 0
                            }

                            Redraw{
                            }

                            Delay{
                                time: 100
                            }

                            Color_Adjust{
                                red: 0, green: 0, blue: 0
                            }

                            Redraw{
                            }

                            Remove_Item{
                                x: 20, y: 45
                            }

                            Remove_Item{
                                x: 23, y: 48
                            }

                            Object{
                                filter: {
                                    x: x1
                                    y: y1
                                }

                                id: "RuneDamage"
                                silent: true

                                effect: {
                                    apply_to: "hitpoints"
                                    increase: ON_DIFFICULTY("(-25%)", "(-30%)", "(-35%)")
                                }
                            }

-- EASY: 1 ghoul, 1 soulless, 2 skeletons
-- NORMAL: 1 ghoul, 1 necrophage, 2 skeletons
-- HARD: 2 necrophages, 2 skeletons

                            if EASY
                                NAMED_UNIT(3, "Soulless", 21, 48, {}, _ "Gate Guard", {upkeep: "free"})
                                NAMED_UNIT(3, "Ghoul", 24, 46, {}, _ "Gate Guard", {upkeep: "free"})
                            

                            if NORMAL
                                NAMED_UNIT(3, "Ghoul", 21, 48, {}, _ "Gate Guard", {upkeep: "free"})
                                NAMED_UNIT(3, "Necrophage", 24, 46, {}, _ "Gate Guard", {upkeep: "free"})
                            

                            if HARD
                                NAMED_UNIT(3, "Necrophage", 21, 48, {}, _ "Gate Guard", {upkeep: "free"})
                                NAMED_UNIT(3, "Necrophage", 24, 46, {}, _ "Gate Guard", {upkeep: "free"})
                            

                            NAMED_UNIT(3, "Skeleton", 22, 45, {}, _ "Gate Guard", {upkeep: "free"})
                            NAMED_UNIT(3, "Skeleton", 20, 46, {}, _ "Gate Guard", {upkeep: "free"})
                    }

-- Event 6: Enter central cave

                    event: {
                        name: "moveto"

                        filter: {
                            x: "16-21"
                            y: "41-45"
                            side: 1
                            not: {
                                type: "Dust Devil"
                            }
                        }
                        do: ->
                            Remove_Shroud{
                                x: {"15-22", "15-20"}
                                y: {"41-44", 45}
                                side: 1
                            }

                            If{
                                variable: {
                                    name: "unit.id"
                                    not_equals: ally_name
                                }

                                then: ->
                                    Message{
                                        speaker: "unit"
                                        message: _ "This cave seems pretty empty, except for those two glowing runes in the center. This fort must have once been heavily occupied because countless feet have left well worn paths leading in several directions. #{unittest.name which way should we go?"
                                    }

                                    Message{
                                        speaker: ally_name
                                        message: _ "I donâ€™t know. When I last came this way I got scared by all the runes and things moving in the shadows, and I explored no further."
                                    }
                                

                                else: ->
                                    Message{
                                        speaker: "unit"
                                        message: _ "The many tracks left by countless feet clearly show that this fort must have once been heavily occupied, but now this area is empty, except for those two glowing runes in the center. When I last came this way I got scared by the runes and other things moving in the shadows and explored no further. Iâ€™m afraid I cannot advise you which way to go from here."
                                    }
                                
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "Well, we canâ€™t spend all day thinking about it. Pick a direction, Kaleh."
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "Wait, those runes are giving off a cool blue light and for some reason they donâ€™t seem as threatening as the burning red ones we saw before. Perhaps some of the magic left behind here could help us, if someone was brave enough to step into them."
                            }
                    }

-- Event 6a: Step on healing runes (17,44) (19,43)

-- EASY: rune1 heals 1 time, rune2 heals 2 times
-- NORMAL: rune1 heals 1 times, rune2 heals 1 time
-- HARD: rune1 heals 1 time, rune2 heals 1 time

-- when a unit steps on the runes, it is healed
                    UTBS_HEALING_RUNE: (X, Y, RUNE_VAR) -> {
                        event: {
                            name: "moveto"
                            first_time_only: false

                            filter: {
                                x: X
                                y: Y
                                side: 1
                                not: {
                                    type: "Dust Devil"
                                }
                            }

                            filter_condition: {
                                variable: {
                                    name: RUNE_VAR
                                    greater_than: 0
                                }
                            }
                            do: ->
                                Color_Adjust{
                                    red: 31, green: 122, blue: 255
                                }

                                Redraw{
                                }

                                Delay{
                                    time: 100
                                }

                                Color_Adjust{
                                    red: 0, green: 0, blue: 0
                                }

                                Redraw{
                                }

                                Heal_Unit{
                                }

                                Message{
                                    speaker: "unit"
                                    message: _ "I feel refreshed and rejuvenated!"
                                }

                                Set_Variable{
                                    name: RUNE_VAR
                                    sub: 1
                                }

                                If{
                                    variable: {
                                        name: RUNE_VAR
                                        numerical_equals: 0
                                    }

                                    then: ->
                                        Remove_Item{
                                            x: x1, y: y1
                                        }

                                        Message{
                                            speaker: "unit"
                                            message: _ "The rune is gone. I guess the magic only had limited uses."
                                        }
                                    
                                }
                        }
                    }

                    <UTBS_HEALING_RUNE(17, 44, "healing_rune1")
                    <UTBS_HEALING_RUNE(19, 43, "healing_rune2")
                    UTBS_HEALING_RUNE = nil

-- Event 7: Enter dining cavern

-- water pours in from the west
-- 1/2/3 water snakes come out of the water and attack

                    event: {
                        name: "moveto"

                        filter: {
                            x: "7-14"
                            y: "46-49"
                            side: 1
                        }
                        do: ->
                            Terrain{
                                x: {8, 8}
                                y: {48, 49}
                                terrain: "Wwg"
                            }

                            Remove_Shroud{
                                x: {"5-11", "12-15"}
                                y: {"46-51", "46-49"}
                                side: 1
                            }

                            CHECK_EXPLORER!
                            Message{
                                speaker: explorer.id
                                message: _ "There isnâ€™t much left of the furnishings of this room. I think it was some sort of storeroom, but it looks like scavengers have taken anything useful."
                            }

                            Message{
                                speaker: explorer.id
                                message: _ "Curse Uria! The water is rising over here as well. Already the western end of this chamber is flooded. And I think I see shapes rising out of the water. Whatever they are, it canâ€™t be good."
                            }

                            NOTRAIT_UNIT(3, "Water Serpent", 7, 48)
                            unless EASY!
                                NOTRAIT_UNIT(3, "Water Serpent", 8, 49)
                            
                            if HARD
                                NOTRAIT_UNIT(3, "Water Serpent", 7, 49)
                            
                    }

-- Event 8: Training Hall

-- one turn after you enter the hall, ghostly warriors arise and attack
-- should be harder because it's the fast path

                    event: {
                        name: "moveto"

                        filter: {
                            x: "8-13"
                            y: "40-44"
                            side: 1
                            not: {
                                type: "Dust Devil"
                            }
                        }
                        do: ->
                            Remove_Shroud{
                                x: {"7-12", "13-14"}
                                y: {"39-45", "40-45"}
                                side: 1
                            }

--activate flooding of dining cavern

                            Terrain{
                                x: {8, 8}
                                y: {48, 49}
                                terrain: "Wwg"
                            }

                            Message{
                                speaker: "unit"
                                message: _ "This looks like a training hall. There are still a few old swords and spears lying in the corners. But otherwise it seems quite abandoned."
                            }

                            Event{
--at next turn create haunt trainer and ghost novices
                                name: "new turn"
                                do: ->
                                    Fire_Event{
                                        name: "start training"
                                    }
                            }
                    }

                    event: {
                        name: "start training"

-- create wraith and ghosts
                        do: ->
                            NAMED_UNIT(3, "Haunt", 9, 40, "Blessed Kali", _ "Blessed Kali", {upkeep: "free"})
                            Fire_Event{
                                name: "respawn_trainees"
                            }

-- wmllint: local spelling Kali Pior Iona Dani
-- wmllint: recognize Novice Pior
-- wmllint: recognize Novice Dani
-- wmllint: recognize Novice Iona

                            Message{
                                speaker: "Blessed Kali"
                                message: _ "All right you runts, letâ€™s try this again. Pior, remember to swing your sword with your whole body, not just your arms."
                            }

                            Message{
                                speaker: "Novice Pior"
                                message: _ "Yes, sir."
                            }

                            Message{
                                speaker: "Blessed Kali"
                                message: _ "Dani, keep your feet moving. If you stand still youâ€™re a dead man."
                            }

                            Message{
                                speaker: "Novice Dani"
                                message: _ "Right, sir."
                            }

                            Message{
                                speaker: "Blessed Kali"
                                message: _ "Iona, try to vary your attacks more. Youâ€™re becoming too predictable."
                            }

                            Message{
                                speaker: "Novice Iona"
                                message: _ "Iâ€™ll try, sir."
                            }

                            Message{
                                speaker: "Blessed Kali"
                                message: _ "And remember, everyone, weâ€™re going to keep practicing until Iâ€™m satisfied. So, ready... attack!"
                            }

                            Message{
                                x: "8-14", y: "40-45"
                                side: 1
                                not: {
                                    type: "Dust Devil"
                                }
                                message: _ "Wait a minute, I donâ€™t see any targets or practice dummies. Who are they supposed to be attacking?"
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "I believe that would be us. But perhaps we can give them a few lessons in proper fighting style."
                            }
                    }

-- while trainer is alive, replace any defeated ghosts

                    event: {
                        name: "new turn"
                        first_time_only: false

                        filter_condition: {
                            have_unit: {
                                id: "Blessed Kali"
                            }

                            not: {
                                have_unit: {
                                    id: {"Novice Iona", "Novice Dani", "Novice Pior"}
                                    count: 3
                                }
                            }
                        }
                        do: ->
                            Message{
                                speaker: "Blessed Kali"
                                message: _ "Come on! I ainâ€™t going anywhere for the rest of the day, and unless you can fight better than that, neither are you. Now get your sorry behinds up off the ground and do it all over again. You numbskulls arenâ€™t getting the easy treatment on my watch, no sir!"
                            }

                            Fire_Event{
                                name: "respawn_trainees"
                            }
                    }

--when blessed kali dies, the rest of his ghost students leave too

                    event: {
                        name: "die"

                        filter: {
                            id: "Blessed Kali"
                        }
                        do: ->
                            Kill{
                                id: "Blessed Kali"
                                animate: false
                                fire_event: false
                            }

                            Fire_Event{
                                name: "respawn_trainees"
                            }

                            Message{
                                speaker: "Novice Pior"
                                message: _ "Finally, we get to take a break. I am so sick of fighting practice."
                            }

                            Message{
                                speaker: "Novice Dani"
                                message: _ "Kaliâ€™s just a hardass because heâ€™s bitter that he never became a high priest."
                            }

                            Message{
                                speaker: "Novice Iona"
-- wmllint: local spelling c'mon
                                message: _ "Hey, câ€™mon, maybe we can grab some food from the kitchen before we have to go to prayers."
                            }

                            Message{
                                speaker: "Novice Pior"
                                message: _ "Good idea! I hope they let us go outside tomorrow; I so miss the sun."
                            }

                            Kill{
                                id: {"Novice Iona", "Novice Dani", "Novice Pior"}
                                animate: false
                                fire_event: false
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "Still lambasting those novices after all these years, that guy definitely had too much of a work ethic."
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "Sniff, who were those children? Why did they die, in the dark, so many years ago? May Eloh shine her eternal light upon their souls."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "The past is the past, and thereâ€™s nothing we can do about it. Right now we have our own people to worry about."
                            }
                    }

                    event: {
                        name: "respawn_trainees"
                        first_time_only: false
                        do: ->
                            If{
                                not: {
                                    have_unit: {
                                        id: "Novice Dani"
                                    }
                                }

                                then: ->
                                    NAMED_UNIT(3, "Ghost", 12, 42, "Novice Dani", _ "Novice Dani", {upkeep: "free"})
                                
                            }

                            If{
                                not: {
                                    have_unit: {
                                        id: "Novice Iona"
                                    }
                                }

                                then: ->
                                    NAMED_UNIT(3, "Ghost", 11, 41, "Novice Iona", _ "Novice Iona", {upkeep: "free"})
                                
                            }

                            If{
                                not: {
                                    have_unit: {
                                        id: "Novice Pior"
                                    }
                                }

                                then: ->
                                    NAMED_UNIT(3, "Ghost", 9, 43, "Novice Pior", _ "Novice Pior", {upkeep: "free"})
                                
                            }
                    }

-- Event 9: Enter sleeping area

-- several skeletons arise and attack
-- EASY: 2 skeletons, 1 skeleton archer
-- NORMAL: 2 skeletons, 2 skeleton archers
-- HARD: 1 deathblade, 1 skeleton, 1 bone shooter, 1 skeleton archer

                    event: {
                        name: "moveto"

                        filter: {
                            x: "13-19"
                            y: "36-40"
                            side: 1
                        }
                        do: ->
                            Remove_Shroud{
                                x: "11-20"
                                y: "35-39"
                                side: 1
                            }

                            Remove_Shroud{
                                x: "14-17"
                                y: "38-41"
                                side: 1
                            }

--activate flooding of dining cavern

                            Terrain{
                                x: {8, 8}
                                y: {48, 49}
                                terrain: "Wwg"
                            }

                            CHECK_EXPLORER!

                            Message{
                                speaker: explorer.id
                                message: _ "This must have been the barracks. Remains of cots and beds litter the floor. Whatever happened here, it must have been sudden. Several skeletons still lie in their beds, sleeping for eternity."
                            }

                            CLEAR_VARIABLE("explorer")

                            NAMED_UNIT(3, "Skeleton", 15, 40, {}, _ "Restless Dead", {upkeep: "free", animate: true})
                            NAMED_UNIT(3, "Skeleton Archer", 14, 36, {}, _ "Restless Dead", {upkeep: "free", animate: true})

                            if HARD
                                NAMED_UNIT(3, "Deathblade", 13, 39, {}, _ "Restless Dead", {upkeep: "free", animate: true})
                            } else {
                                NAMED_UNIT(3, "Skeleton", 13, 39, {}, _ "Restless Dead", {upkeep: "free", animate: true})
                            

                            if HARD
                                NAMED_UNIT(3, "Bone Shooter", 17, 37, {}, _ "Restless Dead", {upkeep: "free", animate: true})
                            

                            if NORMAL
                                NAMED_UNIT(3, "Skeleton Archer", 17, 37, {}, _ "Restless Dead", {upkeep: "free", animate: true})
                            

                            Message{
                                side: 3
                                type: "Skeleton"
                                x: "14-16", y: "39-41"
                                message: _ "Revenge!"
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "Well, so much for sleeping for eternity."
                            }
                    }

-- event for secret door to wizard's lair

                    event: {
                        name: "moveto"

                        filter: {
                            x: 17
                            y: 36
                            side: 1
                            not: {
                                type: "Dust Devil"
                            }
                        }
                        do: ->
                            Message{
                                speaker: "unit"
                                message: _ "Hey, whatâ€™s this? There seems to be an outline of a door in this wall. Maybe if I give it a push..."
                            }

                            Terrain{
                                x: 18, y: 35
                                terrain: "Uu"
                            }

                            Message{
                                speaker: "unit"
                                message: _ "What do you know? A secret door!"
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "Well, whatâ€™s behind the door?"
                            }

                            Message{
                                speaker: "unit"
                                message: _ "Uh oh. The path is blocked by another of those red glowing runes. Iâ€™m not sure crossing it would be a good idea."
                            }
                    }

-- Event 10: Enter Wizard's Lair

-- strange monsters are trapped on the runes

-- Kromph offers to help you (10-3 impact berserk chaotic)

                    event: {
                        name: "moveto"

                        filter: {
                            x: "16-20"
                            y: "27-34"
                            side: 1
                            not: {
                                type: "Dust Devil"
                            }
                        }
                        do: ->
                            Remove_Shroud{
                                x: "15-21"
                                y: "27-34"
                                side: 1
                            }

-- upon entering chamber, remove entry rune and damage and
-- poison invading unit

                            Color_Adjust{
                                red: 255, green: 0, blue: 0
                            }

                            Redraw{
                            }

                            Delay{
                                time: 100
                            }

                            Color_Adjust{
                                red: 0, green: 0, blue: 0
                            }

                            Redraw{
                            }

                            Remove_Item{
                                x: 18, y: 34
                            }

                            Store_Unit{
                                filter: {
                                    x: x1, y: y1
                                }
                                variable: "unitstats"
                            }

                            Harm_Unit{
                                filter: {
                                    x: x1, y: y1
                                }
err: ../attic/data/campaigns/Under_the_Burning_Suns/scenarios_old/08_Out_of_the_Frying_Pan.cfg - ./wml_to_wsl/parse.moon:224: Error parsing (wml) line 1925:             amount=$($unitstats.max_hitpoints/{ON_DIFFICULTY 5 4 3})
                                kill: false
                                poisoned: true
                            }

                            CLEAR_VARIABLE("unitstats")

                            NAMED_UNIT(3, "Crab Man", 17, 32, "Failed Experiment 1", _ "Failed Experiment", {upkeep: "free"})
                            NAMED_UNIT(3, "Young Ogre", 19, 32, "Failed Experiment 2", _ "Failed Experiment", {upkeep: "free"})

                            Message{
                                speaker: "unit"
                                message: _ "This chamber seems to have been some sort of laboratory. The floor is littered with broken bottles and other strange equipment. What is more striking are the glowing runes and the creatures that just appeared on them. Some sort of clawed creature and a tortured young ogre. And behind them is some huge beast floating in the middle of a magic circle. The beast seems asleep, but the front two are very much awake. And boy do they seem angry."
                            }

                            Message{
                                speaker: "Failed Experiment 1"
                                message: _ "Graaww!" -- wmllint: no spellcheck
                            }

                            Message{
                                speaker: "Failed Experiment 2"
                                message: _ "Make pain end!"
                            }
                    }

--disrupt magical circle

                    event: {
                        name: "moveto"
                        id: "break_circle"
                        first_time_only: false

                        filter: {
                            x: "17-19"
                            y: "28-30"
                            side: 1
                            not: {
                                type: "Dust Devil"
                            }
                        }
                        do: ->
                            Message{
                                speaker: "unit"

                                message: _ "In the center of this circle is a huge creature, with surging muscles and bloodshot eyes. I would think it was just a very big man, except for the fine stitches that cover its entire body. In fact it seems to be composed of many body parts all sewn together. It seems to be floating asleep in the center of the glowing magical circle. I could scratch out part of the circle and break it, but I have no idea what the consequences would be. Iâ€™m not sure I want something with that kind of strength attacking me."
                                option: {
                                    label: _ "Break the circle"
                                    command: ->
                                        Remove_Event{
                                            id: "break_circle"
                                        }

                                        Remove_Item{
                                            x: x1, y: y1
                                        }

-- Kill old unit which couldnâ€™t move and
-- Just replace with new version of unit
-- since new golem is on playerâ€™s side, it is
-- no longer allied with undead

                                        Remove_Item{
                                            x: 18, y: 29
                                        }

                                        NAMED_UNIT(1, "Flesh Golem", 18, 29, "Kromph", _ "Kromph", {upkeep: "loyal"})

                                        Message{
                                            speaker: "Kromph"
                                            message: _ "Master, what is your command?"
                                        }

                                        Message{
                                            speaker: "unit"
                                            message: _ "What?!"
                                        }

                                        Message{
                                            speaker: "Kromph"
                                            message: _ "Kromph need command. Command me!"
                                        }

                                        Message{
                                            speaker: "Nym"
                                            message: _ "Follow us. Attack our enemies."
                                        }

                                        Message{
                                            speaker: "Kromph"
                                            message: _ "Yes, mistress. Kromph follow you. Kill enemies."
                                        }

                                        Message{
                                            speaker: "Zhul"
                                            message: _ "Quick thinking, Nym. It seems to be some sort of magical creation. Lucky that it thought we were its master."
                                        }

                                        Message{
                                            speaker: "Kaleh"
                                            message: _ "Looks like you have your own rather large pet, Nym."
                                        }

                                        Message{
                                            speaker: "Nym"
                                            message: _ "It wouldnâ€™t have been my first choice. But it could prove useful. I wonder what it likes to eat?"
                                        }
                                    
                                }

                                option: {
                                    label: _ "Leave that thing alone."

                                    command: ->
                                        Allow_Undo{
                                        }
                                    
                                }
                            }
                    }

-- Event 11: Enter Unholy Sanctuary

                    event: {
                        name: "moveto"

                        filter: {
                            x: "5-10"
                            y: "32-37"
                            side: 1
                            not: {
                                type: {"Dust Devil", "Flesh Golem"}
                            }
                        }
                        do: ->
                            Remove_Shroud{
                                x: "3-11"
                                y: "31-37"
                                side: 1
                            }

                            Message{
                                speaker: "unit"
                                message: _ "All the paths lead to this chamber. Is this just a dead end? It seems to be some sort of temple, but it has obviously been abandoned for a long time. All that is left is that stone altar. What god they were worshiping I have no idea, but the dried blood and cracked bones on the altar do not bode well."
                            }

                            Message{
                                speaker: ally_name
                                message: _ "I donâ€™t like the smell of this place."
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "I feel some sort of presence... Ugh... it makes my skin crawl."
                            }

                            MESSAGE_DEPEND_ON_ALLY!
                                {
                                    message: {
                                        speaker: "Nym"
                                        message: _ "Grog, I thought you said that youâ€™d been here before? Where are we supposed to go from here?"
                                    }
                                }
                                {
                                    message: {
                                        speaker: "Nym"
                                        message: _ "Nog, I thought you said that youâ€™d been here before? Where are we supposed to go from here?"
                                    }
                                }
                                {
                                    message: {
                                        speaker: "Nym"
                                        message: _ "Rogrimir, I thought you said that youâ€™d been here before? Where are we supposed to go from here?"
                                    }
                                }
                                {
                                    message: {
                                        speaker: "Nym"
                                        message: _ "Jarl, I thought you said that youâ€™d been here before? Where are we supposed to go from here?"
                                    }
                            })

                            Message{
                                speaker: ally_name
                                message: _ "I never explored this deep into the complex. But every lair has to have a back door somewhere."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "Well I refuse to give up. There must be some way out. Search everywhere, people."
                            }

                            Event{
                                name: "new turn"
                                do: ->
                                    Color_Adjust{
                                        red: 255, green: 0, blue: 0
                                    }

                                    Redraw{
                                    }

                                    Delay{
                                        time: 100
                                    }

                                    Color_Adjust{
                                        red: 0, green: 0, blue: 0
                                    }

                                    Redraw{
                                    }

                                    NAMED_UNIT(3, "Ixthala Demon", 5, 35, "Ancient Guardian 1", _ "Ancient Guardian", {upkeep: "free"})
                                    NAMED_UNIT(3, "Ixthala Demon", 8, 33, "Ancient Guardian 2", _ "Ancient Guardian", {upkeep: "free"})

                                    Message{
                                        speaker: "Ancient Guardian 1"
                                        message: _ "Zantoff tharqan yur glit zarf!" -- wmllint: no spellcheck
                                    }

                                    Message{
                                        speaker: "Ancient Guardian 2"
                                        message: _ "Uqtor dunil olgluck vara nir!" -- wmllint: no spellcheck
                                    }

                                    Message{
                                        speaker: "Zhul"
                                        message: _ "It seems that the temple had some power left in it after all."
                                    }

                                    Message{
                                        speaker: "Nym"
                                        message: _ "I have no idea what they just said, but their meaning is quite clear."
                                    }

                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "Actions speak louder than words, and I intend to send them back to whatever stygian pits they came from!"
                                    }
                            }
                    }

-- Altar contains hidden lever which open secret exit

                    event: {
                        name: "moveto"
                        id: "pull_lever"
                        first_time_only: false

                        filter: {
                            filter_location: {
                                x: 6, y: 33
                                radius: 1
                            }
                            side: 1
                            not: {
                                type: {"Dust Devil", "Flesh Golem"}
                            }
                        }
                        do: ->
                            Message{
                                speaker: "unit"

                                message: _ "Whatâ€™s this? Hidden underneath the edge of the altar is an iron lever. It looks slightly rusted, but with some effort I could pull it. I have no idea what it will do, but weâ€™re running out of options."
                                option: {
                                    label: _ "Pull the lever."
                                    command: ->
                                        Remove_Event{
                                            id: "pull_lever"
                                        }

                                        UTBS_SHAKE_SCREEN!

                                        Terrain{
                                            x: {9, 9}
                                            y: {31, 32}
                                            terrain: "Uu"
                                        }

                                        Terrain{
                                            x: 1
                                            y: 33
                                            terrain: "Wo"
                                        }

                                        Terrain{
                                            x: {2, 2, 3}
                                            y: {33, 34, 35}
                                            terrain: "Wwg"
                                        }

                                        Remove_Shroud{
                                            x: "2-5"
                                            y: "33-36"
                                            side: 1
                                        }

                                        Redraw{
                                        }

                                        Message{
                                            speaker: "unit"
                                            message: _ "What?! Two secret passages? What do you think this once was, a trap? Or possibly a back door?"
                                        }

                                        Message{
                                            speaker: "Zhul"
                                            message: _ "I canâ€™t even begin to fathom what these cultists were up to. But more importantly, which way do we go?"
                                        }

                                        Message{
                                            speaker: "unit"
                                            message: _ "Look, the western passage is already flooding! It must connect back somehow to the other tunnels."
                                        }

                                        Message{
                                            speaker: "Nym"
                                            message: _ "Thereâ€™s no time to ponder the history of this place. Weâ€™ve got to get out of here!"
                                        }

                                        Message{
                                            speaker: "Kaleh"
                                            message: _ "Right, the eastern passage it is. I have no idea where it goes, but with the water rising, soon anywhere will be better than here."
                                        }
                                    
                                }

                                option: {
                                    label: _ "Leave it alone."

                                    command: ->
                                        Allow_Undo{
                                        }
                                    
                                }
                            }
                    }

-- Event 12: Enter Secret Crypt

                    event: {
                        name: "moveto"

                        filter: {
                            x: "8-14"
                            y: "24-30"
                            side: 1
                        }
                        do: ->
                            Remove_Shroud{
                                x: "8-14"
                                y: "24-31"
                                side: 1
                            }

                            CHECK_EXPLORER!
                            Message{
                                speaker: explorer.id
                                message: _ "This looks like some kind of burial chamber."
                            }
                            CLEAR_VARIABLE("explorer")

                            Message{
                                speaker: "Zhul"
                                message: _ "Crypts like these are often heavily guarded, we would do well not to disturb the sarcophagi."
                            }

--create crypt guardian unit

                            NAMED_UNIT(3, "Spider Lich", 12, 25, "Crypt Guardian", _ "Crypt Guardian", {upkeep: "free"})

                            Message{
                                speaker: "Crypt Guardian"
                                message: _ "I have long waited for fools such as yourselves to dare to disturb our rest, elf. Pay the price of all such defilers!"
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "Got any other timely advice, Zhul?"
                            }

                            Message{
                                speaker: ally_name
                                message: _ "Weâ€™re in luck, a fissure has opened up a crack in the northern wall. We may be able to escape that way."
                            }
                    }

-- Event 13: Encounter Cloaked Figure for a third time

                    event: {
                        name: "moveto"

                        filter: {
                            x: "8-12"
                            y: "19-23"
                            side: 1
                        }
                        do: ->
                            Remove_Shroud{
                                x: "7-13"
                                y: "19-24"
                                side: 1
                            }

                            Unit{
                                type: "Dark Assassin3"
                                id: "Cloaked Figure"
                                name: _ "Cloaked Figure"
                                side: 7
                                x: 10
                                y: 19
                                placement: "map_passable"
                                modifications: {
                                    <TRAIT_INTELLIGENT!
                                    <TRAIT_RESILIENT!
                                }
                            }

                            Message{
                                speaker: "Cloaked Figure"
                                image: "portraits/cloaked.png"
                                message: _ "You run, but you shall not escape death!"
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "In Elohâ€™s name, not you again. Must I fight you a third time?"
                            }

                            Message{
                                speaker: "Cloaked Figure"
                                image: "portraits/cloaked.png"
                                message: _ "You abandoned them, Kaleh, to eternal suffering and torment. And now you shall pay the price! You too shall watch the black waters consume those you love. Embrace the darkness, Kaleh, it is coming for you too."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "Even you shall not stop me. You shall taste the might of the Quenoth elves!"
                            }

                            Message{
                                speaker: "Cloaked Figure"
                                image: "portraits/cloaked.png"
                                message: _ "Ha! Foolish boy, you know nothing."
                            }
                    }

-- Event 14: Defeat of Cloaked Figure (kaleh carries him himself)

                    event: {
                        name: "last breath"

                        filter: {
                            id: "Cloaked Figure"
                        }
                        do: ->
                            Message{
                                speaker: "Kaleh"
                                message: _ "Quick, grab him! Donâ€™t let him escape again."
                            }

                            Message{
                                speaker: "Cloaked Figure"
                                image: "portraits/cloaked.png"
                                message: _ "No, no, no more escaping. Please kill me, just make the pain end."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "No, you have hounded me with your riddles for too long. I want some answers. Who are you? Whatâ€™s behind that black mask?"
                            }

                            Message{
                                speaker: "Cloaked Figure"
                                image: "portraits/uncloaked.png"
                                message: _ "Behold, Kaleh, your own worst enemy. Do you now see the irony?"
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "Oh Eloh save us, itâ€™s... itâ€™s an elf."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "Keratur, son of Tanuil. What in Elohâ€™s name are you doing here? How could you do this? We thought you were dead."
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "Kaleh, we donâ€™t have time for questions. The water is still rising and we must get our people to safety."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "No matter what you have done, you are one of us, Keratur, and I will not leave you here to die in the darkness. I will carry you myself if I have to."
                            }

                            Message{
                                speaker: "Cloaked Figure"
                                image: "portraits/uncloaked.png"
                                message: _ "So be it. I care not."
                            }

                            Kill{
                                id: "Cloaked Figure"
                                animate: false, fire_event: false
                            }

-- When a unit moves into human outpost cavern, they see the human base
-- and the dead guards. If unit is not Kaleh, Kaleh comes up to see.
-- Then Cloaked Figure asks Kaleh to put him down and a conversation ensues.
                            Event{
                                name: "moveto"

                                filter: {
                                    x: "17-24"
                                    y: "15-23"
                                    side: 1
                                }

-- reveal interior of entrance cave
                                do: ->
                                    Remove_Shroud{
                                        x: {"16-21", "21-24"}
                                        y: {"15-22", "17-21"}
                                        side: 1
                                    }

                                    CHECK_EXPLORER!
                                    Message{
                                        speaker: explorer.id
                                        message: _ "Look, daylight! I think we finally made it out of the caves!"
                                    }

                                    Message{
                                        speaker: explorer.id
                                        message: _ "Whatâ€™s this? Someone has built an outpost at the end of the cave. Where are its occupants?"
                                    }

                                    If{
                                        variable: {
                                            name: "unit.id"
                                            not_equals: "Kaleh"
                                        }

                                        then: ->
                                            Message{
                                                speaker: explorer.id
                                                message: _ "Kaleh, I think you should come up and see this."
                                            }

                                            Teleport{
                                                filter: {
                                                    id: "Kaleh"
                                                }
                                                x: x1
                                                y: y1
                                            }
                                        
                                    }

                                    CLEAR_VARIABLE("explorer")

                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "Oh, Eloh. Theyâ€™re all dead. Butchered. Quick, we have to clean this up, we donâ€™t want the rest of our people to have to see such horror."
                                    }

                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "Now, Keratur, I will have my answers. Did you have a hand in this?"
                                    }

--create keratur in a blank space near kaleh

                                    Unit{
                                        type: "Dark Assassin3"
                                        id: "Keratur"
                                        name: _ "Keratur"
                                        profile: "portraits/uncloaked.png"
                                        x: x1
                                        y: y1
                                        side: 1
                                        hitpoints: 5
                                        placement: "map_passable"
                                        modifications: {
                                            <TRAIT_INTELLIGENT!
                                            <TRAIT_RESILIENT!
                                        }
                                    }

                                    Message{
                                        speaker: "Keratur"
                                        image: "portraits/uncloaked.png"
                                        message: _ "They heard me and... and they got in the way. But they arenâ€™t even elves, what do they matter?"
                                    }

                                    Message{
                                        speaker: "Nym"
                                        message: _ "You idiotâ€”"
                                    }

                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "Quiet, Nym. But I still donâ€™t understand how you got here. We were sure you were dead. We searched and searched, but never found your body."
                                    }

                                    Message{
                                        speaker: "Keratur"
                                        image: "portraits/uncloaked.png"
                                        message: _ "Heh, heh, no you didnâ€™t find me. I awoke trapped under the rubble, and when I finally escaped the village was deserted. Just the stink of death and destruction. And then I saw them, hordes of undead pouring down from across the dunes. A cabal of necromancers... they found me and made me watch, they made me watch it all!"
                                    }

                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "Watch what?"
                                    }

                                    Message{
                                        speaker: "Keratur"
                                        image: "portraits/uncloaked.png"
                                        message: _ "They brought some humans, bound up tight. So beautiful... she had flaming red hair... they cut her... I can still hear her screaming. But that was only the beginning. They chanted words of power, and spilled the hot blood onto the sand and then I heard their screams of agony and pain..."
                                    }

                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "From the humans?"
                                    }

                                    Message{
                                        speaker: "Keratur"
                                        image: "portraits/uncloaked.png"
                                        message: _ "Faugh. No, I heard the screams of the dead, torn from their rest, their souls rose into the air howling in agony."
                                    }

                                    Message{
                                        speaker: "Zhul"
                                        message: _ "But, but we burned the bodies so they couldnâ€™t be raised."
                                    }

                                    Message{
                                        speaker: "Keratur"
                                        image: "portraits/uncloaked.png"
                                        message: _ "Fool. That did not stop their dark power. Nothing could stop them. I felt the rush of flying spirits, and the unbearable cold, so cold. For a moment I felt their torment. But no, they wouldnâ€™t kill me. They let me go as a witness and laughed as I scrambled over the dunes."
                                    }

                                    Message{
                                        speaker: "Keratur"
                                        image: "portraits/uncloaked.png"
                                        message: _ "I was able to follow your trail, and I slipped among your people. No one noticed me, no I was too sneaky. And you wondered how I managed to follow you through the tunnels? Hah, you escorted me."
                                    }

                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "But why, why did you want to kill us?"
                                    }

                                    Message{
                                        speaker: "Keratur"
                                        image: "portraits/uncloaked.png"
                                        message: _ "You abandoned them! The pain, the agony, I still see their ghostly faces and hear their wails. And the necromancers kept chanting one name over and over: Yechnagoth, Yechnagoth, it reverberated in my ears. And every time I sleep I hear that name, and laughter, hideous laughter. She kept telling me it was your fault. And I believed her. Kaleh, forgive me, I just wanted to make the pain stop."
                                    }

                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "I... I forgive you."
                                    }

                                    Message{
                                        speaker: "Keratur"
                                        image: "portraits/uncloaked.png"
                                        message: _ "I do not fear death any more."
                                    }

--kill keratur

                                    Kill{
                                        id: "Keratur"
                                        animate: false
                                        fire_event: false
                                    }

                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "Heâ€™s dead. Rest in peace. Oh, what have I done? All our dead kin, desecrated and tormented for eternity."
                                    }

                                    Message{
                                        speaker: "Zhul"
                                        message: _ "As you said yourself, the past is the past, there is nothing you can do now."
                                    }

                                    Message{
                                        speaker: "Nym"
                                        message: _ "Donâ€™t blame yourself. You didnâ€™t know. If we had stayed behind we too would have been killed by the undead; we could not have defended our village against so many. We had no choice."
                                    }

                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "That is small consolation. My deeds have turned to ashes in my mouth. Eloh forgive me. I did not know."
                                    }

                                    Delay{
                                        time: 1000
                                    }

-- Nym asks to be allowed to scout outside

                                    Message{
                                        speaker: "Nym"
                                        message: _ "With your permission, Kaleh, I think I should go scout around a bit outside. We have no idea what lies out there. And I can sneak around unseen many places you canâ€™t."
                                    }

                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "You can go Nym, just be careful."
                                    }

                                    Message{
                                        speaker: "Nym"
                                        message: _ "Iâ€™m always careful. Iâ€™ll be back soon."
                                    }

                                    Store_Unit{
                                        filter: {
                                            id: "Nym"
                                        }
                                        kill: true
                                        variable: "Nymstats"
                                    }

                                    Delay{
                                        time: 500
                                    }

                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "Well, at least we can use this outpost to rally our surviving troops. How many of our people made it out of the caves, Zhul?"
                                    }

                                    Message{
                                        speaker: "Zhul"
                                        message: _ "Weâ€™re still trying to get a head count, but between the underground horrors and the water, we lost quite a few. Recruiting new warriors is going to be even more difficult. Still we should thank Eloh, and you, Kaleh, that so many of us did survive."
                                    }

                                    INCREASE_RECRUIT_COSTS(2)

                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "Well, Nymâ€™s right, we donâ€™t know whatâ€™s out there. So we should set up a perimeter guard around the cave mouth and start discovering what this side of the mountains looks like."
                                    }

                                    Objectives{
                                        summary: _ "New Objectives:"
                                        show: true
                                        objective: {
                                            description: _ "Explore Outside"
                                            condition: "win"
                                        }
                                        objective: {
                                            description: _ "Death of Kaleh"
                                            condition: "lose"
                                        }
                                        objective: {
                                            description: _ "Death of Nym"
                                            condition: "lose"
                                        }
                                        objective: {
                                            description: _ "Death of Zhul"
                                            condition: "lose"
                                        }

                                        gold_carryover: {
                                            bonus: true
                                            carryover_percentage: 40
                                        }
                                    }

                                    Event{
                                        name: "new turn"
                                        do: ->
                                            Fire_Event{
                                                name: "ally_conversation"
                                            }
                                    }

-- change the music playing
                                    Music{
                                        name: "elf-land.ogg"
                                        immediate: true
                                    }

-- remove hero icon from troll/dwarf ally

                                    Remove_Unit_Overlay{
                                        id: ally_name
                                        image: "misc/hero-icon.png"
                                    }
                            }
                    }

                    event: {
                        name: "moveto"

                        filter: {
                            x: "12-20"
                            y: "1-18"
                            side: 1
                            not: {
                                type: {"Dust Devil", "Flesh Golem"}
                            }
                        }
                        do: ->
                            Message{
                                speaker: "unit"
                                message: _ "Look, the tunnel slopes sharply downwards to the left. And itâ€™s big enough that it should divert most of the rising water."
                            }

                            Message{
                                speaker: "unit"
                                message: _ "And I think I see a faint light off to the right."
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "Could it be? Could we actually be almost out of this seemingly never-ending darkness?"
                            }
                    }

-- The conversation between Kaleh and the dwarf/troll ally
-- occurs the turn after the player finds the exit and Keratur dies.
-- Use custom event to clarify structure

                    event: {
                        name: "ally_conversation"
                        do: ->
                            Set_Variable{
                                name: "ally_must_live"
                                value: 0
                            }

                            MESSAGE_DEPEND_ON_ALLY!
                                {
                                    message: {
                                        speaker: "Kaleh"
                                        message: _ "Grog, thank you so much for leading us out of the caves. We never would have found our way without your help. But with the tunnels flooded, how are you going to find your way back to your people?"
                                    }

                                    message: {
                                        speaker: "Grog"
                                        message: _ "Grog proud of little elves too. He would not have made it this far without all your help. Grog is surprised by your bravery and strength."
                                    }

                                    message: {
                                        speaker: "Grog"
                                        message: _ "Truth is that Grog not know much of sunlight lands. Sun and stars are scary, everything is open, exposed, no safe places to hide. But Grog cannot go back through all that water. And Grog doesnâ€™t know where to find other tunnels back to his home. He is as lost as elves are."
                                    }

                                    message: {
                                        speaker: "Grog"
                                        message: _ "But Grog not afraid. Great leader told Grog to guide and protect elves, and Grog will keep his oath. Grog will follow elves wherever they may go and protect them from danger as best he can. Maybe later, Grog will find another way back down to the caves of his people. But for now, Grog will continue to serve and protect you."
                                    }
                                }
                                {
                                    message: {
                                        speaker: "Kaleh"
                                        message: _ "Nog, thank you so much for leading us out of the caves. We never would have found our way without your help. But with the tunnels flooded, how are you going to find your way back to your people?"
                                    }

                                    message: {
                                        speaker: "Nog"
                                        message: _ "Nog proud of little elves too. He would not have made it this far without all your help. Nog is surprised by your bravery and strength."
                                    }

                                    message: {
                                        speaker: "Nog"
                                        message: _ "Truth is that Nog not know much of sunlight lands. Sun and stars are scary, everything is open, exposed, no safe places to hide. But Nog cannot go back through all that water. And Nog doesnâ€™t know where to find other tunnels back to his home. He is as lost as elves are."
                                    }

                                    message: {
                                        speaker: "Nog"
                                        message: _ "But Nog not afraid. Great leader told Nog to guide and protect elves, and Nog will keep his oath. Nog will follow elves wherever they may go and protect them from danger as best he can. Maybe later, Nog will find another way back down to the caves of his people. But for now, Nog will continue to serve and protect you."
                                    }
                                }
                                {
                                    message: {
                                        speaker: "Kaleh"
                                        message: _ "Rogrimir, I want to thank you so much for guiding us out of the caves. We never would have found our way without your help. But with the tunnels flooded, how are you going to find your way back to your people?"
                                    }

                                    message: {
                                        speaker: "Rogrimir"
                                        message: _ "Och, it is I who should be congratulating you, laddie. I showed you the way, but it was you and your people who defeated the many perils and obstacles to your escape. In all my years such bravery and courage I have rarely seen."
                                    }

                                    message: {
                                        speaker: "Rogrimir"
                                        message: _ "But truly I cannot return the way I came and even if there are other tunnels which lead back down to my homeland, I do not know where to search for them. I know as little about the land above ground as you do."
                                    }

                                    message: {
                                        speaker: "Rogrimir"
                                        message: _ "But my king told me to protect you from all dangers, and I plan to keep that oath. I do not like the above ground, it is too open and exposed; I feel that I could be attacked from any direction. But an oath is an oath and so I will follow you and your people wherever you may go and protect you as best I can. The tunnels cannot stay flooded forever; later perhaps if am able to return this way, I may be able to find my way back to my homeland. But for now I am yours to command."
                                    }
                                }
                                {
                                    message: {
                                        speaker: "Kaleh"
                                        message: _ "Jarl, I want to thank you so much for guiding us out of the caves. We never would have found our way without your help. But with the tunnels flooded, how are you going to find your way back to your people?"
                                    }

                                    message: {
                                        speaker: "Jarl"
                                        message: _ "Och, it is I who should be congratulating you, laddie. I showed you the way, but it was you and your people who defeated the many perils and obstacles to your escape. In all my years such bravery and courage I have rarely seen."
                                    }

                                    message: {
                                        speaker: "Jarl"
                                        message: _ "But truly I cannot return the way I came and even if there are other tunnels which lead back down to my homeland, I do not know where to search for them. I know as little about the land above ground as you do."
                                    }

                                    message: {
                                        speaker: "Jarl"
                                        message: _ "But my king told me to protect you from all dangers, and I plan to keep that oath. I do not like the above ground, it is too open and exposed; I feel that I could be attacked from any direction. But an oath is an oath and so I will follow you and your people wherever you may go and protect you as best I can. The tunnels cannot stay flooded forever; later perhaps if am able to return this way, I may be able to find my way back to my homeland. But for now I am yours to command."
                                    }
                            })

                            Message{
                                speaker: "Kaleh"
                                message: _ "Your loyalty is a credit to your people. I am glad indeed to have you fighting by my side."
                            }
                    }

-- This rather long macro ensures that if Kaleh is asked to come up next to
-- the unit that fires the event he doesn't appear in a cave wall. Instead
-- the macro finds an empty hex next to the unit. Since this event fires
-- the first time any unit moves into target area, I am sure there will
-- be an empty spot adjacent to the unit.

-- Event 14.5 Player discovers humanâ€™s chest of gold at cave mouth

                    event: {
                        name: "moveto"

                        filter: {
                            x: 17, y: 21
                            side: 1
                            not: {
                                type: {"Dust Devil", "Flesh Golem"}
                            }
                        }
                        do: ->
                            PLACE_IMAGE("items/chest-plain-open.png", 17, 21)

                            Sound{
                                name: "gold.ogg"
                            }

                            Message{
                                speaker: "unit"
                                message: _ "Looks like the guards at this outpost had been saving away a bit of loot. I donâ€™t suppose theyâ€™re going to mind anymore if we made use of it."
                            }

-- Modify gold as though the scenario had ended (multiply by 0.4 then add new award)
-- However, ensure that players receive at least 50 gold if they are doing well
-- This reduces the tomato surprise aspect of adding a fight at the end and
-- reduces the reward that careful players will receive, making it slightly harder for them
                            Store_Gold{
                                side: 1
                                variable: "gold_amount"
                            }
                            If{
                                variable: {
                                    name: "gold_amount"
                                    greater_than: 0
                                }
                                then: ->
                                    Set_Variable{
                                        name: "gold_amount"
                                        multiply: -0.6
                                    }
                                    Set_Variable{
                                        name: "gold_amount"
                                        round: "floor"
                                    }
                                
                                else: ->
                                    Set_Variable{
                                        name: "gold_amount"
                                        multiply: -1
                                    }
                                
                            }
                            Set_Variable{
                                name: "gold_amount"
                                add: ON_DIFFICULTY(125, 100, 100)
                            }
                            If{
                                variable: {
                                    name: "gold_amount"
                                    less_than: 50
                                }
                                then: ->
                                    VARIABLE("gold_amount", 50)
                                
                            }

                            Gold{
                                amount: gold_amount
                                side: 1
                            }
                            CLEAR_VARIABLE("gold_amount")
                    }

-- Event 15: Elves step out into the daylight, Eloh appears

-- asks for Kaleh, he goes outside, conversation ensues
-- human leader rides up, talks, leaves

                    event: {
                        name: "moveto"

--event should only fire when unit steps several hexes out into the dunes

                        filter: {
                            x: "25-50"
                            y: "19-31"
                            side: 1
                            not: {
                                type: {"Dust Devil", "Flesh Golem"}
                            }
                        }
                        do: ->
                            If{
                                have_unit: {
                                    x: x1, y: y1
                                    race: "elf"
                                }

                                then: ->
                                    Message{
                                        speaker: "unit"
                                        message: _ "Praise Eloh, it is so good to be outside again. To see the sky stretching out above me, to feel the wind in my face..."
                                    }
                                
                            }

                            If{
                                have_unit: {
                                    x: x1, y: y1
                                    id: ally_name
                                }

                                then: ->
                                    MESSAGE_DEPEND_ON_ALLY!
                                        {
                                            message: {
                                                speaker: "unit"
                                                message: _ "We made it. Outside look strange to Grog, Grog not used to big open spaces."
                                            }
                                        }
                                        {
                                            message: {
                                                speaker: "unit"
                                                message: _ "We made it. Outside look strange to Nog, Nog not used to big open spaces."
                                            }
                                        }
                                        {
                                            message: {
                                                speaker: "unit"
                                                message: _ "I think we finally made it outside. Iâ€™d forgotten how big the sky is and how windy it can be."
                                            }
                                        }
                                        {
                                            message: {
                                                speaker: "unit"
                                                message: _ "I think we finally made it outside. Iâ€™d forgotten how big the sky is and how windy it can be."
                                            }
                                    })
                                
                            }

--from an elf still in the cave
                            Message{
                                x: "12-23", y: "15-20"
                                side: 1
                                race: "elf"
                                message: _ "Can you see very far? Do you have any idea where we are?"
                            }

                            Message{
                                speaker: "unit"
                                message: _ "Weâ€™ve come out on the side of a mountain, overlooking a large valley. The land seems to be much the same as the foothills south of the mountains. The valley is filled with sand dunes, though the center is flat. There seems to be some sort of settlement in the center of the valley. And far to the north I can see something sparkling on the horizon, but I donâ€™t know what it is."
                            }

--reveal most of the valley to player

--central corridor
                            Remove_Shroud{
                                x: "26-49"
                                y: "0-30"
                                side: 1
                            }

--NW cave wall right above unit
                            Remove_Shroud{
                                x: "25-31"
                                y: "19-20"
                                side: 1
                            }

--SW edge of valley, southern cave wall near player

                            Remove_Shroud{
                                x: {"21-31", "23-31", "25-31"}
                                y: {27, 28, 29}
                                side: 1
                            }

--South and SE edge of valley
                            Remove_Shroud{
                                x: {"48-56", "48-54", "48-53", "48-51", "27-49", "29-31", "35-47"}
                                y: {"17-26", 27, 28, "29-30", 31, 32, 32}
                                side: 1
                            }

--eloh appears

                            NAMED_UNIT(2, "Divine Avatar", 30, 22, "Eloh", _ "Eloh", {
                                    upkeep: "free"
                                    facing: "sw"
                                    profile: "portraits/eloh.png"
                            })

                            If{
                                variable: {
                                    name: "unit.id"
                                    not_equals: "Kaleh"
                                }

                                then: ->
--if Kaleh isn't the unit moving outside then Eloh calls for him

                                    Message{
                                        speaker: "Eloh"
                                        message: _ "Kaleh, Kaleh, come to me."
                                    }

                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "What is the voice? It sounds so familiar."
                                    }

                                    Message{
                                        speaker: "Eloh"
                                        message: _ "Come out so that I might see you. Your god calls to you."
                                    }

                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "Am I dreaming? Is this real? Iâ€™m coming, Iâ€™m coming."
                                    }

                                    Teleport{
                                        filter: {
                                            id: "Kaleh"
                                        }
                                        x: 25, y: 23
                                    }
                                

                                else: ->
                                    Message{
                                        speaker: "Eloh"
                                        message: _ "Hail Kaleh, it is I, Eloh."
                                    }
                                
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "But I am not asleep? And yet I can see you? How is this possible?"
                            }

                            Message{
                                speaker: "Eloh"
                                message: _ "Do you doubt my powers? You have come out of the darkness, and I appear unto you to congratulate you."
                            }

-- if kaleh didn't go outside first, the unit who did asks kaleh who is
-- is talking to. Otherwise Zhul asks him.

                            If{
                                variable: {
                                    name: "unit.id"
                                    not_equals: "Kaleh"
                                }

                                then: ->
                                    Message{
                                        speaker: "unit"
                                        message: _ "Kaleh, who are you talking to?"
                                    }

                                    Message{
                                        speaker: "Eloh"
                                        message: _ "For now, I appear only to you, for you, Kaleh, are special, you are the Chosen One."
                                    }

                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "#{unit.name}, be quiet, Iâ€™ll explain it all later."
                                    }
                                

                                else: ->
                                    Message{
                                        speaker: "Zhul"
                                        message: _ "Kaleh, who are you talking to?"
                                    }

                                    Message{
                                        speaker: "Eloh"
                                        message: _ "For now, I appear only to you, for you, Kaleh, are special, you are the Chosen One."
                                    }

                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "Be quiet Zhul, Iâ€™ll explain it all later."
                                    }
                                
                            }

                            Message{
                                speaker: "Eloh"
                                message: _ "Yes, I have chosen you as the one to lead my people out of danger and death and into a life of eternal salvation. Crossing under the mountains was a very important step, and your destruction of the unbelievers proves yourâ€”"
                            }

--troll/dwarf ally teleports to just outside of cave

                            Teleport{
                                filter: {
                                    id: ally_name
                                }
                                x: 21, y: 23
                            }

                            Message{
                                speaker: ally_name
                                message: _ "Kaleh, a quick questionâ€”"
                            }

                            MESSAGE_DEPEND_ON_ALLY!
                                {
                                    message: {
                                        speaker: "Kaleh"
                                        message: _ "Not now Grog, Iâ€™m busy."
                                    }
                                }
                                {
                                    message: {
                                        speaker: "Kaleh"
                                        message: _ "Not now Nog, Iâ€™m busy."
                                    }
                                }
                                {
                                    message: {
                                        speaker: "Kaleh"
                                        message: _ "Not now Rogrimir, Iâ€™m busy."
                                    }
                                }
                                {
                                    message: {
                                        speaker: "Kaleh"
                                        message: _ "Not now Jarl, Iâ€™m busy."
                                    }
                            })

                            Message{
                                speaker: "Eloh"
                                message: _ "Whatâ€™s this? You did not kill the unbelievers?!"
                            }

                            If{
                                variable: {
                                    name: "ally_race"
                                    equals: "dwarf"
                                }

                                then: ->
                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "I am sorry I could not have fulfilled your command, but we found ourselves in the middle of a war. We were vastly outnumbered and we needed help. In fact the dwarves have been very helpful. They helped protect us from the trolls and without their guidance we would not have made it out of the caves alive."
                                    }
                                

                                else: ->
                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "I am sorry I could not have fulfilled your command, but we found ourselves in the middle of a war. We were vastly outnumbered and we needed help. In fact the trolls have been very helpful. They helped protect us from the dwarves and without them we would not have made it out of the caves alive."
                                    }
                                
                            }

                            Message{
                                speaker: "Eloh"
                                message: _ "You were weak and foolish, but I forgive you. You must remember, Kaleh, that without my guidance, your people would have died out years ago. I am your god, and you must follow my every command."
                            }

                            Message{
                                speaker: "Eloh"
                                message: _ "Now, in the valley live a group of humans who have also seen the light. They may seem strange, but they are my obedient followers. You must trust them, they will show you the way north. Follow them and they will lead you to me."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "What do you mean â€˜lead you to meâ€™? You are a god, donâ€™t you exist everywhere? I thought you were going to show us our new home."
                            }

                            Message{
                                speaker: "Eloh"
                                message: _ "Of course I am. Oh, how little you understand. Do not worry yourself with all those tiny questions. Come to me and all will be made clear."
                            }

                            Delay{
                                time: 100
                            }

-- wmllint: directory spelling Durstrag
                            NAMED_UNIT(2, "Human Commander", 30, 25, "Sergeant Durstrag", _ "Sergeant Durstrag", {facing: "nw"})
                            NAMED_UNIT(2, "Dragoon", 31, 25, {}, _ "Human Guard", {facing: "nw"})
                            NAMED_UNIT(2, "Dragoon", 31, 26, {}, _ "Human Guard", {facing: "nw"})
                            NAMED_UNIT(2, "Swordsman", 30, 24, {}, _ "Human Guard", {facing: "nw"})
                            NAMED_UNIT(2, "Longbowman", 30, 26, {}, _ "Human Guard", {facing: "nw"})

                            Message{
                                speaker: "Sergeant Durstrag"
                                message: _ "I saw the distress signal from the outpost on the bluff. Who in the Dark Ladyâ€™s name are you and what have you done with my men?"
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "My name is Kaleh, and these are my people. We come from the south and unfortunately we found your men deadâ€”"
                            }

                            Message{
                                speaker: "Sergeant Durstrag"
                                message: _ "Dead?! You â€˜foundâ€™ them you say? Youâ€™ll pardon me if I donâ€™t take you at your word. We havenâ€™t seen elves for generations, but we remember your ancient betrayal. What are elves doing sneaking up through the caves out onto our back doorstep?"
                            }

                            Message{
                                speaker: ally_name
                                message: _ "Well, actually they were fleeing fromâ€”"
                            }

                            If{
                                variable: {
                                    name: "ally_race"
                                    equals: "troll"
                                }

                                then: ->
                                    Message{
                                        speaker: "Sergeant Durstrag"
                                        message: _ "A troll! This just gets better and better. We havenâ€™t seen one of your kind up here for many years, but I have a long memory. I still remember the troll raids when I was a youth."
                                    }
                                

                                else: ->
                                    Message{
                                        speaker: "Sergeant Durstrag"
                                        message: _ "A dwarf! This just gets better and better. We havenâ€™t seen one of your kind up here for many years, but we have long memories. I remember how your â€˜tradersâ€™ used to come up and cheat us out of our valuables. Youâ€™ll find weâ€™re not so easy to fool this time."
                                    }
                                
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "Look, if youâ€™ll just let me explainâ€”"
                            }

                            If{
                                variable: {
                                    name: "ally_race"
                                    equals: "troll"
                                }

                                then: ->
                                    Message{
                                        speaker: "Sergeant Durstrag"
                                        message: _ "Oh there is no need to explain, itâ€™s pretty obvious what youâ€™re up to. Here we have a whole legion of elves, consorting with trolls, sneaking up behind our defenses. This looks an awful lot like an invasion to me."
                                    }
                                

                                else: ->
                                    Message{
                                        speaker: "Sergeant Durstrag"
                                        message: _ "Oh thereâ€™s no need to explain, itâ€™s pretty obvious what youâ€™re up to. Here we have a whole legion of elves, consorting with dwarves, sneaking up behind our defenses. This looks an awful lot like an invasion to me."
                                    }
                                
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "No, no. You donâ€™t understand! We were told you could help us."
                            }

                            Message{
                                side: 2
                                type: "Swordsman"
                                message: _ "Sir, remember the edict passed down by councilman Noblis? About any foreigners spotted on the borders?"
                            }

                            Message{
                                speaker: "Sergeant Durstrag"
                                message: _ "I have no idea what youâ€™re babbling about, elf, but youâ€™re just lucky you caught me on a good day. You get to explain everything to the Iron Council. Now you and your people just lay down your weapons and we will take you into custody to be judged. Theyâ€™ll deal with you as they see fit."
                            }

                            Message{
                                speaker: "Eloh"
                                message: _ "Everything will be fine. Do as he says."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "I am my own master. I will not be ordered around, not even by you, Eloh."
                            }

                            Message{
                                speaker: "Sergeant Durstrag"
                                message: _ "Whatâ€™s that, boy? Are you talking back to me? This isnâ€™t a negotiation. You are on my land, and under my jurisdiction. Lay down your weapons and submit peacefully or Iâ€™ll make you sorry you didnâ€™t."
                            }

                            Message{
                                speaker: "Eloh"
-- wmllint: local spelling Ishtar
                                message: _ "Kaleh, I am Eloh, bearer of the staff of Ishtar and slayer of the demon-god Zhangor. Do as I say! Submit to him or I will abandon your people to suffering and death. Your bones will litter the sand dunes, and vultures shall pick at your flesh. I am not a forgiving god, Kaleh."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "Then kill me if you must, but I will not give myself over to those who threaten me and my people. I have not come through peril and darkness just to surrender to a man such as you."
                            }

                            Message{
                                speaker: "Sergeant Durstrag"
                                message: _ "Your dare defy me?! All who refuse to submit to the authority of the Iron Council shall be killed. By the Dark Lady, I shall not put up with this bickering any longer. To battle, men! Drive those heathens back into the caves!"
                            }

-- Move Durstag and his guards back to human base

                            Kill{
                                side: 2
                                not: {
                                    id: "Eloh"
                                }
                                animate: false
                                fire_event: false
                            }

                            Unit{
                                type: "Human Commander"
                                id: "Sergeant Durstrag"
                                name: _ "Sergeant Durstrag"
                                canrecruit: true
                                x: 44
                                y: 27
                                side: 2
                                modifications: {
                                    <TRAIT_INTELLIGENT!
                                    <TRAIT_RESILIENT!
                                }
                            }

                            NAMED_NOTRAIT_UNIT(2, "Dragoon", 43, 28, {}, _ "Human Guard")
                            NAMED_NOTRAIT_UNIT(2, "Dragoon", 44, 26, {}, _ "Human Guard")
                            NAMED_NOTRAIT_UNIT(2, "Swordsman", 43, 27, {}, _ "Human Guard")
                            NAMED_NOTRAIT_UNIT(2, "Longbowman", 44, 27, {}, _ "Human Guard")

                            Message{
                                speaker: "Eloh"
                                message: _ "You disappoint me, Kaleh. You are weak, and not worthy of my guidance. Do what you will, but this is not over. You may be the appointed leader of your people but I am your god, and I will not let you usurp my authority."
                            }

                            Kill{
                                id: "Eloh"
                                animate: false
                                fire_event: false
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "You are not the god I grew up with. You may be all-powerful, but I will not be your puppet. I am still their leader and as long as I draw breath I will do what I think is best for my people."
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "Kaleh, would you mind telling me what in Uriaâ€™s name is going on."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "Thereâ€™s no time. Right now we have to prepare ourselves for another battle. Iâ€™d better head back to the outpost and rally our troops. I fear a whole lot of hurt is going to be coming up through those hills very soon."
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "Well, now weâ€™re really in for it. I hope you know what youâ€™re doing, Kaleh."
                            }

                            Teleport{
                                filter: {
                                    id: "Kaleh"
                                }
                                x: 18, y: 19
                            }

                            MESSAGE_DEPEND_ON_ALLY!
                                {
                                    message: {
                                        speaker: "Grog"
                                        message: _ "Grog no like humans either. They mean. But they sound great when they go squish."
                                    }
                                }
                                {
                                    message: {
                                        speaker: "Nog"
                                        message: _ "Nog no like humans either. They mean. But they sound great when they go squish."
                                    }
                                }
                                {
                                    message: {
                                        speaker: "Rogrimir"
                                        message: _ "I never liked humans much anyway. Iâ€™ll be glad to be fighting something besides undead."
                                    }
                                }
                                {
                                    message: {
                                        speaker: "Jarl"
                                        message: _ "I never liked humans much anyway. Iâ€™ll be glad to be fighting something besides undead."
                                    }
                            })

                            Modify_Side{
                                side: 2
                                <INCOME(9, 11, 13)
                                <GOLD(150, 150, 175)
                            }

--capture some of the nearby villages
                            Capture_Village{
                                x: "34-37", y: "25-26"
                                side: 2
                            }

                            Capture_Village{
                                x: "41-43", y: "19-23"
                                side: 2
                            }

                            Objectives{
                                summary: _ "New Objectives:"
                                show: true
                                objective: {
                                    description: _ "Defeat Sergeant Durstrag"
                                    condition: "win"
                                }
                                objective: {
                                    description: _ "Death of Kaleh"
                                    condition: "lose"
                                }
                                objective: {
                                    description: _ "Death of Nym"
                                    condition: "lose"
                                }
                                objective: {
                                    description: _ "Death of Zhul"
                                    condition: "lose"
                                }

                                gold_carryover: {
                                    bonus: true
                                    carryover_percentage: 40
                                }
                            }

                            Event{
                                name: "new turn"
                                do: ->
                                    Fire_Event{
                                        name: "nym_return"
                                    }
                            }

-- change the music playing
                            Music{
                                name: "loyalists.ogg"
                                immediate: true
                            }
                    }

-- Event 16: Nym returns

-- Next turn after big Eloh/Durstrag conversation, Nym returns and
-- tells Kaleh that Durstrag plans to send for reinforcements

                    event: {
                        name: "nym_return"
                        do: ->
                            Store_Unit{
                                filter: {
                                    id: "Kaleh"
                                }
                                variable: "kaleh_location"
                                kill: false
                            }

                            Unstore_Unit{
                                variable: "Nymstats"
                                find_vacant: true
                                check_passability: true
                                x: kaleh_location.x
                                y: kaleh_location.y
                            }

                            CLEAR_VARIABLE("Nymstats,kaleh_location")

                            Message{
                                speaker: "Nym"
                                message: _ "Iâ€™m back, Kaleh."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "Ah! You scared me, Nym. I didnâ€™t hear you coming."
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "Of course you didnâ€™t. Thatâ€™s why itâ€™s called sneaking."
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "Anyway youâ€™ve really gotten us into a mess. The good news is that the outpost isnâ€™t guarded as heavily as you might think. The garrison seems only half-manned. They obviously didnâ€™t expect any serious attack to come from this direction."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "And whatâ€™s the bad news?"
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "The bad news is that I overheard the commander ordering a special group of his men to get ready to ride north and summon reinforcements. It seems that the humans have a bigger village to the north. This outpost is lightly guarded enough that we might be able to defeat them, but in our weakened state if they bring the full strength of their army against us I fear we may be crushed."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "Then weâ€™ll just have to make sure that no messenger escapes this valley to summon reinforcements."
                            }

                            Objectives{
                                summary: _ "New Objectives:"
                                show: true
                                objective: {
                                    description: _ "Defeat Sergeant Durstrag"
                                    condition: "win"
                                }
                                objective: {
                                    description: _ "If a human messenger escapes the valley"
                                    condition: "lose"
                                }
                                objective: {
                                    description: _ "Death of Kaleh"
                                    condition: "lose"
                                }
                                objective: {
                                    description: _ "Death of Nym"
                                    condition: "lose"
                                }
                                objective: {
                                    description: _ "Death of Zhul"
                                    condition: "lose"
                                }

                                gold_carryover: {
                                    bonus: true
                                    carryover_percentage: 40
                                }

                                note: {
                                    description: _ "The messenger is the leader of the special white colored units"
                                }
                            }

--set messenger timer at 2, so first messenger goes in 6,5,4 turns

                            Set_Variable{
                                name: "messenger_timer"
                                value: 2
                            }

-- schedule events that occur after the humans start fighting
                            Event{
                                name: "new turn"

                                filter_condition: {
-- The first night after meeting the humans
                                    have_location: {
                                        x: 44, y: 27 -- location of Sgt Durstrag's keep - should be in normal time
                                        time_of_day_id: {"dusk1", "dusk2", "short_dark", "long_dark1", "long_dark2", "long_dark3", "long_dark4"}
                                    }
                                }
                                do: ->
                                    Fire_Event{
                                        name: "undead_emissary"
                                    }
                            }

                            Event{
                                name: "new turn"
                                first_time_only: false
                                do: ->
                                    If{
                                        variable: {
                                            name: "messenger_timer"
                                            numerical_equals: 1
                                        }

                                        then: ->
                                            Fire_Event{
                                                name: "human_conversation"
                                            }
                                        
                                    }

                                    Fire_Event{
                                        name: "messengers"
                                    }
                            }
                    }

-- Event 17: Undead Emissary

                    event: {
                        name: "undead_emissary"
                        do: ->
                            Move_Unit_Fake{
                                type: "ENightgaunt"
                                side: 5
                                x: {34, 35, 36, 36, 35}
                                y: {32, 32, 31, 30, 30}
                            }

                            NAMED_UNIT(5, "ENightgaunt", 35, 30, "Undead Emissary", _ "Undead Emissary", {})

                            Message{
                                speaker: "Undead Emissary"
                                message: _ "Cursed elves, you tracked your filth through our halls and you defiled our sanctuary. You have besmirched our honor, and we will have our revenge. We are the Order of the Crimson Talon, and even death shall not stop us. You shall rue the day that you ever trespassed into our lair!"
                            }

                            Kill{
                                id: "Undead Emissary"
                                animate: false
                            }

                            Move_Unit_Fake{
                                type: "ENightgaunt"
                                side: 5
                                x: {35, 35, 35, 35}
                                y: {30, 31, 32, 33}
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "Canâ€™t the dead ever just stay dead? And arenâ€™t they trapped by the flooded tunnels and caves?"
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "Undead donâ€™t have to breathe and I donâ€™t think a little water is going to stop them. Besides, you saw how the ghost just flew through the rock; if they can move through walls then what do they care about flooded tunnels?"
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "Great. So now weâ€™re fighting in a haunted valley."
                            }

                            Modify_Side{
                                side: 5
                                <INCOME(9, 11, 13)
                                <GOLD(100, 125, 150)
                            }

                            Unit{
                                type: "Spectre"
                                id: "Undead Leader"
                                name: _ "Undead Leader"
                                canrecruit: true
                                side: 5
                                x: 28
                                y: 37
                            }
                    }

--Event 17.5 A conversation about the humans

                    event: {
                        name: "human_conversation"
                        do: ->
                            Message{
                                speaker: "Kaleh"
                                message: _ "I donâ€™t understand. What are these humans doing here? Iâ€™ve never seen so many in one place before."
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "Humans arenâ€™t just the bandits and outlaws youâ€™re familiar with from the deserts, Kaleh. Remember that long ago the great human empire of Wesnoth spread all across the known lands. Some of our people say that it was the humans who brought the Great Fall upon us. But to blame others is folly. Eloh says that it was not the darkness without, but the darkness within us that was the cause of our corruption and downfall."
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "But now is not a time for preaching. Humans once spread to many lands, and despite all the ravages of time, I have no doubt that at least a few of them have survived. They are a hardy people and quickly adapt to new conditions. I only wish that the same could be said of our brethren."
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "There might be other elves somewhere. We canâ€™t be sure."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "No, we canâ€™t. But for now we must deal with the problem at hand. Thank you for the information, Zhul; these humans are good fighters but they are no match for our speed and skill. I grew up fighting in dunes such as these, and I will not be bested by a bunch of ruffians."
                            }
                    }

-- Event 18: Sending for Reinforcements

-- EASY: 1 dragoon, 2 cavalryman, 2 spearmen
-- NORMAL: 1 dragoon, 2 cavaliers, 1 javelineer, 1 longbowman
-- HARD: 3 dragoons, 1 swordsman, 1 longbowman

-- EASY: once every 8 turns
-- NORMAL: once every 7 turns
-- HARD: once every 6 turns

                    event: {
                        name: "messengers"
                        first_time_only: false

-- timer to store when to send off a human messenger
                        do: ->
                            Set_Variable{
                                name: "messenger_timer"
                                add: 1
                            }

                            If{
                                variable: {
                                    name: "messenger_timer"
                                    numerical_equals: ON_DIFFICULTY(8, 7, 6)
                                }

                                then: ->
                                    Set_Variable{
                                        name: "messenger_timer"
                                        value: 0
                                    }

                                    Message{
                                        speaker: "Sergeant Durstrag"
                                        message: _ "Send forth the messenger and his escort. Go north and bring help as soon as possible!"
                                    }

                                    Set_Variable{
                                        name: "loc_x"
                                        rand: "44..51"
                                    }

                                    Set_Variable{
                                        name: "loc_y"
                                        rand: "23..25"
                                    }

                                    Unit{
                                        type: "Dragoon"
                                        id: "messenger"
                                        name: _ "Human Messenger"
                                        canrecruit: true
                                        x: loc_x
                                        y: loc_y
                                        side: 8
                                    }

                                    Unit{
                                        type: ON_DIFFICULTY("(Cavalryman)", "(Cavalier)", "(Dragoon)")
                                        name: _ "Human Escort"
                                        upkeep: "free"
                                        x: loc_x
                                        y: loc_y
                                        side: 8
                                    }

                                    Unit{
                                        type: ON_DIFFICULTY("(Cavalryman)", "(Cavalier)", "(Dragoon)")
                                        name: _ "Human Escort"
                                        upkeep: "free"
                                        x: loc_x
                                        y: loc_y
                                        side: 8
                                    }

                                    Unit{
                                        type: ON_DIFFICULTY("(Spearman)", "(Javelineer)", "(Swordsman)")
                                        name: _ "Human Escort"
                                        upkeep: "free"
                                        x: loc_x
                                        y: loc_y
                                        side: 8
                                    }

                                    Unit{
                                        type: ON_DIFFICULTY("(Spearman)", "(Longbowman)", "(Master", "Bowman)")
                                        name: _ "Human Escort"
                                        upkeep: "free"
                                        x: loc_x
                                        y: loc_y
                                        side: 8
                                    }

                                    Message{
                                        speaker: "Kaleh"
                                        message: _ "If that messenger escapes the valley, weâ€™ll be in trouble. We have to stop him!"
                                    }

                                    CLEAR_VARIABLE("loc_x")
                                    CLEAR_VARIABLE("loc_y")

-- Set up the Messenger Escort Micro AI
                                    Micro_Ai{
                                        side: 8
                                        ai_type: "messenger_escort"
                                        action: "add"

                                        id: "messenger"
                                        waypoint_x: 42, waypoint_y: 1
                                    }
                                
                            }
                    }

-- Event 18.5: Messenger Dies

                    event: {
                        name: "last breath"
                        first_time_only: false

                        filter: {
                            id: "messenger"
                        }
                        do: ->
                            Message{
                                speaker: "messenger"
                                message: _ "No! I must get help!"
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "Good. Weâ€™re safe for now. We just have to defeat Durstrag before he sends another messenger for reinforcements."
                            }

-- Remaining units of the messenger side must remain active
                            Modify_Ai{
                                side: 8
                                action: "add"
                                path: "goal"
                                goal: {
                                    criteria: {
                                        side: 1
                                    }
                                    value: 10
                                }
                            }
                    }

-- Event 19: Messenger Escapes!

                    event: {
                        name: "moveto"

                        filter: {
                            side: 8
                            id: "messenger"
                            y: 1
                        }
                        do: ->
                            Kill{
                                id: "messenger"
                                animate: false
                                fire_event: false
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "The messenger has escaped! He will surely return with reinforcements. We are doomed!"
                            }

                            Endlevel{
                                result: "defeat"
                            }
                    }

-- Event 20: Defeat of Sergeant Durstrag

                    event: {
                        name: "last breath"

                        filter: {
                            id: "Sergeant Durstrag"
                        }
                        do: ->
                            Message{
                                speaker: "Kaleh"
                                message: _ "Donâ€™t worry. Weâ€™re not the monsters you seem to think we are. I will not kill you in cold blood."
                            }

                            Message{
                                speaker: "Sergeant Durstrag"
                                message: _ "Faugh, boy, you know nothing! There are fates worse than death."
                            }

                            Kill{
                                id: "Sergeant Durstrag"
                                animate: true
                                fire_event: false
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "He killed himself rather than surrender to us!"
                            }

                            Message{
                                side: 2
                                message: _ "They killed Sergeant Durstrag! Run for your lives!"
                            }

                            Kill{
                                side: 2
                                animate: false
                                fire_event: false
                            }

                            Kill{
                                side: 5
                                animate: false
                                fire_event: false
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "The rest of the humans are fleeing."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "Let them go. We have won this battle and I am weary of all this bloodshed."
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "What was it that the human Durstrag was so afraid of?"
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "I donâ€™t know, but I fear we may find out."
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "Youâ€™re being very cryptic, Kaleh. Now that the battle is over would you care to explain to us who you were talking to back when we first met the humans?"
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "No, not yet."
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "Whatâ€™s wrong, Kaleh? Donâ€™t you trust us?"
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "Yes, yes of course I do. But itâ€™s just a theory. I donâ€™t want to say more until I have proof. Give me until tomorrow night, then Iâ€™ll tell you everything."
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "Very well. Iâ€™ve trusted your decisions and your leadership so far; Iâ€™ll wait a little longer."
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "So what do we do now? The land seems to be about the same on the northern side of the mountains as it was on the south. And we canâ€™t hang around here forever. The humans will be back with reinforcements eventually, and the valley is still haunted with undead."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "Yes, I think the sooner we leave this valley the better. But we donâ€™t know anything about the surrounding terrain. Without anyone to guide us, we have no idea what perils may be nearby. I donâ€™t like sending our people across foreign lands when I donâ€™t know whatâ€™s in front of us. Weâ€™ve lost too many people already. I donâ€™t want to lead us into a trap."
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "When I was scouting around I think I saw a small oasis near the entrance to this valley. If we move out there we should be out of range of the undead. I think it would be safe, at least for the short term."
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "Indeed. Undead ghosts such as these are often bound to the places they died: the farther away they travel, the weaker they are. So if we move out of the immediate vicinity we should be pretty safe."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "Good, weâ€™ll move our people out and camp by the oasis. Now, Nym, you know who our best scouts are; I want you to lead a few elves to do some reconnaissance. Weâ€™ll send out small groups of scouts to the north, northeast and northwest. Donâ€™t go too far, try not to be seen, and please donâ€™t do anything dangerous. But I want to know whatâ€™s out there."
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "But hasnâ€™t Eloh told you where to go and what dangers you face?"
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "She was... rather vague. I know weâ€™re supposed to generally go north, but I want more information before I commit us to a direction."
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "Donâ€™t you worry about us, Kaleh. Weâ€™ll be careful. Iâ€™ll organize five bands to scout out the nearby lands. We should be back in about half a day."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "Good, until then weâ€™ll settle around that oasis and set up as good a defense as we can. Until I know whatâ€™s out there, Iâ€™m not taking any chances."
                            }

                            Endlevel{
                                result: "victory"
                                bonus: true
                                <NEW_GOLD_CARRYOVER(40)
                            }
                    }

-- Flooding algorithm

-- At the end of each turn:

-- Turn shallow water hexes to deep water and
-- Turn all cave tiles within one hex of water to shallow water

-- Step by Step Process:
-- 1. change all shallow water hexes to deep water
-- 2. change all hexes adjacent to water to shallow water
-- 3. destroy any items in the new deep water
-- 4. kill any units in deep water

                    event: {
                        name: "new turn"
                        id: "do_flooding"
                        first_time_only: false

                        filter_condition: {
-- don't flood before first turn
                            variable: {
                                name: "turn_number"
                                greater_than: 1
                            }
                        }
                        do: ->
                            Store_Locations{
                                terrain: "Ww*"
-- some pools outside of the cave mustn't be turned to deep water.
                                not: {
                                    x: {35, 35, 36, 42, 42, 43, 43, 60, 60, 61, 61, 62}
                                    y: {25, 26, 25, 20, 21, 21, 22, 4, 5, 4, 5, 5}
                                }
                                variable: "shallow_to_deep_locs"
                            }

                            Terrain{
                                terrain: "Wwg"

                                filter_adjacent_location: {
                                    find_in: "shallow_to_deep_locs"
                                }
                                and: {
                                    terrain: {"!", "Xu", "M*^Xm", "Md", "W*"}
                                }
                            }

                            Terrain{
                                terrain: "Wo"
                                find_in: "shallow_to_deep_locs"
                            }

                            Remove_Item{
                                find_in: "shallow_to_deep_locs"
                            }

                            Fire_Event{
                                name: "kill_submerged_units"
                            }

                            Fire_Event{
                                name: "check_flood_end"
                            }

                            CLEAR_VARIABLE("shallow_to_deep_locs")
                    }

-- Killing of units who ended up in deep water
                    event: {
                        name: "kill_submerged_units"
                        first_time_only: false
                        do: ->
                            Store_Unit{
                                filter: {
                                    filter_location: {
                                        terrain: "Wo*"
                                    }

-- Only units which cannot move in deep water can drown
                                    movement_cost: 99
                                }

                                kill: false
                                variable: "drowning_units"
                            }

                            Redraw{
                            }

-- If at least one side 1 unit died then display a death message
                            Message{
                                find_in: "drowning_units"
                                side: 1
                                not: {
                                    type: {"Dust Devil", "Flesh Golem"}
                                }

                                message: _ "Help, Iâ€™m drowning!"
                            }

                            Kill{
                                find_in: "drowning_units"
                                animate: true
                                fire_event: true
                            }

                            CLEAR_VARIABLE("drowning_units")
                    }

-- when water reaches escape passage, stop flooding and make it pour out
-- into the valley

                    event: {
                        name: "check_flood_end"

                        filter_condition: {
                            have_location: {
                                x: 12
                                y: 18
                                terrain: {"Ww*", "Wo*"}
                            }
                        }
                        do: ->
                            Remove_Event{
                                id: "do_flooding"
                            }

-- flood rest of side passage with deep water
                            Terrain{
                                x: {12, 12, 12, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 23, 24, 25, 25, 26}
                                y: {18, 17, 16, 15, 15, 15, 15, 14, 14, 14, 14, 13, 14, 13, 14, 15, 15, 16, 17, 17}
                                terrain: "Wo"
                            }

-- create shallow water stream in valley
                            Terrain{
                                x: {27, 28, 29, 30, 31, 32, 33, 34, 35, 35, 36, 37, 38, 39, 40, 41, 41, 42, 42, 42, 43, 43}
                                y: {18, 18, 18, 17, 18, 17, 17, 16, 16, 15, 14, 14, 14, 14, 14, 14, 15, 13, 14, 15, 13, 14}
                                terrain: "Ww"
                            }

                            Fire_Event{
                                name: "kill_submerged_units"
                            }

                            If{
                                have_unit: {
                                    x: {"21-25", "26-50"}
                                    y: {"18-33", "1-33"}
                                    side: 1
                                    not: {
                                        type: {"Dust Devil", "Flesh Golem"}
                                    }
                                }

                                then: ->
                                    Message{
                                        x: {"21-25", "26-50"}
                                        y: {"18-33", "1-33"}
                                        side: 1
                                        not: {
                                            type: {"Dust Devil", "Flesh Golem"}
                                        }
                                        message: _ "Look, the water is pouring out the side tunnel into the valley! Thatâ€™s a lot of water: itâ€™s even creating a small river. I sure wouldnâ€™t want to be downstream of that deluge right now."
                                    }
                                

                                else: ->
-- the player didn't see water when it flooded out into the valley
-- as soon as he does move a unit out into the valley, comment on it
                                    Event{
                                        name: "moveto"

                                        filter: {
                                            x: "26-50"
                                            y: "1-33"
                                            side: 1
                                            not: {
                                                type: {"Dust Devil", "Flesh Golem"}
                                            }
                                        }
                                        do: ->
                                            Allow_Undo{
                                            }

                                            Message{
                                                speaker: "unit"
                                                message: _ "Look, up there in the valley. The water has poured out of the side tunnel and created a small river and lake. Iâ€™m glad we werenâ€™t downstream of that deluge when the water came rushing out of the tunnel."
                                            }
                                    }
                                
                            }
                    }

--time over event

                    event: {
                        name: "time over"
                        do: ->
                            Message{
                                speaker: "Kaleh"
                                message: _ "I can see human reinforcements arriving on the horizon. Weâ€™ll surely be overwhelmed now! If only we had moved faster."
                            }
                    }

--victory event

                    event: {
                        name: "victory"

-- reveal map in-between starting valley and location elves move to
                        do: ->
                            Remove_Shroud{
                                x: "45-60"
                                y: "1-6"
                                side: 1
                            }

                            Teleport{
                                filter: {
                                    id: "Kaleh"
                                }
                                x: 61, y: 6
                            }

                            Teleport{
                                filter: {
                                    id: "Zhul"
                                }
                                x: 63, y: 5
                            }

                            Teleport{
                                filter: {
                                    id: ally_name
                                }
                                x: 60, y: 6
                            }

                            Store_Unit{
                                filter: {
                                    id: "Nym"
                                }
                                kill: true
                                variable: "Nymstats"
                            }

                            UNIT(1, "Desert Fighter", 66, 2, {id: "Dummy Unit1", upkeep: "free", generate_name: false})
                            UNIT(1, "Desert Fighter", 57, 3, {id: "Dummy Unit2", upkeep: "free", generate_name: false})
                            UNIT(1, "Desert Archer", 65, 3, {id: "Dummy Unit3", upkeep: "free", generate_name: false})
                            UNIT(1, "Desert Archer", 59, 2, {id: "Dummy Unit4", upkeep: "free", generate_name: false})
                            UNIT(1, "Desert Hunter", 58, 5, {id: "Dummy Unit5", upkeep: "free", generate_name: false})
                            UNIT(1, "Desert Shaman", 62, 2, {id: "Dummy Unit6", upkeep: "free", generate_name: false})

                            Scroll_To_Unit{
                                id: "Kaleh"
                            }

                            Delay{
                                time: 500
                            }

                            Message{
                                speaker: "narrator"
                                message: _ "Several hours pass..."
                                image: "wesnoth-icon.png"
                            }

                            Move_Unit_Fake{
                                type: Nymstats.type
                                side: 1
                                x: {51, 52, 53, 54, 55, 56, 57, 57, 58, 59, 60, 60}
                                y: {1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 3}
                            }

                            Set_Variable{
                                name: "Nymstats.hitpoints"
                                value: 12
                            }

                            Unstore_Unit{
                                variable: "Nymstats"
                                x: 60, y: 3
                            }

                            CLEAR_VARIABLE("Nymstats")

                            Message{
                                speaker: "Zhul"
                                message: _ "In Elohâ€™s name, Nym, you look terrible. Are you well?"
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "Yes. Just... let me... catch... my breath."
                            }

                            Delay{
                                time: 100
                            }

                            Move_Unit_Fake{
                                type: "Merman Netcaster"
                                side: 1
                                x: {51, 52, 53, 54, 55, 56, 57, 58, 59, 59, 60}
                                y: {1, 1, 1, 1, 2, 1, 2, 2, 3, 4, 4}
                            }

                            Unit{
                                type: "Merman Netcaster"
                                id: "Esanoo"
                                name: _ "Esanoo"
                                profile: "portraits/esanoo.png"
                                hitpoints: 10
                                x: 60
                                y: 4
                                side: 1
                                unrenamable: true
                                modifications: {
                                    <TRAIT_LOYAL!
                                    <TRAIT_RESILIENT!
                                }
                                <IS_LOYAL!
                            }

                            Delay{
                                time: 200
                            }

                            Message{
                                speaker: "Esanoo"
                                message: _ "Water. Sweet water. By the gods, I thought my scales would fall off."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "What in Uriaâ€™s name is that?"
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "Relax, heâ€™s a friend. Just let me explain."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "Youâ€™re really beat up, Nym. Are you sure youâ€™re fine?"
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "Iâ€™m fine. But I found someone who really wanted to speak with you."
                            }

                            Message{
                                speaker: ally_name
                                message: _ "He looks like a half-man half-fish."
                            }

                            Message{
                                speaker: "Esanoo"
                                message: _ "Indeed. I come from the ocean, and long have I been looking for you."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "The ocean? What are you talking about?"
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "Donâ€™t try to explain, Esanoo. Weâ€™ll have to show them instead."
                            }

                            Message{
                                speaker: "Esanoo"
                                message: _ "Itâ€™s not important. Whatâ€™s important is that I am an emissary from one who much desires to speak with you, Kaleh. Despite the danger, my master sent me and my brethren to scour the dry land searching for you."
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "There are more of you? Where are the others?"
                            }

                            Message{
                                speaker: "Esanoo"
                                message: _ "They have been captured by the foul humans. I just barely managed to hide and escape, with the help of your friend."
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "And why should we trust anything you say?"
                            }

                            Message{
                                speaker: "Esanoo"
                                message: _ "My master thought you might be suspicious. She said that what we must talk with you about concerns the fate of your people. Apparently it concerns â€˜Yechnagothâ€™ and â€˜Zhangorâ€™. She said that you would understand, Kaleh."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "Hmmmm... Yes, yes I think I do. I donâ€™t know why, but I trust you."
                            }

                            Message{
                                speaker: "Esanoo"
                                message: _ "Thank you. Now I have a boon to ask of you. Our instructions were to find you and to bring you and your people to meet with my master. The problem is that I donâ€™t know where she is hiding."
                            }

                            Message{
                                speaker: "Zhul"
                                message: _ "You donâ€™t know where to find your master?"
                            }

                            Message{
                                speaker: "Esanoo"
                                message: _ "Itâ€™s complicated, and I donâ€™t know how much I am allowed to tell you. My people are fighting a desperate war against... against a powerful foe. Many times our enemy has tried to assassinate my master. My master worried that her presence was a danger to the rest of my kind. So right after she sent us on our mission she went into hiding. I am the youngest member of our group, and so I wasnâ€™t told the location. You must understand, there are spies everywhere. Only the leaders of our group knew, but the rest of them were all captured by those foul humans. They are being held in the settlement to the north. If we are to have any chance of finding my master, we must first rescue them. I would do it myself, but..."
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "It would be suicide for you to try to rescue them alone. Of course we will help you."
                            }

                            Message{
                                speaker: "Esanoo"
                                message: _ "Thank you. I am not very good at fighting on the dry ground."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "All the other scouting parties have returned, except for one. Tanstafaal and his scouts havenâ€™t reported back yet. Iâ€™m starting to get worried."
                            }

                            Message{
                                speaker: "Nym"
                                message: _ "They were sent due north. From Esanooâ€™s description it sounds like they were headed right for the human settlement. I hope nothing bad has happened to them."
                            }

                            Message{
                                speaker: "Kaleh"
                                message: _ "Things are coming to a head. Iâ€™m worried about Tanstafaal and your merfolk friends. Time is of the essence, so letâ€™s move out as soon as possible."
                            }

                            Kill{
                                id: {"Dummy Unit1", "Dummy Unit2", "Dummy Unit3", "Dummy Unit4", "Dummy Unit5", "Dummy Unit6"}
                                animate: false
                            }

                            CLEAR_VARIABLE("healing_rune1,healing_rune2")

                            CLEAR_VARIABLE("messenger_timer")
                    }

-- set time for all underground areas to be always night/underground
                    time_area: {
                        x: {"0-1", "2-3", "4-19", "10-16", 12, 14, "20-21", 20, "20-22", "22-23", "23-24", 24, 25, "25-26", 26, 26, 27, 27, 27, 28, "28-36", "32-34", "37-42", 38, 40, "43-45", 46, 47, "48-49", 50, 51, "52-53", "54-55", 56, 57, 58, 59, 60, 61, "62-63", "64-65", "66-67", "68-69", "70-71", "72-73", "74-75", 76, 77}
                        y: {"9-54", "8-54", "7-54", 6, 5, 5, "7-22", 26, "27-54", "7-21", "28-54", "7-20", "8-20", "29-54", "8-10", "14-18", "9-10", "16-17", "30-54", 31, "32-54", 31, "33-56", 32, 32, "34-54", "33-54", "32-54", "31-54", "30-54", "29-54", "28-54", "26-54", "21-54", "19-54", "17-54", "15-54", "13-54", "12-54", "11-54", "10-54", "9-54", "8-54", "6-54", "5-54", "4-54", "2-54", "1-54"}
                        <UNDERGROUND!
                    }

                    <UTBS_INCLUDE("utils/deaths.cfg")
err: ../attic/data/campaigns/Under_the_Burning_Suns/scenarios_old/08_Out_of_the_Frying_Pan.cfg - ./wml_to_wsl/compile.moon:28: Unbalanced WML! macro: NAMED_UNIT closed by scenario at line 4537
